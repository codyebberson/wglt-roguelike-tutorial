var pt=Object.defineProperty;var Tt=(i,e,t)=>e in i?pt(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var O=(i,e,t)=>(Tt(i,typeof e!="symbol"?e+"":e,t),t);const xt=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function t(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerpolicy&&(o.referrerPolicy=n.referrerpolicy),n.crossorigin==="use-credentials"?o.credentials="include":n.crossorigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(n){if(n.ep)return;n.ep=!0;const o=t(n);fetch(n.href,o)}};xt();var F;(function(i){i[i.None=0]="None",i[i.Blend=1]="Blend",i[i.Add=2]="Add"})(F||(F={}));function q(i,e,t,s){var n=arguments.length,o=n<3?e:s===null?s=Object.getOwnPropertyDescriptor(e,t):s,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(i,e,t,s);else for(var h=i.length-1;h>=0;h--)(r=i[h])&&(o=(n<3?r(o):n>3?r(e,t,o):r(e,t))||o);return n>3&&o&&Object.defineProperty(e,t,o),o}function u(i,e,t,s){return s===void 0&&(s=255),(i<<24)+(e<<16)+(t<<8)+s}const y={BLACK:u(0,0,0),WHITE:u(255,255,255),LIGHT_GRAY:u(170,170,170),DARK_GRAY:u(85,85,85),YELLOW:u(255,255,85),BROWN:u(170,85,0),LIGHT_RED:u(255,85,85),DARK_RED:u(170,0,0),LIGHT_GREEN:u(85,255,85),DARK_GREEN:u(0,170,0),LIGHT_CYAN:u(85,255,255),DARK_CYAN:u(0,170,170),LIGHT_BLUE:u(85,85,255),DARK_BLUE:u(0,0,170),LIGHT_MAGENTA:u(255,85,255),DARK_MAGENTA:u(170,0,170),ORANGE:u(255,136,0)},He=new Map;function T(i){He.set(i.name,i)}function oe(i){const e=[],t=new WeakMap,s=n(i);return JSON.stringify({instances:e,root:s});function n(a){return Array.isArray(a)?o(a):a&&typeof a=="object"?r(a):a}function o(a){const c=[];for(let l=0;l<a.length;l++)c[l]=n(a[l]);return c}function r(a){if(a&&a.constructor.name&&a.constructor.name!=="Object"){if(!He.has(a.constructor.name))throw new Error(`Class ${a.constructor.name} is not serializable.`);if(t.has(a))return{$ref:t.get(a)};const c=e.length;return e.push({$type:a.constructor.name}),t.set(a,c),e[c]=Object.assign(Object.assign({},h(a)),{$type:a.constructor.name}),{$ref:c}}return h(a)}function h(a){const c={};for(const l of Object.keys(a))c[l]=n(a[l]);return c}}function he(i){const e=JSON.parse(i),t=e.instances;for(let h=0;h<t.length;h++){const a=t[h],c=He.get(a.$type);delete a.$type,t[h]=Object.create(c.prototype,Object.getOwnPropertyDescriptors(a))}for(let h=0;h<t.length;h++)r(t[h]);return s(e.root);function s(h){return Array.isArray(h)?n(h):h&&typeof h=="object"?o(h):h}function n(h){for(let a=0;a<h.length;a++)h[a]=s(h[a]);return h}function o(h){return Rt(h)?t[h.$ref]:(r(h),h)}function r(h){for(const[a,c]of Object.entries(h))h[a]=s(c)}}function Rt(i){return!!(i&&typeof i=="object"&&"$ref"in i)}function mt(i){return typeof i=="string"&&i.length>0?i.charCodeAt(0):i}let C=class{constructor(e,t,s,n,o){this.x=e,this.y=t,s!==void 0?this.charCode=mt(s):this.charCode=" ".charCodeAt(0),n!==void 0?this.fg=n:this.fg=y.WHITE,o!==void 0?this.bg=o:this.bg=y.BLACK,this.dirty=!0,this.blocked=!1,this.blockedSight=!1,this.explored=!1,this.visible=!1,this.pathId=-1,this.g=0,this.h=0,this.prev=null}setCharCode(e){this.charCode!==e&&(this.charCode=e,this.dirty=!0)}setForeground(e){e!=null&&e!==this.fg&&(this.fg=e,this.dirty=!0)}setBackground(e){e!=null&&e!==this.bg&&(this.bg=e,this.dirty=!0)}setValue(e,t,s){return typeof e=="string"&&(e=e.charCodeAt(0)),typeof e=="number"?(this.setCharCode(e),t!==void 0&&this.setForeground(t),s!==void 0&&this.setBackground(s)):this.drawCell(e,F.None),this.dirty}drawCell(e,t){const s=e.bg&255;t===F.None||e.charCode>0?(this.setCharCode(e.charCode),this.setForeground(e.fg)):s>0&&s<255&&this.setForeground(this.blendColors(this.fg,e.bg,t)),t===F.None||s===255?this.setBackground(e.bg):s>0&&this.setBackground(this.blendColors(this.bg,e.bg,t))}blendColors(e,t,s){const n=t&255,o=(255-n)/255,r=1-o,h=e>>24&255,a=e>>16&255,c=e>>8&255,l=t>>24&255,d=t>>16&255,_=t>>8&255;switch(s){case F.Blend:return u(o*h+r*l|0,o*a+r*d|0,o*c+r*_|0);case F.Add:return u(this.clamp(h+r*l|0),this.clamp(a+r*d|0),this.clamp(c+r*_|0));default:return t}}clamp(e){return Math.min(255,e)}};C=q([T],C);var D;(function(i){i[i.SMILEY=1]="SMILEY",i[i.INVERSE_SMILEY=2]="INVERSE_SMILEY",i[i.HEART=3]="HEART",i[i.DIAMOND=4]="DIAMOND",i[i.CLUB=5]="CLUB",i[i.SPADE=6]="SPADE",i[i.BULLET=7]="BULLET",i[i.INVERSE_BULLET=8]="INVERSE_BULLET",i[i.LIGHT_SHADE=176]="LIGHT_SHADE",i[i.MEDIUM_SHADE=177]="MEDIUM_SHADE",i[i.DARK_SHADE=178]="DARK_SHADE",i[i.BOX_SINGLE_VERTICAL=179]="BOX_SINGLE_VERTICAL",i[i.BOX_SINGLE_VERTICAL_AND_SINGLE_LEFT=180]="BOX_SINGLE_VERTICAL_AND_SINGLE_LEFT",i[i.BOX_DOUBLE_VERTICAL_AND_DOUBLE_LEFT=185]="BOX_DOUBLE_VERTICAL_AND_DOUBLE_LEFT",i[i.BOX_DOUBLE_VERTICAL=186]="BOX_DOUBLE_VERTICAL",i[i.BOX_DOUBLE_DOWN_AND_DOUBLE_LEFT=187]="BOX_DOUBLE_DOWN_AND_DOUBLE_LEFT",i[i.BOX_DOUBLE_UP_AND_DOUBLE_LEFT=188]="BOX_DOUBLE_UP_AND_DOUBLE_LEFT",i[i.BOX_SINGLE_DOWN_AND_SINGLE_LEFT=191]="BOX_SINGLE_DOWN_AND_SINGLE_LEFT",i[i.BOX_SINGLE_UP_AND_SINGLE_RIGHT=192]="BOX_SINGLE_UP_AND_SINGLE_RIGHT",i[i.BOX_SINGLE_HORIZONTAL_AND_SINGLE_UP=193]="BOX_SINGLE_HORIZONTAL_AND_SINGLE_UP",i[i.BOX_SINGLE_HORIZONTAL_AND_SINGLE_DOWN=194]="BOX_SINGLE_HORIZONTAL_AND_SINGLE_DOWN",i[i.BOX_SINGLE_VERTICAL_AND_SINGLE_RIGHT=195]="BOX_SINGLE_VERTICAL_AND_SINGLE_RIGHT",i[i.BOX_SINGLE_HORIZONTAL=196]="BOX_SINGLE_HORIZONTAL",i[i.BOX_SINGLE_VERTICAL_AND_SINGLE_HORIZONTAL=197]="BOX_SINGLE_VERTICAL_AND_SINGLE_HORIZONTAL",i[i.BOX_DOUBLE_UP_AND_DOUBLE_RIGHT=200]="BOX_DOUBLE_UP_AND_DOUBLE_RIGHT",i[i.BOX_DOUBLE_DOWN_AND_DOUBLE_RIGHT=201]="BOX_DOUBLE_DOWN_AND_DOUBLE_RIGHT",i[i.BOX_DOUBLE_HORIZONTAL_AND_DOUBLE_UP=202]="BOX_DOUBLE_HORIZONTAL_AND_DOUBLE_UP",i[i.BOX_DOUBLE_HORIZONTAL_AND_DOUBLE_DOWN=203]="BOX_DOUBLE_HORIZONTAL_AND_DOUBLE_DOWN",i[i.BOX_DOUBLE_VERTICAL_AND_DOUBLE_RIGHT=204]="BOX_DOUBLE_VERTICAL_AND_DOUBLE_RIGHT",i[i.BOX_DOUBLE_HORIZONTAL=205]="BOX_DOUBLE_HORIZONTAL",i[i.BOX_DOUBLE_VERTICAL_AND_DOUBLE_HORIZONTAL=206]="BOX_DOUBLE_VERTICAL_AND_DOUBLE_HORIZONTAL",i[i.BOX_SINGLE_UP_AND_SINGLE_LEFT=217]="BOX_SINGLE_UP_AND_SINGLE_LEFT",i[i.BOX_SINGLE_DOWN_AND_SINGLE_RIGHT=218]="BOX_SINGLE_DOWN_AND_SINGLE_RIGHT",i[i.BLOCK_FULL=219]="BLOCK_FULL",i[i.BLOCK_BOTTOM_HALF=220]="BLOCK_BOTTOM_HALF",i[i.BLOCK_LEFT_HALF=221]="BLOCK_LEFT_HALF",i[i.BLOCK_RIGHT_HALF=222]="BLOCK_RIGHT_HALF",i[i.BLOCK_TOP_HALF=223]="BLOCK_TOP_HALF"})(D||(D={}));function tt(i,e){const t=new RegExp("(\\S(.{0,"+e+"}\\S)?)\\s+","g");return(i+" ").replace(t,`$1
`).trim().split(`
`).map(s=>s.trim())}function Ce(i){return i&&i.charAt(0).toUpperCase()+i.slice(1)}let ae=class{constructor(e,t,s){this.width=e,this.height=t,this.grid=[],this.originX=0,this.originY=0,this.minX=0,this.maxX=0,this.minY=0,this.maxY=0,this.radius=0;for(let n=0;n<t;n++){const o=[];for(let r=0;r<e;r++)o.push(new C(r,n));this.grid.push(o)}if(this.clear(),s)for(let n=0;n<t;n++)for(let o=0;o<e;o++)this.grid[n][o].blocked=this.grid[n][o].blockedSight=s(o,n)}clear(){for(let e=0;e<this.height;e++)for(let t=0;t<this.width;t++)this.drawChar(t,e,0)}getCell(e,t){if(!(e<0||t<0||e>=this.width||t>=this.height))return this.grid[t][e]}getCharCode(e,t){if(!(e<0||t<0||e>=this.width||t>=this.height))return this.grid[t][e].charCode}drawChar(e,t,s,n,o){this.clip&&!this.clip.contains({x:e,y:t})||e>=0&&e<this.width&&t>=0&&t<this.height&&this.grid[t|0][e|0].setValue(s,n,o)}drawString(e,t,s,n,o){const r=s.split(`
`);for(let h=0;h<r.length;h++)this.drawStringLine(e,t+h,r[h],n,o)}drawStringLine(e,t,s,n,o){for(let r=0;r<s.length;r++)this.drawChar(e+r,t,s.charCodeAt(r),n,o)}drawCenteredString(e,t,s,n,o){this.drawString(e-Math.floor(s.length/2),t,s,n,o)}drawMessage(e,t,s,n){if(s.text){const o=tt(s.text,n||this.width-e);for(const r of o)this.drawStringLine(e,t,r,s.fg,s.bg),t++}if(s.children)for(const o of s.children)t=this.drawMessage(e,t,o,n);return t}drawHLine(e,t,s,n,o,r){for(let h=e;h<e+s;h++)this.drawChar(h,t,n,o,r)}drawVLine(e,t,s,n,o,r){for(let h=t;h<t+s;h++)this.drawChar(e,h,n,o,r)}drawRect(e,t,s,n,o,r,h){this.drawHLine(e,t,s,o,r,h),this.drawHLine(e,t+n-1,s,o,r,h),this.drawVLine(e,t,n,o,r,h),this.drawVLine(e+s-1,t,n,o,r,h)}drawBox(e,t,s,n,o,r,h,a,c,l,d,_,g,m){this.drawHLine(e,t,s,o,g,m),this.drawHLine(e,t+n-1,s,h,g,m),this.drawVLine(e,t,n,a,g,m),this.drawVLine(e+s-1,t,n,r,g,m),this.drawChar(e,t,c,g,m),this.drawChar(e+s-1,t,l,g,m),this.drawChar(e,t+n-1,_,g,m),this.drawChar(e+s-1,t+n-1,d,g,m)}drawSingleBox(e,t,s,n,o,r){this.drawBox(e,t,s,n,D.BOX_SINGLE_HORIZONTAL,D.BOX_SINGLE_VERTICAL,D.BOX_SINGLE_HORIZONTAL,D.BOX_SINGLE_VERTICAL,D.BOX_SINGLE_DOWN_AND_SINGLE_RIGHT,D.BOX_SINGLE_DOWN_AND_SINGLE_LEFT,D.BOX_SINGLE_UP_AND_SINGLE_LEFT,D.BOX_SINGLE_UP_AND_SINGLE_RIGHT,o,r)}drawDoubleBox(e,t,s,n,o,r){this.drawBox(e,t,s,n,D.BOX_DOUBLE_HORIZONTAL,D.BOX_DOUBLE_VERTICAL,D.BOX_DOUBLE_HORIZONTAL,D.BOX_DOUBLE_VERTICAL,D.BOX_DOUBLE_DOWN_AND_DOUBLE_RIGHT,D.BOX_DOUBLE_DOWN_AND_DOUBLE_LEFT,D.BOX_DOUBLE_UP_AND_DOUBLE_LEFT,D.BOX_DOUBLE_UP_AND_DOUBLE_RIGHT,o,r)}fillRect(e,t,s,n,o,r,h){for(let a=t;a<t+n;a++)this.drawHLine(e,a,s,o,r,h)}drawConsole(e,t,s,n,o,r,h,a){a=a||F.None;for(let c=0;c<h;c++)for(let l=0;l<r;l++){const d=s.getCell(n+l,o+c);d&&this.drawCell(e+l,t+c,d,a)}}drawCell(e,t,s,n){e>=0&&e<this.width&&t>=0&&t<this.height&&this.grid[t][e].drawCell(s,n)}setBlocked(e,t,s){e>=0&&e<this.width&&t>=0&&t<this.height&&(this.grid[t][e].blocked=s)}setBlockedSight(e,t,s){e>=0&&e<this.width&&t>=0&&t<this.height&&(this.grid[t][e].blockedSight=s)}isVisible(e,t){return e<this.minX||e>this.maxX||t<this.minY||t>this.maxY?!1:this.grid[t][e].visible}isBlocked(e,t){return e<0||e>this.width||t<0||t>this.height?!0:this.grid[t][e].blocked}isBlockedSight(e,t){return e<0||e>this.width||t<0||t>this.height?!0:this.grid[t][e].blockedSight}computeOctantY(e,t){const s=[],n=[];let o=1,r=0,h=0,a=0,c,l,d,_,g,m,I,x,R,L;for(l=this.originY+t;l>=this.minY&&l<=this.maxY;l+=t,h=r,++o)for(d=.5/o,L=-1,_=Math.floor(a*o+.5),c=this.originX+_*e;_<=o&&c>=this.minX&&c<=this.maxX;c+=e,++_,L=R){if(g=!0,m=!1,I=_/o,x=L,R=I+d,h>0){if(!(this.grid[l-t][c].visible&&!this.grid[l-t][c].blockedSight)&&!(this.grid[l-t][c-e].visible&&!this.grid[l-t][c-e].blockedSight))g=!1;else for(let p=0;p<h&&g;++p)if(x<=n[p]&&R>=s[p]){if(this.grid[l][c].blockedSight)if(x>=s[p]&&R<=n[p]){g=!1;break}else s[p]=Math.min(s[p],x),n[p]=Math.max(n[p],R),m=!0;else if(I>s[p]&&I<n[p]){g=!1;break}}}g&&(this.grid[l][c].visible=!0,this.grid[l][c].blockedSight&&(a>=x?a=R:m||(s[r]=x,n[r++]=R)))}}computeOctantX(e,t){const s=[],n=[];let o=1,r=0,h=0,a=0,c,l,d,_,g,m,I,x,R,L;for(c=this.originX+e;c>=this.minX&&c<=this.maxX;c+=e,h=r,++o)for(d=.5/o,L=-1,_=Math.floor(a*o+.5),l=this.originY+_*t;_<=o&&l>=this.minY&&l<=this.maxY;l+=t,++_,L=R){if(g=!0,m=!1,I=_/o,x=L,R=I+d,h>0){if(!(this.grid[l][c-e].visible&&!this.grid[l][c-e].blockedSight)&&!(this.grid[l-t][c-e].visible&&!this.grid[l-t][c-e].blockedSight))g=!1;else for(let p=0;p<h&&g;++p)if(x<=n[p]&&R>=s[p]){if(this.grid[l][c].blockedSight)if(x>=s[p]&&R<=n[p]){g=!1;break}else s[p]=Math.min(s[p],x),n[p]=Math.max(n[p],R),m=!0;else if(I>s[p]&&I<n[p]){g=!1;break}}}g&&(this.grid[l][c].visible=!0,this.grid[l][c].blockedSight&&(a>=x?a=R:m||(s[r]=x,n[r++]=R)))}}computeFov(e,t,s,n,o){if(this.originX=e,this.originY=t,this.radius=s,n)this.minX=Math.min(this.minX,Math.max(0,e-s)),this.minY=Math.min(this.minY,Math.max(0,t-s)),this.maxX=Math.max(this.maxX,Math.min(this.width-1,e+s)),this.maxY=Math.max(this.maxY,Math.min(this.height-1,t+s));else{this.minX=Math.max(0,e-s),this.minY=Math.max(0,t-s),this.maxX=Math.min(this.width-1,e+s),this.maxY=Math.min(this.height-1,t+s);for(let r=this.minY;r<=this.maxY;r++)for(let h=this.minX;h<=this.maxX;h++)this.grid[r][h].visible=!1}this.grid[t][e].visible=!0,o===void 0?(this.computeOctantY(1,1),this.computeOctantX(1,1),this.computeOctantX(1,-1),this.computeOctantY(1,-1),this.computeOctantY(-1,-1),this.computeOctantX(-1,-1),this.computeOctantX(-1,1),this.computeOctantY(-1,1)):(o&1&&this.computeOctantY(1,1),o&2&&this.computeOctantX(1,1),o&4&&this.computeOctantX(1,-1),o&8&&this.computeOctantY(1,-1),o&16&&this.computeOctantY(-1,-1),o&32&&this.computeOctantX(-1,-1),o&64&&this.computeOctantX(-1,1),o&128&&this.computeOctantY(-1,1))}updateExplored(){for(let e=this.minY;e<=this.maxY;e++)for(let t=this.minX;t<=this.maxX;t++){const s=this.grid[e][t];s.explored=s.explored||s.visible}}};ae=q([T],ae);class Lt{constructor(e,t,s,n){this.url=e,this.charWidth=t,this.charHeight=s,this.scale=n||1}}const Ot="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACAAQMAAAD58POIAAAABlBMVEUAAAD///+l2Z/dAAAEhklEQVRIx42Sv4oUQRDGC4UzadSwwMUD8QEKlbWD4Q58B/NGpTVocKO1wXHUzMAH0AcwMTYVGg5ag0IzEXaRjdZEZKNzkKbHqtnzHypY09M9+5uvqr7pbYCuC6ftaRhgONXs30eAh0O1rYDm4IS/eH0B8GxRW2vxo396yu/fb0ZFrW1zcOXlPU/XPwK8PGjbWhVwM4KnH61912oK4+zmmHJaQotyt1kvtC2Atdo24iohPDiG/v4eICJsY3Wy8Yvr0DSIBOdxgH6v8wsriWhc8s0AtaK/GzSl1jR0nSjQnwki6FQxNFKjgzO2a7BBqucH7dL4M9z96CIhT1Fs/AgKgcA6dKCxI29DaHNwRJ4EGAU1sU0OG9rmE4SIc3A4FChACqqhJRwpxkqh9wxag4DSmEJ5DtpFwAP4GUf6lmKcFFti1BYuQp4xN8kxM2kNhjdkTOiTUeAKGvhA1rLpMbYACQzCITlTDRMbLYoEa2JWPSMRFZIupcSzMVKcEUkX+sOG+ChNX2vD8ex6k7OFHL0P1655JuPd53WAD+yTv3UrCQiuHmYBbfIxpkImuvpBQBkVb5g4XHv3JkNireG8AO9zDhBZu2z2OMZ11S5/RIlyMefMNaZ4GsCz5xcjyM6hHYEjAYEfO8Ig1rklAe9sRIeYAdwyoIBq6YIzCAKiWoifA3m3o2AzWcdYKOdY47EIf8QABCuYgIUVmdVMEYEDA0Hmo/3D6KKJbh5mxhP3UsWIE97wnEygyizOfOLi2JOJW8CeOblW9IHeKZgv4zxuzDryOmb+4aQH+MXV6e0ywdUcxqCjBWl5GpbzZduOG1QEiGXP86T7EfiJfkMQ4OO4H0yqyNC2zlziWEN7Ywuc2fQ4p5BNkS5QYXP2h5NtRJh0vCKQidtVJmCGAwDSSQpYggSxiRIyzewsgCh4xxiTPDMh5aj//l7btqkr6rQyIOtLji4lVRQwXdzvus40Y53M33fh50GZwF4ExQeMlvuTggLzSi4ElKczUO7zVtpwdyMKdqZKOWb2nDblawPxPmuMwFEWBW+jlZR1eYtS442kiBGMWCi/h1/+GAR6NYOJWiqNJXFygFtrkx5C0O3IeFGs67HhEEhmBu/BUOT+0551pXxYIF+Elpi5AKRkLl5GUbCCZddyMv621ujEBPP4vSy2fotTx3U+d3WBiFOA6VSGSB49v/M7GBX9FPrDaT2c9qr4PCpwZ7qz813R94dVFIe19v33GlMZUghQFb8BrfE7QBmgBMbrn2B3enn/y3B5+DL8UBAdnejdYdBxeV9ejwoYNTgW0Ok/gA7UG2GAzanhL0DG7q4svynwF8UwDPu7u/vD0IudzSltMtVbP+J/gUbR29oJ7Fg9s6Uy+DnpiTCOYc4cXOeXMWfsusSw7FOg9x655nax6BlecwpOQQ68WBwp+H2LMQTuOq2RUigzh2Q/R3CWARJIJG199EwOTyKBlQMznshCRGeQ5gHABAQl6M4gLEdAzVaBWMCiANdsayDCHBA/hagKYfielrJIlipKKQIA9Nf3wBloTHT6BuAx15zRNa1nAAAAAElFTkSuQmCC",it=new Lt(Ot,8,8);var We;(function(i){i[i.OCTANT_SOUTH_SOUTHEAST=1]="OCTANT_SOUTH_SOUTHEAST",i[i.OCTANT_EAST_SOUTHEAST=2]="OCTANT_EAST_SOUTHEAST",i[i.OCTANT_EAST_NORTHTHEAST=4]="OCTANT_EAST_NORTHTHEAST",i[i.OCTANT_NORTH_NORTHEAST=8]="OCTANT_NORTH_NORTHEAST",i[i.OCTANT_NORTH_NORTHWEST=16]="OCTANT_NORTH_NORTHWEST",i[i.OCTANT_WEST_NORTHEAST=32]="OCTANT_WEST_NORTHEAST",i[i.OCTANT_WEST_SOUTHWEST=64]="OCTANT_WEST_SOUTHWEST",i[i.OCTANT_SOUTH_SOUTHWEST=128]="OCTANT_SOUTH_SOUTHWEST"})(We||(We={}));var ke;(function(i){i[i.QUADRANT_SOUTHEAST=3]="QUADRANT_SOUTHEAST",i[i.QUADRANT_EAST=6]="QUADRANT_EAST",i[i.QUADRANT_NORTHEAST=12]="QUADRANT_NORTHEAST",i[i.QUADRANT_NORTH=24]="QUADRANT_NORTH",i[i.QUADRANT_NORTHWEST=48]="QUADRANT_NORTHWEST",i[i.QUADRANT_WEST=96]="QUADRANT_WEST",i[i.QUADRANT_SOUTHWEST=192]="QUADRANT_SOUTHWEST",i[i.QUADRANT_SOUTH=129]="QUADRANT_SOUTH"})(ke||(ke={}));let v=class{constructor(e,t){this.x=e,this.y=t}};v=q([T],v);let H=class{constructor(e,t,s,n){this.x=this.left=e,this.y=this.top=t,this.width=s,this.height=n,this.x2=e+s,this.y2=t+n}getCenter(){return new v(this.x+this.width/2|0,this.y+this.height/2|0)}intersects(e){return this.x<=e.x2&&this.x2>=e.x&&this.y<=e.y2&&this.y2>=e.y}contains(e){return e.x>=this.x&&e.x<this.x2&&e.y>=this.y&&e.y<this.y2}};H=q([T],H);class Dt{constructor(e,t,s){this.dialog=e,this.rect=t,this.contentsOffset=s,this.open=!1,this.count=0}}class wt{getState(e,t){const s=t.contentsRect.width+4,n=t.contentsRect.height+4,o=(e.width-s)/2|0,r=(e.height-n)/2|0;return new Dt(t,new H(o,r,s,n),new v(o+2,r+2))}draw(e,t){const s=t.dialog,{x:n,y:o,width:r,height:h}=t.rect;e.fillRect(n,o,r,h,0,y.WHITE,y.BLACK),e.drawSingleBox(n,o,r,h),e.drawCenteredString(n+r/2|0,o," "+s.title+" "),s.drawContents(e,t.contentsOffset)}}class Nt{constructor(e,t){this.terminal=e,this.renderer=t||new wt,this.dialogs=[]}add(e){this.dialogs.push(this.renderer.getState(this.terminal,e))}handleInput(){if(this.dialogs.length===0)return!1;const e=this.dialogs.length-1,t=this.dialogs[this.dialogs.length-1];return t.dialog.handleInput(this.terminal,t.contentsOffset)&&this.dialogs.splice(e,1),!0}draw(){for(let e=0;e<this.dialogs.length;e++)this.renderer.draw(this.terminal,this.dialogs[e])}}class Ve{constructor(e,t){this.contentsRect=e,this.title=t}}let B=class{constructor(e,t,s,n){this.text=e,this.fg=t,this.bg=s,this.children=n}getWidth(){let e=0;if(this.text)for(const t of this.text.split(`
`))e=Math.max(e,t.length);if(this.children)for(const t of this.children)e=Math.max(e,t.getWidth());return e}getHeight(){let e=0;if(this.text&&(e+=this.text.split(`
`).length),this.children)for(const t of this.children)e+=t.getHeight();return e}};B=q([T],B);const vt=200,It=1e3/15;class St{constructor(){this.down=!1,this.downTime=0,this.repeat=!1,this.repeatTime=0,this.downCount=0,this.upCount=100}setDown(e){this.down!==e&&(this.down=e,this.repeat=!1,this.downTime=this.repeatTime=performance.now())}update(e){this.repeat=!1,this.down?(this.downCount++,this.upCount=0,e-this.downTime>=vt&&e-this.repeatTime>=It&&(this.repeat=!0,this.repeatTime=e)):(this.downCount=0,this.upCount++)}isPressed(){return this.downCount===1||this.repeat}isClicked(){return this.upCount===1}}class st{constructor(){this.inputs=new Map}clear(){this.inputs.clear()}get(e){let t=this.inputs.get(e);return t||(t=new St,this.inputs.set(e,t)),t}updateAll(e){this.inputs.forEach(t=>t.update(e))}}class Bt{constructor(e){this.keys=new st,e.addEventListener("keydown",t=>this.setKey(t,!0)),e.addEventListener("keyup",t=>this.setKey(t,!1))}clear(){this.keys.clear()}getKey(e){return this.keys.get(e)}setKey(e,t){const s=e.code;s!==f.VK_F11&&(e.stopPropagation(),e.preventDefault(),this.keys.get(s).setDown(t))}updateKeys(e){this.keys.updateAll(e)}}var f;(function(i){i.VK_CANCEL="Pause",i.VK_BACKSPACE="Backspace",i.VK_TAB="Tab",i.VK_ENTER="Enter",i.VK_SHIFT_LEFT="ShiftLeft",i.VK_SHIFT_RIGHT="ShiftLeft",i.VK_CONTROL_LEFT="ControlLeft",i.VK_CONTROL_RIGHT="ControlRight",i.VK_ALT_LEFT="AltLeft",i.VK_ALT_RIGHT="AltRight",i.VK_PAUSE="Pause",i.VK_CAPS_LOCK="CapsLock",i.VK_ESCAPE="Escape",i.VK_SPACE="Space",i.VK_PAGE_UP="PageUp",i.VK_PAGE_DOWN="PageDown",i.VK_END="End",i.VK_HOME="Home",i.VK_LEFT="ArrowLeft",i.VK_UP="ArrowUp",i.VK_RIGHT="ArrowRight",i.VK_DOWN="ArrowDown",i.VK_INSERT="Insert",i.VK_DELETE="Delete",i.VK_0="Digit0",i.VK_1="Digit1",i.VK_2="Digit2",i.VK_3="Digit3",i.VK_4="Digit4",i.VK_5="Digit5",i.VK_6="Digit6",i.VK_7="Digit7",i.VK_8="Digit8",i.VK_9="Digit9",i.VK_SEMICOLON="Semicolon",i.VK_EQUALS="Equal",i.VK_A="KeyA",i.VK_B="KeyB",i.VK_C="KeyC",i.VK_D="KeyD",i.VK_E="KeyE",i.VK_F="KeyF",i.VK_G="KeyG",i.VK_H="KeyH",i.VK_I="KeyI",i.VK_J="KeyJ",i.VK_K="KeyK",i.VK_L="KeyL",i.VK_M="KeyM",i.VK_N="KeyN",i.VK_O="KeyO",i.VK_P="KeyP",i.VK_Q="KeyQ",i.VK_R="KeyR",i.VK_S="KeyS",i.VK_T="KeyT",i.VK_U="KeyU",i.VK_V="KeyV",i.VK_W="KeyW",i.VK_X="KeyX",i.VK_Y="KeyY",i.VK_Z="KeyZ",i.VK_CONTEXT_MENU="ContextMenu",i.VK_NUMPAD0="Numpad0",i.VK_NUMPAD1="Numpad1",i.VK_NUMPAD2="Numpad2",i.VK_NUMPAD3="Numpad3",i.VK_NUMPAD4="Numpad4",i.VK_NUMPAD5="Numpad5",i.VK_NUMPAD6="Numpad6",i.VK_NUMPAD7="Numpad7",i.VK_NUMPAD8="Numpad8",i.VK_NUMPAD9="Numpad9",i.VK_NUMPAD_ENTER="NumpadEnter",i.VK_MULTIPLY="NumpadMultiply",i.VK_ADD="NumpadAdd",i.VK_SEPARATOR="NumpadDecimal",i.VK_SUBTRACT="NumpadSubtract",i.VK_DECIMAL="NumpadDecimal",i.VK_DIVIDE="NumpadDivide",i.VK_F1="F1",i.VK_F2="F2",i.VK_F3="F3",i.VK_F4="F4",i.VK_F5="F5",i.VK_F6="F6",i.VK_F7="F7",i.VK_F8="F8",i.VK_F9="F9",i.VK_F10="F10",i.VK_F11="F11",i.VK_F12="F12",i.VK_F13="F13",i.VK_F14="F14",i.VK_F15="F15",i.VK_F16="F16",i.VK_F17="F17",i.VK_F18="F18",i.VK_F19="F19",i.VK_F20="F20",i.VK_F21="F21",i.VK_F22="F22",i.VK_F23="F23",i.VK_F24="F24",i.VK_NUM_LOCK="NumLock",i.VK_SCROLL_LOCK="ScrollLock",i.VK_COMMA="Comma",i.VK_PERIOD="Period",i.VK_SLASH="Slash",i.VK_BACKQUOTE="Backquote",i.VK_OPEN_BRACKET="BracketLeft",i.VK_BACK_SLASH="Backslash",i.VK_CLOSE_BRACKET="BracketRight",i.VK_QUOTE="Quote",i.VK_META="OSLeft"})(f||(f={}));class nt extends Ve{constructor(e,t){let s;t instanceof B?s=new H(0,0,t.getWidth(),t.getHeight()):s=new H(0,0,t.length,1),super(s,e),this.message=t}drawContents(e,t){this.message instanceof B?e.drawMessage(t.x,t.y,this.message):e.drawString(t.x,t.y,this.message)}handleInput(e){return e.isKeyPressed(f.VK_ESCAPE)}}class Pt extends Ve{constructor(e,t,s){super(e,t),this.message=s,this.scrollY=0,this.messagesHeight=s.getHeight(),this.scrollMax=Math.max(1,this.messagesHeight-this.contentsRect.height),this.scrollbarHeight=this.contentsRect.height*this.contentsRect.height/(this.messagesHeight+1)}drawContents(e,t){e.clip=this.contentsRect,e.drawMessage(t.x,t.y-this.scrollY,this.message),e.clip=void 0;const s=this.scrollY/this.scrollMax*(this.contentsRect.height-this.scrollbarHeight);e.drawVLine(this.contentsRect.x+this.contentsRect.width+1,this.contentsRect.y+s,this.scrollbarHeight,D.MEDIUM_SHADE)}handleInput(e){const t=e.getMovementKey();return t&&(this.scrollY+=t.y),e.isKeyPressed(f.VK_PAGE_DOWN)&&(this.scrollY+=this.contentsRect.height),e.isKeyPressed(f.VK_PAGE_UP)&&(this.scrollY-=this.contentsRect.height),e.mouse.wheelDeltaY!==0&&(this.scrollY+=e.mouse.wheelDeltaY<0?-5:5,e.mouse.wheelDeltaY=0),this.scrollY=Math.max(0,Math.min(this.scrollMax,this.scrollY)),e.isKeyPressed(f.VK_ESCAPE)}}class fe extends Ve{constructor(e,t,s){let n=e.length;for(let h=0;h<t.length;h++)n=Math.max(n,t[h].length+4);const o=t.length,r=new H(0,0,n,o);super(r,e),this.options=t,this.callback=s,this.hoverIndex=-1}drawContents(e,t){for(let s=0;s<this.options.length;s++){const n=String.fromCharCode(65+s)+" - "+this.options[s];s===this.hoverIndex?e.drawString(t.x,t.y+s,n,y.BLACK,y.WHITE):e.drawString(t.x,t.y+s,n,y.WHITE,y.BLACK)}}handleInput(e,t){const s=e.getMovementKey();if(s&&s.y!==0&&(this.hoverIndex=(this.hoverIndex+this.options.length+s.y)%this.options.length),this.hoverIndex>=0&&(e.isKeyPressed(f.VK_ENTER)||e.isKeyPressed(f.VK_NUMPAD_ENTER)))return this.callback(this.hoverIndex),!0;if(e.mouse.x>=t.x&&e.mouse.x<t.x+this.contentsRect.width&&e.mouse.y>=t.y&&e.mouse.y<t.y+this.contentsRect.height&&(this.hoverIndex=e.mouse.y-t.y,e.mouse.buttons.get(0).isClicked()))return e.mouse.buttons.clear(),this.callback(this.hoverIndex),!0;const n="A".charCodeAt(0);for(let o=0;o<this.options.length;o++)if(e.isKeyPressed("Key"+String.fromCharCode(n+o)))return this.callback(o),!0;return e.isKeyPressed(f.VK_ESCAPE)}isMouseOverOption(e,t,s){return e.mouse.x>=t.x&&e.mouse.x<t.x+this.contentsRect.width&&e.mouse.y===t.y+s}}D.BLOCK_TOP_HALF,D.BLOCK_RIGHT_HALF;class yt{constructor(e){this.buttons=new st,this.el=e.canvas,this.width=e.width,this.height=e.height,this.prevX=0,this.prevY=0,this.x=0,this.y=0,this.dx=0,this.dy=0,this.wheelDeltaX=0,this.wheelDeltaY=0;const t=this.el;t.addEventListener("mousedown",s=>this.handleEvent(s)),t.addEventListener("mouseup",s=>this.handleEvent(s)),t.addEventListener("mousemove",s=>this.handleEvent(s)),t.addEventListener("contextmenu",s=>this.handleEvent(s)),t.addEventListener("touchstart",s=>this.handleTouchEvent(s)),t.addEventListener("touchend",s=>this.handleTouchEvent(s)),t.addEventListener("touchcancel",s=>this.handleTouchEvent(s)),t.addEventListener("touchmove",s=>this.handleTouchEvent(s)),t.addEventListener("wheel",s=>this.handleWheelEvent(s))}handleTouchEvent(e){if(e.stopPropagation(),e.preventDefault(),e.touches.length>0){const t=e.touches[0];this.updatePosition(t.clientX,t.clientY),this.buttons.get(0).setDown(!0)}else this.buttons.get(0).setDown(!1)}handleEvent(e){e.stopPropagation(),e.preventDefault(),this.updatePosition(e.clientX,e.clientY),e.type==="mousedown"&&(this.buttons.get(e.button).setDown(!0),this.el.focus()),e.type==="mouseup"&&this.buttons.get(e.button).setDown(!1)}handleWheelEvent(e){e.stopPropagation(),e.preventDefault(),this.wheelDeltaX=e.deltaX,this.wheelDeltaY=e.deltaY}updatePosition(e,t){let s=this.el.getBoundingClientRect();const n=this.width/this.height,o=s.width/s.height;if(o-n>.01){const r=n*s.height,h=s.width-r;s=new H(Math.floor(h/2),0,r,s.height)}if(o-n<-.01){const r=s.width/n,h=s.height-r;s=new H(0,Math.floor(h/2),s.width,r)}this.x=this.width*(e-s.left)/s.width|0,this.y=this.height*(t-s.top)/s.height|0}update(e){this.dx=this.x-this.prevX,this.dy=this.y-this.prevY,this.prevX=this.x,this.prevY=this.y,this.buttons.updateAll(e)}}u(0,0,0),u(255,255,255),u(136,0,0),u(170,255,238),u(204,68,204),u(0,204,85),u(0,0,170),u(238,238,119),u(221,136,85),u(102,68,0),u(255,119,119),u(51,51,51),u(119,119,119),u(170,255,102),u(0,136,255),u(187,187,187);const A={BLACK:u(0,0,0),WHITE:u(255,255,255),RED:u(136,0,0),CYAN:u(170,255,238),VIOLET:u(204,68,204),GREEN:u(0,204,85),BLUE:u(0,0,170),YELLOW:u(238,238,119),ORANGE:u(221,136,85),BROWN:u(102,68,0),LIGHT_RED:u(255,119,119),DARK_GRAY:u(51,51,51),GRAY:u(119,119,119),LIGHT_GREEN:u(170,255,102),LIGHT_BLUE:u(0,136,255),LIGHT_GRAY:u(187,187,187)};u(0,0,0),u(29,43,83),u(126,37,83),u(0,135,81),u(171,82,54),u(95,87,79),u(194,195,199),u(255,241,232),u(255,0,77),u(255,163,0),u(255,236,39),u(0,228,54),u(41,173,255),u(131,118,156),u(255,119,168),u(255,204,170);const ze=[-1,0,1,-1,1,-1,0,1],Ut=[-1,-1,-1,0,0,1,1,1],bt=[1.4,1,1.4,1,1,1.4,1,1.4];let ie=0;function Mt(i,e,t,s){ie++;const n=i.grid[e.y][e.x];n.pathId=ie,n.g=0,n.h=Math.hypot(e.x-t.x,e.y-t.y),n.prev=null;const o=new Ct([n]);for(;o.size()>0;){const r=o.pop();if(r.x===t.x&&r.y===t.y)return Ht(r);for(let h=0;h<ze.length;h++){const a=r.x+ze[h],c=r.y+Ut[h];if(a>=0&&a<i.width&&c>=0&&c<i.height){const l=i.grid[c][a];if(l.blocked&&l.explored&&(a!==t.x||c!==t.y))continue;l.pathId!==ie&&(l.pathId=ie,l.g=1/0,l.h=Math.hypot(a-t.x,c-t.y),l.prev=null);const d=r.g+bt[h];d<l.g&&d<=s&&(l.g=d,l.prev=r,o.insert(l))}}}}function Ht(i){const e=[];let t=i;for(;t;)e.push(t),t=t.prev;return e.reverse(),e}class Ct{constructor(e){this.values=e}insert(e){const t=this.values;let s=0,n=t.length,o=0;for(;s<n;){const r=s+n>>>1,h=t[r];h.g+h.h>e.g+e.h?(s=r+1,o=s):(n=r,o=n)}t.splice(o,0,e)}pop(){return this.values.pop()}size(){return this.values.length}}let Le=class{constructor(e){this.m=2147483648,this.a=1103515245,this.c=12345,this.state=e||1}nextInt(){return this.state=(this.a*this.state+this.c)%this.m,this.state}nextFloat(){return this.nextInt()/(this.m-1)}nextRange(e,t){const s=t-e,n=this.nextInt()/this.m,o=e+(n*s|0);if(isNaN(o))throw new Error("rand nan");return o}chooseIndex(e){const t=e.reduce((o,r)=>o+r),s=this.nextRange(1,t+1);let n=0;for(let o=0;o<e.length;o++)if(n+=e[o],s<=n)return o;return e.length-1}chooseKey(e){const t=Object.keys(e),s=t.map(n=>e[n]);return t[this.chooseIndex(s)]}};Le=q([T],Le);const Vt=`#version 300 es
precision highp float;in vec2 a;in vec2 b;in vec3 c;in vec3 d;out vec2 e;out vec4 f;out vec4 g;void main(void){gl_Position=vec4(a.x,a.y,0,1);e=b/16.0;f=vec4(c.r,c.g,c.b,1);g=vec4(d.r,d.g,d.b,1);}`,Kt=`#version 300 es
precision highp float;in vec2 e;in vec4 f;in vec4 g;uniform sampler2D s;out vec4 o;void main(void){o=texture(s,e);if(o.r<0.1) {o=g;} else {o=f;}}`,Gt=`#version 300 es
precision highp float;
in vec2 a_position;
in vec2 a_texCoord;
out vec2 v_texCoord;
void main(void) {
  gl_Position=vec4(a_position.x, a_position.y, 0.0, 1.0);
  v_texCoord = a_texCoord;
}`,Ft=`#version 300 es
#define PI 3.1415926535897932384626433832795
precision highp float;
in vec2 v_texCoord;
uniform sampler2D u_texture;
uniform float u_blur;
uniform float u_curvature;
uniform float u_chroma;
uniform float u_scanlineWidth;
uniform float u_scanlineIntensity;
uniform float u_vignette;
out vec4 outputColor;

vec2 curve(vec2 uv) {
  uv = (uv - 0.5) * 2.0;
  uv *= 1.1;
  uv.x *= 1.0 + pow((abs(uv.y) * u_curvature), 2.0);
  uv.y *= 1.0 + pow((abs(uv.x) * u_curvature), 2.0);
  uv /= 1.1;
  uv = (uv / 2.0) + 0.5;
  return uv;
}

void main() {
  vec2 iResolution = vec2(640.0, 360.0);
  vec2 q = v_texCoord;
  vec2 fragCoord = v_texCoord;
  vec2 uv = q;
  uv = curve(uv);

  // Outside of range is black
  if (uv.x < 0.0 || uv.x > 1.0 || uv.y < 0.0 || uv.y > 1.0) {
    outputColor = vec4(0.0, 0.0, 0.0, 1.0);
    return;
  }

  vec4 col;

  // Chromatic aberration
  // col = texture(u_texture, uv.xy);
  col.r = 0.7 * texture(u_texture, vec2(uv.x + 0.001 * u_chroma, uv.y + 0.001 * u_chroma)).r;
  col.g = 0.7 * texture(u_texture, vec2(uv.x + 0.000 * u_chroma, uv.y - 0.002 * u_chroma)).g;
  col.b = 0.7 * texture(u_texture, vec2(uv.x - 0.002 * u_chroma, uv.y + 0.000 * u_chroma)).b;
  
  // Blur
  col += 0.05 * texture(u_texture, vec2(uv.x - 2.0 * u_blur / iResolution.x, uv.y));
  col += 0.10 * texture(u_texture, vec2(uv.x - 1.0 * u_blur / iResolution.x, uv.y));
  col += 0.10 * texture(u_texture, vec2(uv.x + 1.0 * u_blur / iResolution.x, uv.y));
  col += 0.05 * texture(u_texture, vec2(uv.x + 2.0 * u_blur / iResolution.x, uv.y));

  // Vignette
  col *= pow(16.0 * uv.x * uv.y * (1.0 - uv.x) * (1.0 - uv.y), u_vignette);

  // Scanlines
  col *= clamp(1.0 + u_scanlineWidth * sin(uv.y * iResolution.y * 2.0 * PI), 1.0 - u_scanlineIntensity, 1.0);

  outputColor = vec4(col.rgb, 1.0);
}`;function G(i,e){return-1+2*(i/e)}const Yt={font:it};class Xt extends ae{constructor(e,t,s,n){var o;super(t,s),n=n||Yt,this.canvas=e,this.font=n.font||it,this.crt=n.crt,this.maxFps=n.maxFps,this.pixelWidth=t*this.font.charWidth,this.pixelHeight=s*this.font.charHeight,this.pixelScale=((o=n.crt)===null||o===void 0?void 0:o.scale)||1,e.width=this.pixelWidth*this.pixelScale,e.height=this.pixelHeight*this.pixelScale,e.style.imageRendering="pixelated",e.style.outline="none",e.tabIndex=0,this.handleResize(),window.addEventListener("resize",()=>this.handleResize()),this.keys=new Bt(e),this.mouse=new yt(this);const r=e.getContext("webgl2",{antialias:!1});if(!r)throw new Error("Unable to initialize WebGL. Your browser may not support it.");const h=r.createProgram();if(!h)throw new Error("Unable to initialize WebGL. Your browser may not support it.");this.gl=r,this.program=h,r.attachShader(h,this.buildShader(r.VERTEX_SHADER,Vt)),r.attachShader(h,this.buildShader(r.FRAGMENT_SHADER,Kt)),r.linkProgram(h),r.useProgram(h),this.crtProgram=r.createProgram(),r.attachShader(this.crtProgram,this.buildShader(r.VERTEX_SHADER,Gt)),r.attachShader(this.crtProgram,this.buildShader(r.FRAGMENT_SHADER,Ft)),r.linkProgram(this.crtProgram),r.useProgram(this.crtProgram),this.crtBlurLocation=r.getUniformLocation(this.crtProgram,"u_blur"),this.crtCurvatureLocation=r.getUniformLocation(this.crtProgram,"u_curvature"),this.crtChromaLocation=r.getUniformLocation(this.crtProgram,"u_chroma"),this.crtScanlineWidthLocation=r.getUniformLocation(this.crtProgram,"u_scanlineWidth"),this.crtScanlineIntensityLocation=r.getUniformLocation(this.crtProgram,"u_scanlineIntensity"),this.crtVignetteLocation=r.getUniformLocation(this.crtProgram,"u_vignette"),this.crtPositionLocation=r.getAttribLocation(this.crtProgram,"a_position"),this.crtPositionBuffer=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,this.crtPositionBuffer),r.bufferData(r.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),r.STATIC_DRAW),r.enableVertexAttribArray(this.crtPositionLocation),r.vertexAttribPointer(this.crtPositionLocation,2,r.FLOAT,!1,0,0),this.crtTexCoordLocation=r.getAttribLocation(this.crtProgram,"a_texCoord"),this.crtTexCoordBuffer=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,this.crtTexCoordBuffer),r.bufferData(r.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),r.STATIC_DRAW),r.enableVertexAttribArray(this.crtTexCoordLocation),r.vertexAttribPointer(this.crtTexCoordLocation,2,r.FLOAT,!1,0,0),this.positionAttribLocation=this.getAttribLocation("a"),this.textureAttribLocation=this.getAttribLocation("b"),this.fgColorAttribLocation=this.getAttribLocation("c"),this.bgColorAttribLocation=this.getAttribLocation("d");const a=t*s;this.positionsArray=new Float32Array(a*3*4),this.indexArray=new Uint16Array(a*6),this.textureArray=new Float32Array(a*2*4),this.foregroundUint8Array=new Uint8Array(a*4*4),this.foregroundDataView=new DataView(this.foregroundUint8Array.buffer),this.backgroundUint8Array=new Uint8Array(a*4*4),this.backgroundDataView=new DataView(this.backgroundUint8Array.buffer),this.frameBufferTexture=r.createTexture(),r.bindTexture(r.TEXTURE_2D,this.frameBufferTexture),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,this.pixelWidth,this.pixelHeight,0,r.RGBA,r.UNSIGNED_BYTE,null),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),this.frameBuffer=r.createFramebuffer(),r.bindFramebuffer(r.FRAMEBUFFER,this.frameBuffer),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,this.frameBufferTexture,0);let c=0,l=0,d=0;for(let _=0;_<s;_++)for(let g=0;g<t;g++)this.positionsArray[c++]=G(g,t),this.positionsArray[c++]=-G(_,s),this.positionsArray[c++]=G(g+1,t),this.positionsArray[c++]=-G(_,s),this.positionsArray[c++]=G(g+1,t),this.positionsArray[c++]=-G(_+1,s),this.positionsArray[c++]=G(g,t),this.positionsArray[c++]=-G(_+1,s),this.indexArray[l++]=d+0,this.indexArray[l++]=d+1,this.indexArray[l++]=d+2,this.indexArray[l++]=d+0,this.indexArray[l++]=d+2,this.indexArray[l++]=d+3,d+=4;this.positionBuffer=r.createBuffer(),this.indexBuffer=r.createBuffer(),this.textureBuffer=r.createBuffer(),this.foregroundBuffer=r.createBuffer(),this.backgroundBuffer=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,this.positionBuffer),r.bufferData(r.ARRAY_BUFFER,this.positionsArray,r.STATIC_DRAW),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,this.indexBuffer),r.bufferData(r.ELEMENT_ARRAY_BUFFER,this.indexArray,r.STATIC_DRAW),this.texture=this.loadTexture(this.font.url),this.lastRenderTime=0,this.renderDelta=0,this.fps=0,this.averageFps=0,this.maxFps===void 0?this.requestAnimationFrame():window.setInterval(()=>this.renderLoop(performance.now()),1e3/this.maxFps)}handleResize(){const e=this.canvas.parentElement;if(!e)return;const t=e.offsetWidth/this.pixelWidth,s=e.offsetHeight/this.pixelHeight,n=Math.min(t,s),o=n*this.pixelWidth|0,r=n*this.pixelHeight|0;this.canvas.style.width=o+"px",this.canvas.style.height=r+"px"}getAttribLocation(e){const t=this.gl.getAttribLocation(this.program,e);return this.gl.enableVertexAttribArray(t),t}flush(){let e=0,t=0;for(let s=0;s<this.height;s++)for(let n=0;n<this.width;n++){const o=this.getCell(n,s);if(!o.dirty){e+=8,t+=16;continue}const r=o.charCode%16,h=o.charCode/16|0;this.textureArray[e++]=r,this.textureArray[e++]=h,this.textureArray[e++]=r+1,this.textureArray[e++]=h,this.textureArray[e++]=r+1,this.textureArray[e++]=h+1,this.textureArray[e++]=r,this.textureArray[e++]=h+1;for(let a=0;a<4;a++)this.foregroundDataView.setUint32(t,o.fg,!1),this.backgroundDataView.setUint32(t,o.bg,!1),t+=4;o.dirty=!1}}isKeyDown(e){return this.keys.getKey(e).down}isKeyPressed(e){return this.keys.getKey(e).isPressed()}getKeyDownCount(e){return this.keys.getKey(e).downCount}getMovementKey(){if(this.isKeyPressed(f.VK_NUMPAD1)||this.isKeyPressed(f.VK_B))return new v(-1,1);if(this.isKeyPressed(f.VK_NUMPAD2)||this.isKeyPressed(f.VK_J)||this.isKeyPressed(f.VK_DOWN))return new v(0,1);if(this.isKeyPressed(f.VK_NUMPAD3)||this.isKeyPressed(f.VK_N))return new v(1,1);if(this.isKeyPressed(f.VK_NUMPAD4)||this.isKeyPressed(f.VK_H)||this.isKeyPressed(f.VK_LEFT))return new v(-1,0);if(this.isKeyPressed(f.VK_NUMPAD5)||this.isKeyPressed(f.VK_PERIOD))return new v(0,0);if(this.isKeyPressed(f.VK_NUMPAD6)||this.isKeyPressed(f.VK_L)||this.isKeyPressed(f.VK_RIGHT))return new v(1,0);if(this.isKeyPressed(f.VK_NUMPAD7)||this.isKeyPressed(f.VK_Y))return new v(-1,-1);if(this.isKeyPressed(f.VK_NUMPAD8)||this.isKeyPressed(f.VK_K)||this.isKeyPressed(f.VK_UP))return new v(0,-1);if(this.isKeyPressed(f.VK_NUMPAD9)||this.isKeyPressed(f.VK_U))return new v(1,-1)}buildShader(e,t){const s=this.gl,n=s.createShader(e);if(!n)throw new Error("An error occurred compiling the shader: ");if(s.shaderSource(n,t),s.compileShader(n),!s.getShaderParameter(n,s.COMPILE_STATUS))throw new Error("An error occurred compiling the shader: "+s.getShaderInfoLog(n));return n}loadTexture(e){const t=this.gl,s=t.createTexture();t.bindTexture(t.TEXTURE_2D,s);const n=0,o=t.RGBA,r=1,h=1,a=0,c=t.RGBA,l=t.UNSIGNED_BYTE,d=new Uint8Array([0,0,0,255]);t.texImage2D(t.TEXTURE_2D,n,o,r,h,a,c,l,d);const _=new Image;return _.onload=()=>{t.bindTexture(t.TEXTURE_2D,s),t.texImage2D(t.TEXTURE_2D,n,o,c,l,_),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR)},_.src=e,s}render(){const e=this.gl;e.clearColor(0,0,0,1),e.clearDepth(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),this.crt?e.bindFramebuffer(e.FRAMEBUFFER,this.frameBuffer):e.bindFramebuffer(e.FRAMEBUFFER,null),e.viewport(0,0,this.pixelWidth,this.pixelHeight);{const s=e.FLOAT,n=!1,o=0,r=0;e.bindBuffer(e.ARRAY_BUFFER,this.positionBuffer),e.vertexAttribPointer(this.positionAttribLocation,2,s,n,o,r)}{const s=e.FLOAT,n=!1,o=0,r=0;e.bindBuffer(e.ARRAY_BUFFER,this.textureBuffer),e.bufferData(e.ARRAY_BUFFER,this.textureArray,e.DYNAMIC_DRAW),e.vertexAttribPointer(this.textureAttribLocation,2,s,n,o,r)}{const s=e.UNSIGNED_BYTE,n=!0,o=0,r=0;e.bindBuffer(e.ARRAY_BUFFER,this.foregroundBuffer),e.bufferData(e.ARRAY_BUFFER,this.foregroundUint8Array,e.DYNAMIC_DRAW),e.vertexAttribPointer(this.fgColorAttribLocation,4,s,n,o,r)}{const s=e.UNSIGNED_BYTE,n=!0,o=0,r=0;e.bindBuffer(e.ARRAY_BUFFER,this.backgroundBuffer),e.bufferData(e.ARRAY_BUFFER,this.backgroundUint8Array,e.DYNAMIC_DRAW),e.vertexAttribPointer(this.bgColorAttribLocation,4,s,n,o,r)}e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.indexBuffer),e.useProgram(this.program),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.texture);{const t=this.width*this.height*6,s=e.UNSIGNED_SHORT,n=0;e.drawElements(e.TRIANGLES,t,s,n)}}renderCrt(){const e=this.crt;if(!e)return;const t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,null),t.viewport(0,0,this.pixelWidth*this.pixelScale,this.pixelHeight*this.pixelScale),t.useProgram(this.crtProgram),t.uniform1f(this.crtBlurLocation,e.blur),t.uniform1f(this.crtCurvatureLocation,e.curvature),t.uniform1f(this.crtChromaLocation,e.chroma),t.uniform1f(this.crtVignetteLocation,e.vignette),t.uniform1f(this.crtScanlineWidthLocation,e.scanlineWidth),t.uniform1f(this.crtScanlineIntensityLocation,e.scanlineIntensity),t.bindBuffer(t.ARRAY_BUFFER,this.crtPositionBuffer),t.vertexAttribPointer(this.crtPositionLocation,2,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this.crtTexCoordBuffer),t.vertexAttribPointer(this.crtTexCoordLocation,2,t.FLOAT,!1,0,0),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this.frameBufferTexture),t.drawArrays(t.TRIANGLES,0,6)}requestAnimationFrame(){window.requestAnimationFrame(e=>this.renderLoop(e))}renderLoop(e){this.lastRenderTime===0?(this.lastRenderTime=e,this.fps=0):(this.renderDelta=e-this.lastRenderTime,this.lastRenderTime=e,this.fps=1e3/this.renderDelta,this.averageFps=.95*this.averageFps+.05*this.fps),this.keys.updateKeys(e),this.mouse.update(e),this.update&&this.update(),this.flush(),this.render(),this.crt&&this.renderCrt(),this.maxFps===void 0&&this.requestAnimationFrame()}}const E={WHITE:A.WHITE,BLACK:A.BLACK,RED:A.RED,LIGHT_GRAY:A.LIGHT_GRAY,DARK_GRAY:A.DARK_GRAY,PLAYER_ATTACK:A.LIGHT_GRAY,ENEMY_ATTACK:A.LIGHT_RED,NEEDS_TARGET:A.CYAN,STATUS_EFFECT_APPLIED:A.LIGHT_GREEN,DESCEND:A.LIGHT_BLUE,PLAYER_DIE:A.RED,ENEMY_DIE:A.LIGHT_RED,CORPSE:A.RED,INVALID:A.YELLOW,IMPOSSIBLE:A.DARK_GRAY,ERROR:A.LIGHT_RED,WELCOME_TEXT:A.CYAN,HEALTH_RECOVERED:A.GREEN,BAR_TEXT:A.WHITE,BAR_FILLED:A.GREEN,BAR_EMPTY:A.DARK_GRAY,MENU_TITLE:A.YELLOW,MENU_TEXT:A.WHITE};class te{constructor(e){O(this,"parent");this.parent=e}get engine(){if(!this.parent)throw new Error("Component has no parent");return this.parent.engine}get gameMap(){if(!this.parent)throw new Error("Component has no parent");return this.parent.gameMap}}const Oe={CORPSE:0,ITEM:1,ACTOR:2};class rt extends te{constructor(e,t,s,n,o,r=!1,h=0){super(),this.x=e,this.y=t,this.char=s,this.color=n,this.name=o,this.blocks=r,this.renderOrder=h}spawn(e,t,s){const n=he(oe(this));return n.parent=e,n.x=t,n.y=s,e.entities.push(n),n}distance(e,t){return Math.hypot(this.x-e,this.y-t)}move(e,t){this.x+=e,this.y+=t}}const U=[1.01,,1160,,,.01,,1.14,18,-.2,250,,,,-334,,,.81,.01],Wt=[2.15,,190,,,.01,,.82,,-26,-672,.27,,,,,,.35,.01],kt=[1.1,,269,.02,.06,.05,4,1.78,,,,,,,11,.4,,.64,.01],zt=[1.01,,160,.01,.1,.14,2,1.23,1,-.5,-94,.04,,,,,,.9,.01],$t=[,,386,.01,.15,.37,,.8,-.7,,36,.16,.1,.1,,,,.42,.17],jt=[1.14,,607,.09,.14,.36,,1.65,-9,,8,.2,.16,,,,,.42,.17,.09],qt=[2.03,,417,.09,.08,.44,1,.4,-6.2,.1,,,.13,,,.1,,.45,.02,.34];function Qt(i,e,t,s){const n=Math.round(e/t*s);i.fillRect(0,40,s,1," ",E.BAR_TEXT,E.BAR_EMPTY),i.fillRect(0,40,n,1," ",E.BAR_TEXT,E.BAR_FILLED),i.drawString(0,40,`HP: ${e}/${t}`,E.BAR_TEXT)}function Zt(i,e,t,s){i.drawString(t,s,`Dungeon level: ${e}`,E.WHITE)}function Jt(i,e,t,s){i.drawString(21,39,Ce(e.entities.filter(n=>n.x===t&&n.y===s).map(n=>n.name).join(", ")),E.WHITE)}function ot(i,e){const t=i.indexOf(e);t>=0&&i.splice(t,1)}const ei=.3,ht=44100,xe=new AudioContext;function w(...i){return ti(ii(...i))}function ti(...i){const e=xe.createBuffer(i.length,i[0].length,ht),t=xe.createBufferSource();return i.map((s,n)=>e.getChannelData(n).set(s)),t.buffer=e,t.connect(xe.destination),t.start(),t}function ii(i=1,e=.05,t=220,s=0,n=0,o=.1,r=0,h=1,a=0,c=0,l=0,d=0,_=0,g=0,m=0,I=0,x=0,R=1,L=0,p=0){const b=Math.PI*2;let S=ht,dt=At=>At>0?1:-1,ft=a*=500*b/S/S,Xe=t*=(1+e*2*Math.random()-e)*b/S,pe=[],Y=0,_t=0,N=0,J=1,Et=0,gt=0,K=0,Te,W;for(s=s*S+9,L*=S,n*=S,o*=S,x*=S,c*=500*b/S**3,m*=b/S,l*=b/S,d*=S,_=_*S|0,W=s+L+n+o+x|0;N<W;pe[N++]=K)++gt%(I*100|0)||(K=r?r>1?r>2?r>3?Math.sin((Y%b)**3):Math.max(Math.min(Math.tan(Y),1),-1):1-(2*Y/b%2+2)%2:1-4*Math.abs(Math.round(Y/b)-Y/b):Math.sin(Y),K=(_?1-p+p*Math.sin(b*N/_):1)*dt(K)*Math.abs(K)**h*i*ei*(N<s?N/s:N<s+L?1-(N-s)/L*(1-R):N<s+L+n?R:N<W-x?(W-N-x)/o*R:0),K=x?K/2+(x>N?0:(N<W-x?1:(W-N)/x)*pe[N-x|0]/2):K),Te=(t+=a+=c)*Math.cos(m*_t++),Y+=Te-Te*g*(1-(Math.sin(N)+1)*1e9%2),J&&++J>d&&(t+=l,Xe+=l,J=0),_&&!(++Et%_)&&(t=Xe,a=ft,J=J||1);return pe}var si=Object.defineProperty,ni=Object.getOwnPropertyDescriptor,Q=(i,e,t,s)=>{for(var n=s>1?void 0:s?ni(e,t):e,o=i.length-1,r;o>=0;o--)(r=i[o])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&si(e,t,n),n};class _e extends te{constructor(t){super(t);O(this,"target");this.actor=t}}class Ke extends _e{constructor(e,t,s){super(e),this.dx=t,this.dy=s}}let ce=class extends Ke{perform(){const i=this.actor.x+this.dx,e=this.actor.y+this.dy,t=this.gameMap.getActor(i,e);if(!t)return;const s=this.actor.power-t.defense,n=Ce(this.actor.name)+" attacks "+t.name,o=this.actor===this.engine.player?E.PLAYER_ATTACK:E.ENEMY_ATTACK;s>0?(this.engine.log(n+" for "+s+" hit points!",o),this.engine.setPath(void 0),t.takeDamage(s),w(...kt)):console.log(n+" but does no damage.",o)}};ce=Q([T],ce);let le=class extends Ke{perform(){const i=this.actor.x+this.dx,e=this.actor.y+this.dy;if(this.gameMap.isWall(i,e))throw new Error("That way is blocked.");if(this.gameMap.getBlockingEntity(i,e))throw new Error("That way is blocked.");this.actor.move(this.dx,this.dy),this.actor===this.engine.player&&w(...Wt)}};le=Q([T],le);let k=class extends Ke{perform(){if(this.dx===0&&this.dy===0)return;const i=this.actor.x+this.dx,e=this.actor.y+this.dy;return this.gameMap.getActor(i,e)?new ce(this.actor,this.dx,this.dy).perform():new le(this.actor,this.dx,this.dy).perform()}};k=Q([T],k);let De=class extends _e{perform(){const i=this.gameMap.getItem(this.actor.x,this.actor.y);if(!i)throw new Error("There is nothing here to pick up.");this.actor.inventory.push(i),ot(this.gameMap.entities,i),this.engine.log(`You picked up the ${i.name}!`),w(...zt)}};De=Q([T],De);let ee=class extends _e{constructor(i,e){super(i),this.item=e}perform(){this.item.activate(this)}};ee=Q([T],ee);let we=class extends _e{perform(){const i=this.gameMap.stairsLocation;if(!i||i.x!==this.actor.x||i.y!==this.actor.y)throw new Error("There are no stairs here.");this.engine.generateFloor(),this.engine.log("You descend the staircase.",E.DESCEND),w(...qt)}};we=Q([T],we);var ri=Object.defineProperty,oi=Object.getOwnPropertyDescriptor,at=(i,e,t,s)=>{for(var n=s>1?void 0:s?oi(e,t):e,o=i.length-1,r;o>=0;o--)(r=i[o])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&ri(e,t,n),n};class ct{walkToward(e,t){const s=e.gameMap.computePath(e,t);if(s){const n=s[1],o=n.x-e.x,r=n.y-e.y;new le(e,o,r).perform()}}}let ue=class extends ct{perform(i){const e=i.engine.player,t=e.x-i.x,s=e.y-i.y,n=Math.max(Math.abs(t),Math.abs(s));if(!!i.gameMap.isVisible(i.x,i.y)){if(n<=1){new ce(i,t,s).perform();return}this.walkToward(i,e)}}};ue=at([T],ue);let Ne=class extends ct{constructor(i,e){super(),this.previousAi=i,this.turnsRemaining=e}perform(i){if(this.turnsRemaining<=0)i.engine.log(`The ${i.name} is no longer confused.`),i.ai=this.previousAi;else{const e=Math.floor(Math.random()*3)-1,t=Math.floor(Math.random()*3)-1;this.turnsRemaining--;try{new k(i,e,t).perform()}catch{}}}};Ne=at([T],Ne);var hi=Object.defineProperty,ai=Object.getOwnPropertyDescriptor,Ee=(i,e,t,s)=>{for(var n=s>1?void 0:s?ai(e,t):e,o=i.length-1,r;o>=0;o--)(r=i[o])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&hi(e,t,n),n};class lt extends te{onRender(e){}}let X=class extends lt{handleEvents(i){const{player:e,path:t}=this.engine,s=i.getMovementKey();let n;if(i.isKeyDown(f.VK_SHIFT_LEFT)&&i.isKeyPressed(f.VK_PERIOD)?n=new we(e):s?n=new k(this.engine.player,s.x,s.y):i.isKeyPressed(f.VK_G)?n=new De(e):i.isKeyPressed(f.VK_SLASH)?this.engine.eventHandler=new ve(this.engine):i.mouse.x===e.x&&i.mouse.y===e.y&&i.mouse.buttons.get(0).isClicked()&&(n=new k(e,0,0)),t){for(;this.engine.pathIndex<t.length&&e.x===t[this.engine.pathIndex].x&&e.y===t[this.engine.pathIndex].y;)this.engine.pathIndex++;this.engine.pathIndex<t.length&&(n=new k(this.engine.player,t[this.engine.pathIndex].x-e.x,t[this.engine.pathIndex].y-e.y))}n&&this.engine.handleAction(n)}onRender(i){const e={x:i.mouse.x,y:i.mouse.y},t=this.gameMap.computePath(this.engine.player,e);t&&(this.gameMap.renderPath(i,t),i.mouse.buttons.get(0).isClicked()&&(this.engine.path=t,this.engine.pathIndex=0))}};X=Ee([T],X);class Ge extends lt{constructor(t){super(t);O(this,"x");O(this,"y");this.x=t.engine.player.x,this.y=t.engine.player.y}handleEvents(t){const s=t.getMovementKey();s?(this.x+=s.x,this.y+=s.y):t.isKeyPressed(f.VK_ENTER)||t.isKeyPressed(f.VK_NUMPAD_ENTER)?this.onSelect(this.x,this.y):t.isKeyPressed(f.VK_ESCAPE)&&(this.engine.eventHandler=new X(this.engine))}onRender(t){t.drawChar(this.x,this.y,0,E.WHITE,E.WHITE)}}let ve=class extends Ge{onSelect(){this.engine.eventHandler=new X(this.engine)}};ve=Ee([T],ve);let Ie=class extends Ge{constructor(i){super(i),this.action=i}onSelect(i,e){this.action.target={x:i,y:e},this.engine.handleAction(this.action),this.engine.eventHandler=new X(this.engine)}};Ie=Ee([T],Ie);let Se=class extends Ge{constructor(i,e){super(e),this.radius=i,this.action=e}onRender(i){i.drawSingleBox(this.x-this.radius,this.y-this.radius,this.radius*2+1,this.radius*2+1,E.RED)}onSelect(i,e){this.action.target={x:i,y:e},this.engine.handleAction(this.action),this.engine.eventHandler=new X(this.engine)}};Se=Ee([T],Se);var ci=Object.defineProperty,li=Object.getOwnPropertyDescriptor,ge=(i,e,t,s)=>{for(var n=s>1?void 0:s?li(e,t):e,o=i.length-1,r;o>=0;o--)(r=i[o])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&ci(e,t,n),n};class Z extends rt{constructor(e,t,s){super(0,0,e,t,s,!1,Oe.ITEM)}getAction(e){return new ee(e,this)}}let Be=class extends Z{constructor(i,e,t,s){super(i,e,t),this.amount=s}activate(i){const e=i.actor.heal(this.amount);if(e>0)Ae(i.actor,this),this.engine.log(`You consume the ${this.name}, and recover ${e} HP!`,E.HEALTH_RECOVERED),w(...$t);else throw new Error("Your health is already full.")}};Be=ge([T],Be);let Pe=class extends Z{constructor(i,e,t,s,n){super(i,e,t),this.damage=s,this.maxRange=n}activate(i){const e=i.actor;let t,s=this.maxRange+1;for(const n of this.gameMap.actors)if(n!==e&&this.gameMap.isVisible(n.x,n.y)){const o=e.distance(n.x,n.y);o<s&&(t=n,s=o)}if(t)this.engine.log(`A lightning bolt strikes the ${t.name} with a loud thunder, for ${this.damage} damage!`),t.takeDamage(this.damage),Ae(i.actor,this);else throw new Error("No enemy is close enough to strike.")}};Pe=ge([T],Pe);let ye=class extends Z{constructor(i,e,t,s){super(i,e,t),this.numberOfTurns=s}getAction(i){this.engine.log("Select a target location",E.NEEDS_TARGET),this.engine.eventHandler=new Ie(new ee(i,this))}activate(i){var o,r;const e=(o=i.target)==null?void 0:o.x,t=(r=i.target)==null?void 0:r.y;if(!this.gameMap.isVisible(e,t))throw new Error("You cannot target an area that you cannot see.");const s=this.gameMap.getActor(e,t);if(!s)throw new Error("You must select an enemy to target.");const n=i.actor;if(s===n)throw new Error("You cannot confuse yourself!");this.engine.log(`The eyes of the ${s.name} look vacant, as he starts to stumble around!`,E.STATUS_EFFECT_APPLIED),s.ai=new Ne(s.ai,this.numberOfTurns),Ae(n,this)}};ye=ge([T],ye);let Ue=class extends Z{constructor(i,e,t,s,n){super(i,e,t),this.damage=s,this.radius=n}getAction(i){this.engine.log("Select a target location",E.NEEDS_TARGET),this.engine.eventHandler=new Se(this.radius,new ee(i,this))}activate(i){var n,o;const e=(n=i.target)==null?void 0:n.x,t=(o=i.target)==null?void 0:o.y;if(!this.gameMap.isVisible(e,t))throw new Error("You cannot target an area that you cannot see.");let s=!1;for(const r of this.gameMap.actors)r.distance(e,t)<=this.radius&&(this.engine.log(`The ${r.name} is engulfed in a fiery explosion, taking ${this.damage} damage!`,E.RED),r.takeDamage(this.damage),s=!0);if(!s)throw new Error("There are no targets in the radius.");Ae(i.actor,this)}};Ue=ge([T],Ue);function Ae(i,e){ot(i.inventory,e)}var ui=Object.defineProperty,di=Object.getOwnPropertyDescriptor,fi=(i,e,t,s)=>{for(var n=s>1?void 0:s?di(e,t):e,o=i.length-1,r;o>=0;o--)(r=i[o])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&ui(e,t,n),n};const z={WEAPON:1,ARMOR:2};let $=class extends Z{constructor(i,e,t,s,n,o){super(i,e,t),this.equipmentType=s,this.powerBonus=n,this.defenseBonus=o}activate(i){i.actor.toggleEquip(this)}};$=fi([T],$);var _i=Object.defineProperty,Ei=Object.getOwnPropertyDescriptor,gi=(i,e,t,s)=>{for(var n=s>1?void 0:s?Ei(e,t):e,o=i.length-1,r;o>=0;o--)(r=i[o])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&_i(e,t,n),n};let j=class extends rt{constructor(e,t,s,n,o,r,h,a,c=0,l){super(0,0,e,t,s,n);O(this,"inventory",[]);O(this,"weapon");O(this,"armor");O(this,"level",1);this.maxHp=o,this.hp_=r,this.baseDefense=h,this.basePower=a,this.xp=c,this.ai=l,this.renderOrder=Oe.ACTOR}get hp(){return this.hp_}get experienceToNextLevel(){return this.level*50}get defense(){return this.baseDefense+this.defenseBonus}get power(){return this.basePower+this.powerBonus}get defenseBonus(){let e=0;return this.weapon&&(e+=this.weapon.defenseBonus),this.armor&&(e+=this.armor.defenseBonus),e}get powerBonus(){let e=0;return this.weapon&&(e+=this.weapon.powerBonus),this.armor&&(e+=this.armor.powerBonus),e}isEquipped(e){return e===this.weapon||e===this.armor}equip(e,t=!0){switch(e.equipmentType){case z.ARMOR:this.unequip(this.armor),this.armor=e;break;case z.WEAPON:this.unequip(this.weapon),this.weapon=e;break}t&&this.engine.log("You equip the "+e.name)}unequip(e){this.weapon&&this.weapon===e&&(this.weapon=void 0,this.engine.log("You remove the "+e.name)),this.armor&&this.armor===e&&(this.armor=void 0,this.engine.log("You remove the "+e.name))}toggleEquip(e){this.isEquipped(e)?this.unequip(e):this.equip(e)}addXp(e){this.xp+=e,this.engine.log(`You gain ${e} experience points.`),this.xp>=this.experienceToNextLevel&&qi(this)}levelUp(){this.xp-=this.experienceToNextLevel,this.level++}increaseMaxHp(e=20){this.maxHp+=e,this.hp_+=e,this.engine.log("Your health improves!"),this.levelUp()}increasePower(e=1){this.basePower+=e,this.engine.log("You feel stronger!"),this.levelUp()}increaseDefense(e=1){this.baseDefense+=e,this.engine.log("Your movements are swifter!"),this.levelUp()}heal(e){const t=Math.min(e,this.maxHp-this.hp);return this.hp_+=t,t}takeDamage(e){this.hp_=Math.max(0,Math.min(this.hp_-e,this.maxHp)),this.hp_===0&&this.die()}die(){this===this.engine.player?this.engine.log("You died!",E.PLAYER_DIE):(this.engine.log(`${Ce(this.name)} is dead!`,E.ENEMY_DIE),this.engine.player.addXp(this.xp)),this.char="%",this.color=E.CORPSE,this.blocks=!1,this.ai=void 0,this.name="remains of "+this.name,this.renderOrder=Oe.CORPSE}};j=gi([T],j);const Ai={walkable:!0,transparent:!0,dark:new C(0,0,".",E.DARK_GRAY,E.BLACK),light:new C(0,0,".",E.LIGHT_GRAY,E.BLACK)},$e={walkable:!1,transparent:!1,dark:new C(0,0,"#",E.DARK_GRAY,E.BLACK),light:new C(0,0,"#",E.LIGHT_GRAY,E.BLACK)},pi={walkable:!1,transparent:!1,dark:new C(0,0,">",E.DARK_GRAY,E.BLACK),light:new C(0,0,">",E.WHITE,E.BLACK)};var Ti=Object.defineProperty,xi=Object.getOwnPropertyDescriptor,Ri=(i,e,t,s)=>{for(var n=s>1?void 0:s?xi(e,t):e,o=i.length-1,r;o>=0;o--)(r=i[o])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&Ti(e,t,n),n};let de=class extends te{constructor(e,t,s,n){super(e);O(this,"tileMap");O(this,"console");O(this,"level",0);O(this,"stairsLocation",new v(0,0));this.width=t,this.height=s,this.entities=n,this.tileMap=[],this.console=new ae(t,s);for(let o=0;o<s;o++){this.tileMap.push([]);for(let r=0;r<t;r++)this.tileMap[o].push($e),this.makeWall(r,o)}}get actors(){return this.entities.filter(e=>e instanceof j&&e.blocks)}get items(){return this.entities.filter(e=>e instanceof Z)}createRoom(e){for(let t=e.y+1;t<e.y2;t++)for(let s=e.x+1;s<e.x2;s++)this.makeFloor(s,t)}createHTunnel(e,t,s){for(let n=Math.min(e,t);n<=Math.max(e,t);n++)this.makeFloor(n,s)}createVTunnel(e,t,s){for(let n=Math.min(e,t);n<=Math.max(e,t);n++)this.makeFloor(s,n)}makeStairs(e,t){this.makeFloor(e,t),this.stairsLocation=new v(e,t),this.tileMap[t][e]=pi}updateFov(e,t){this.console.computeFov(e,t,8),this.console.updateExplored()}isVisible(e,t){return this.console.isVisible(e,t)}isWall(e,t){return this.console.isBlocked(e,t)}getBlockingEntity(e,t){return this.entities.find(s=>s.blocks&&s.x===e&&s.y===t)}getActor(e,t){return this.actors.find(s=>s.x===e&&s.y===t)}getItem(e,t){return this.items.find(s=>s.x===e&&s.y===t)}computePath(e,t){return Mt(this.console,e,t,1e3)}render(e){for(let t=0;t<this.height;t++)for(let s=0;s<this.width;s++){const n=this.tileMap[t][s];this.isVisible(s,t)?e.drawCell(s,t,n.light):this.console.grid[t][s].explored?e.drawCell(s,t,n.dark):e.drawChar(s,t,0,E.BLACK,E.BLACK)}this.entities.sort((t,s)=>t.renderOrder-s.renderOrder);for(const t of this.entities)this.isVisible(t.x,t.y)&&e.drawChar(t.x,t.y,t.char,t.color)}renderPath(e,t){for(let s=1;s<t.length;s++){const n=t[s],o=e.getCell(n.x,n.y);o&&o.setBackground(E.DARK_GRAY)}}makeWall(e,t){this.tileMap[t][e]=$e,this.console.setBlocked(e,t,!0),this.console.setBlockedSight(e,t,!0)}makeFloor(e,t){this.tileMap[t][e]=Ai,this.console.setBlocked(e,t,!1),this.console.setBlockedSight(e,t,!1)}};de=Ri([T],de);var mi=Object.defineProperty,Li=Object.getOwnPropertyDescriptor,Oi=(i,e,t,s)=>{for(var n=s>1?void 0:s?Li(e,t):e,o=i.length-1,r;o>=0;o--)(r=i[o])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&mi(e,t,n),n};let be=class{constructor(){O(this,"messages",[])}add(i,e=E.WHITE){this.messages.push(new B(i,e))}render(i,e,t,s,n){let o=n-1;for(let r=this.messages.length-1;r>=0&&o>=0;r--){const h=this.messages[r],a=tt(h.text,s).reverse();for(const c of a)i.drawString(e,t+o,c,h.fg),o--}}};be=Oi([T],be);const se=new j("o",A.LIGHT_GREEN,"orc",!0,10,10,0,3,35,new ue),Re=new j("T",A.GREEN,"troll",!0,16,16,1,4,100,new ue),ne=new Be("!",A.VIOLET,"Health Potion",4),je=new Pe("~",A.YELLOW,"Lightning Scroll",20,5),me=new ye("~",A.VIOLET,"Confusion Scroll",10),Di=new Ue("~",A.RED,"Fireball Scroll",12,3),qe=new $("/",A.CYAN,"Dagger",z.WEAPON,2,0),Qe=new $("/",A.CYAN,"Sword",z.WEAPON,4,0),Ze=new $("[",A.BROWN,"Leather Armor",z.ARMOR,0,1),wi=new $("[",A.BROWN,"Chain Mail",z.ARMOR,0,3),Ni=[[1,1],[4,2]],vi=[[1,2],[4,3],[6,5]],Ii=[[1,[[ne,35]]],[3,[[ne,35],[me,10]]],[5,[[ne,35],[me,10],[je,25],[Qe,5]]],[7,[[ne,35],[me,10],[je,25],[Di,25],[Qe,5],[wi,15]]]],Si=[[1,[[se,80]]],[4,[[se,80],[Re,15]]],[6,[[se,80],[Re,30]]],[8,[[se,80],[Re,60]]]];function Bi(i,e,t,s,n,o,r){const{rng:h,player:a}=i,c=new de(i,o,r,[a]);c.level=e;const l=[];let d;for(let _=0;_<t;_++){const g=h.nextRange(s,n),m=h.nextRange(s,n),I=h.nextRange(0,o-g-1),x=h.nextRange(0,r-m-1),R=new H(I,x,g,m);if(!l.some(L=>L.intersects(R))){if(c.createRoom(R),d=R.getCenter(),l.length===0)a.parent=c,a.x=d.x,a.y=d.y;else{const L=l[l.length-1].getCenter();h.nextRange(0,1)===1?(c.createHTunnel(L.x,d.x,L.y),c.createVTunnel(L.y,d.y,d.x)):(c.createVTunnel(L.y,d.y,L.x),c.createHTunnel(L.x,d.x,d.y))}Pi(h,R,c,e),c.makeStairs(d.x,d.y),l.push(R)}}return c}function Pi(i,e,t,s){const n=re(vi,s),o=re(Ni,s),r=i.nextRange(0,n+1),h=i.nextRange(0,o+1),a=re(Si,s),c=re(Ii,s);for(let l=0;l<r;l++){const d=i.nextRange(e.x+1,e.x2-1),_=i.nextRange(e.y+1,e.y2-1);t.getBlockingEntity(d,_)||Je(i,c).spawn(t,d,_)}for(let l=0;l<h;l++){const d=i.nextRange(e.x+1,e.x2-1),_=i.nextRange(e.y+1,e.y2-1);t.getBlockingEntity(d,_)||Je(i,a).spawn(t,d,_)}}function re(i,e){for(const[t,s]of i)if(e<=t)return s;return i[i.length-1][1]}function Je(i,e){let t=0;for(const n of e)t+=n[1];let s=t*i.nextFloat();for(const n of e)if(s-=n[1],s<=0)return n[0];return e[e.length-1][0]}var yi=Object.defineProperty,Ui=Object.getOwnPropertyDescriptor,bi=(i,e,t,s)=>{for(var n=s>1?void 0:s?Ui(e,t):e,o=i.length-1,r;o>=0;o--)(r=i[o])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&yi(e,t,n),n};const Mi=80,Hi=38,Ci=10,Vi=6,Ki=30;let Me=class extends te{constructor(){super(...arguments);O(this,"rng",new Le);O(this,"player",new j("@",E.WHITE,"Player",!0,30,30,1,2));O(this,"messageLog",new be);O(this,"eventHandler",new X(this));O(this,"gameMap_",new de(this,1,1,[]));O(this,"path");O(this,"pathIndex",0)}get engine(){return this}get gameMap(){return this.gameMap_}log(e,t=E.WHITE){this.messageLog.add(e,t)}generateFloor(){this.gameMap_=Bi(this,this.gameMap.level+1,Ki,Vi,Ci,Mi,Hi),this.updateFov()}setPath(e){this.path=e,this.pathIndex=0}handleEnemyTurns(){this.gameMap.actors.forEach(e=>{var t;try{(t=e.ai)==null||t.perform(e)}catch(s){console.error("Unhandled AI error:",s)}})}handleEvents(e){this.player.hp>0&&this.eventHandler.handleEvents(e)}handleAction(e){if(!!e){try{e.perform()}catch(t){this.log(t.message,E.ERROR),this.setPath(void 0);return}this.handleEnemyTurns(),this.updateFov()}}updateFov(){this.gameMap.updateFov(this.player.x,this.player.y)}render(e){e.clear(),this.gameMap.render(e),this.eventHandler.onRender(e),this.messageLog.render(e,21,40,40,5),Qt(e,this.player.hp,this.player.maxHp,20),Zt(e,this.gameMap.level,0,42),Jt(e,this.gameMap,e.mouse.x,e.mouse.y)}};Me=bi([T],Me);function Gi(i){const e=Math.round(i.width/2),t=Math.round(i.height/2);i.drawCenteredString(e,t-8,"TOMBS OF ANCIENT KINGS",E.MENU_TITLE),i.drawCenteredString(e,i.height-2,"By Cody Ebberson",E.MENU_TITLE)}function Fi(){const i=new Me;i.generateFloor(),i.log("Hello and welcome, adventurer, to yet another dungeon!",E.WELCOME_TEXT);const e=i.player,t=he(oe(qe)),s=he(oe(Ze));return qe.parent=e,Ze.parent=e,e.inventory.push(t),e.equip(t),e.inventory.push(s),e.equip(s),i}function Yi(i){localStorage.setItem("savegame",oe(i))}function Xi(){return he(localStorage.getItem("savegame")||"")}const Fe=80,Ye=45,Wi=30,ki={scale:3,blur:.5,curvature:.12,chroma:.5,vignette:.1,scanlineWidth:.75,scanlineIntensity:.25},P=new Xt(document.querySelector("canvas"),Fe,Ye,{maxFps:Wi,crt:ki}),V=new Nt(P);let M;ut();P.update=()=>{V.handleInput()||(M&&(P.isKeyPressed(f.VK_I)?zi(M):P.isKeyPressed(f.VK_D)?$i(M):P.isKeyPressed(f.VK_V)?ji(M):P.isKeyPressed(f.VK_C)?Qi(M):M.handleEvents(P)),P.isKeyPressed(f.VK_ESCAPE)&&ut()),M?M.render(P):Gi(P),V.draw()};function ut(){V.add(new fe("Main Menu",["New Game","Continue","Save Game","Load Game"],i=>{switch(i){case 0:et(Fi()),w(...U);break;case 1:w(...U);break;case 2:Yi(M),w(...U);break;case 3:try{et(Xi()),w(...U)}catch{V.add(new nt("Error","Could not load saved game"))}break}}))}function et(i){M=i,P.fillRect(0,0,Fe,Ye,0,y.WHITE,y.BLACK)}function zi(i){const e=i.player;V.add(new fe("Select an item to use",e.inventory.map(t=>t.name+(e.isEquipped(t)?" (equipped)":"")),t=>{i.handleAction(e.inventory[t].getAction(e)),w(...U)})),w(...U)}function $i(i){const e=i.player;V.add(new fe("Select an item to drop",e.inventory.map(t=>t.name),t=>{e.inventory.splice(t,1),w(...U)})),w(...U)}function ji(i){V.add(new Pt(new H(2,2,Fe-4,Ye-4),"Message Log",new B(void 0,void 0,void 0,i.messageLog.messages))),w(...U)}function qi(i){V.add(new fe("Level up! Select an attribute to increase.",[`Constitution (+20 HP, from ${i.maxHp})`,`Strength (+1 attack, from ${i.power})`,`Agility (+1 defense, from ${i.defense})`],e=>{switch(e){case 0:i.increaseMaxHp();break;case 1:i.increasePower();break;case 2:i.increaseDefense();break}w(...jt)})),w(...U)}function Qi(i){const e=i.player;V.add(new nt("Character",new B(`Level:            ${e.level}`,y.WHITE,void 0,[new B(`XP:               ${e.xp}`),new B(`XP to next level: ${e.experienceToNextLevel}`),new B(`Max HP:           ${e.maxHp}`),new B(`HP:               ${e.hp}`),new B(`Attack:           ${e.power}`),new B(`Defense:          ${e.defense}`)]))),w(...U)}
