var at=Object.defineProperty;var ct=(e,t,i)=>t in e?at(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i;var P=(e,t,i)=>(ct(e,typeof t!="symbol"?t+"":t,i),i);const _t=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))s(r);new MutationObserver(r=>{for(const n of r)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function i(r){const n={};return r.integrity&&(n.integrity=r.integrity),r.referrerpolicy&&(n.referrerPolicy=r.referrerpolicy),r.crossorigin==="use-credentials"?n.credentials="include":r.crossorigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(r){if(r.ep)return;r.ep=!0;const n=i(r);fetch(r.href,n)}};_t();var m;(function(e){e[e.None=0]="None",e[e.Blend=1]="Blend",e[e.Add=2]="Add"})(m||(m={}));function b(e,t,i,s){var r=arguments.length,n=r<3?t:s===null?s=Object.getOwnPropertyDescriptor(t,i):s,o;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")n=Reflect.decorate(e,t,i,s);else for(var h=e.length-1;h>=0;h--)(o=e[h])&&(n=(r<3?o(n):r>3?o(t,i,n):o(t,i))||n);return r>3&&n&&Object.defineProperty(t,i,n),n}function _(e,t,i,s){return s===void 0&&(s=255),(e<<24)+(t<<16)+(i<<8)+s}const N={BLACK:_(0,0,0),WHITE:_(255,255,255),LIGHT_GRAY:_(170,170,170),DARK_GRAY:_(85,85,85),YELLOW:_(255,255,85),BROWN:_(170,85,0),LIGHT_RED:_(255,85,85),DARK_RED:_(170,0,0),LIGHT_GREEN:_(85,255,85),DARK_GREEN:_(0,170,0),LIGHT_CYAN:_(85,255,255),DARK_CYAN:_(0,170,170),LIGHT_BLUE:_(85,85,255),DARK_BLUE:_(0,0,170),LIGHT_MAGENTA:_(255,85,255),DARK_MAGENTA:_(170,0,170),ORANGE:_(255,136,0)},Z=new Map;function L(e){Z.set(e.name,e)}function ft(e){const t=[],i=new WeakMap,s=r(e);return JSON.stringify({instances:t,root:s});function r(l){return Array.isArray(l)?n(l):l&&typeof l=="object"?o(l):l}function n(l){const a=[];for(let c=0;c<l.length;c++)a[c]=r(l[c]);return a}function o(l){if(l&&l.constructor.name&&l.constructor.name!=="Object"){if(!Z.has(l.constructor.name))throw new Error(`Class ${l.constructor.name} is not serializable.`);if(i.has(l))return{$ref:i.get(l)};const a=t.length;return t.push({$type:l.constructor.name}),i.set(l,a),t[a]=Object.assign(Object.assign({},h(l)),{$type:l.constructor.name}),{$ref:a}}return h(l)}function h(l){const a={};for(const c of Object.keys(l))a[c]=r(l[c]);return a}}function dt(e){const t=JSON.parse(e),i=t.instances;for(let h=0;h<i.length;h++){const l=i[h],a=Z.get(l.$type);delete l.$type,i[h]=Object.create(a.prototype,Object.getOwnPropertyDescriptors(l))}for(let h=0;h<i.length;h++)o(i[h]);return s(t.root);function s(h){return Array.isArray(h)?r(h):h&&typeof h=="object"?n(h):h}function r(h){for(let l=0;l<h.length;l++)h[l]=s(h[l]);return h}function n(h){return ut(h)?i[h.$ref]:(o(h),h)}function o(h){for(const[l,a]of Object.entries(h))h[l]=s(a)}}function ut(e){return!!(e&&typeof e=="object"&&"$ref"in e)}function At(e){return typeof e=="string"&&e.length>0?e.charCodeAt(0):e}let V=class{constructor(t,i,s,r,n){this.x=t,this.y=i,s!==void 0?this.charCode=At(s):this.charCode=" ".charCodeAt(0),r!==void 0?this.fg=r:this.fg=N.WHITE,n!==void 0?this.bg=n:this.bg=N.BLACK,this.dirty=!0,this.blocked=!1,this.blockedSight=!1,this.explored=!1,this.visible=!1,this.pathId=-1,this.g=0,this.h=0,this.prev=null}setCharCode(t){this.charCode!==t&&(this.charCode=t,this.dirty=!0)}setForeground(t){t!=null&&t!==this.fg&&(this.fg=t,this.dirty=!0)}setBackground(t){t!=null&&t!==this.bg&&(this.bg=t,this.dirty=!0)}setValue(t,i,s){return typeof t=="string"&&(t=t.charCodeAt(0)),typeof t=="number"?(this.setCharCode(t),i!==void 0&&this.setForeground(i),s!==void 0&&this.setBackground(s)):this.drawCell(t,m.None),this.dirty}drawCell(t,i){const s=t.bg&255;i===m.None||t.charCode>0?(this.setCharCode(t.charCode),this.setForeground(t.fg)):s>0&&s<255&&this.setForeground(this.blendColors(this.fg,t.bg,i)),i===m.None||s===255?this.setBackground(t.bg):s>0&&this.setBackground(this.blendColors(this.bg,t.bg,i))}blendColors(t,i,s){const r=i&255,n=(255-r)/255,o=1-n,h=t>>24&255,l=t>>16&255,a=t>>8&255,c=i>>24&255,u=i>>16&255,f=i>>8&255;switch(s){case m.Blend:return _(n*h+o*c|0,n*l+o*u|0,n*a+o*f|0);case m.Add:return _(this.clamp(h+o*c|0),this.clamp(l+o*u|0),this.clamp(a+o*f|0));default:return i}}clamp(t){return Math.min(255,t)}};V=b([L],V);var T;(function(e){e[e.SMILEY=1]="SMILEY",e[e.INVERSE_SMILEY=2]="INVERSE_SMILEY",e[e.HEART=3]="HEART",e[e.DIAMOND=4]="DIAMOND",e[e.CLUB=5]="CLUB",e[e.SPADE=6]="SPADE",e[e.BULLET=7]="BULLET",e[e.INVERSE_BULLET=8]="INVERSE_BULLET",e[e.LIGHT_SHADE=176]="LIGHT_SHADE",e[e.MEDIUM_SHADE=177]="MEDIUM_SHADE",e[e.DARK_SHADE=178]="DARK_SHADE",e[e.BOX_SINGLE_VERTICAL=179]="BOX_SINGLE_VERTICAL",e[e.BOX_SINGLE_VERTICAL_AND_SINGLE_LEFT=180]="BOX_SINGLE_VERTICAL_AND_SINGLE_LEFT",e[e.BOX_DOUBLE_VERTICAL_AND_DOUBLE_LEFT=185]="BOX_DOUBLE_VERTICAL_AND_DOUBLE_LEFT",e[e.BOX_DOUBLE_VERTICAL=186]="BOX_DOUBLE_VERTICAL",e[e.BOX_DOUBLE_DOWN_AND_DOUBLE_LEFT=187]="BOX_DOUBLE_DOWN_AND_DOUBLE_LEFT",e[e.BOX_DOUBLE_UP_AND_DOUBLE_LEFT=188]="BOX_DOUBLE_UP_AND_DOUBLE_LEFT",e[e.BOX_SINGLE_DOWN_AND_SINGLE_LEFT=191]="BOX_SINGLE_DOWN_AND_SINGLE_LEFT",e[e.BOX_SINGLE_UP_AND_SINGLE_RIGHT=192]="BOX_SINGLE_UP_AND_SINGLE_RIGHT",e[e.BOX_SINGLE_HORIZONTAL_AND_SINGLE_UP=193]="BOX_SINGLE_HORIZONTAL_AND_SINGLE_UP",e[e.BOX_SINGLE_HORIZONTAL_AND_SINGLE_DOWN=194]="BOX_SINGLE_HORIZONTAL_AND_SINGLE_DOWN",e[e.BOX_SINGLE_VERTICAL_AND_SINGLE_RIGHT=195]="BOX_SINGLE_VERTICAL_AND_SINGLE_RIGHT",e[e.BOX_SINGLE_HORIZONTAL=196]="BOX_SINGLE_HORIZONTAL",e[e.BOX_SINGLE_VERTICAL_AND_SINGLE_HORIZONTAL=197]="BOX_SINGLE_VERTICAL_AND_SINGLE_HORIZONTAL",e[e.BOX_DOUBLE_UP_AND_DOUBLE_RIGHT=200]="BOX_DOUBLE_UP_AND_DOUBLE_RIGHT",e[e.BOX_DOUBLE_DOWN_AND_DOUBLE_RIGHT=201]="BOX_DOUBLE_DOWN_AND_DOUBLE_RIGHT",e[e.BOX_DOUBLE_HORIZONTAL_AND_DOUBLE_UP=202]="BOX_DOUBLE_HORIZONTAL_AND_DOUBLE_UP",e[e.BOX_DOUBLE_HORIZONTAL_AND_DOUBLE_DOWN=203]="BOX_DOUBLE_HORIZONTAL_AND_DOUBLE_DOWN",e[e.BOX_DOUBLE_VERTICAL_AND_DOUBLE_RIGHT=204]="BOX_DOUBLE_VERTICAL_AND_DOUBLE_RIGHT",e[e.BOX_DOUBLE_HORIZONTAL=205]="BOX_DOUBLE_HORIZONTAL",e[e.BOX_DOUBLE_VERTICAL_AND_DOUBLE_HORIZONTAL=206]="BOX_DOUBLE_VERTICAL_AND_DOUBLE_HORIZONTAL",e[e.BOX_SINGLE_UP_AND_SINGLE_LEFT=217]="BOX_SINGLE_UP_AND_SINGLE_LEFT",e[e.BOX_SINGLE_DOWN_AND_SINGLE_RIGHT=218]="BOX_SINGLE_DOWN_AND_SINGLE_RIGHT",e[e.BLOCK_FULL=219]="BLOCK_FULL",e[e.BLOCK_BOTTOM_HALF=220]="BLOCK_BOTTOM_HALF",e[e.BLOCK_LEFT_HALF=221]="BLOCK_LEFT_HALF",e[e.BLOCK_RIGHT_HALF=222]="BLOCK_RIGHT_HALF",e[e.BLOCK_TOP_HALF=223]="BLOCK_TOP_HALF"})(T||(T={}));function ot(e,t){const i=new RegExp("(\\S(.{0,"+t+"}\\S)?)\\s+","g");return(e+" ").replace(i,`$1
`).trim().split(`
`).map(s=>s.trim())}function $(e){return e&&e.charAt(0).toUpperCase()+e.slice(1)}let y=class{constructor(t,i,s){this.width=t,this.height=i,this.grid=[],this.originX=0,this.originY=0,this.minX=0,this.maxX=0,this.minY=0,this.maxY=0,this.radius=0;for(let r=0;r<i;r++){const n=[];for(let o=0;o<t;o++)n.push(new V(o,r));this.grid.push(n)}if(this.clear(),s)for(let r=0;r<i;r++)for(let n=0;n<t;n++)this.grid[r][n].blocked=this.grid[r][n].blockedSight=s(n,r)}clear(){for(let t=0;t<this.height;t++)for(let i=0;i<this.width;i++)this.drawChar(i,t,0)}getCell(t,i){if(!(t<0||i<0||t>=this.width||i>=this.height))return this.grid[i][t]}getCharCode(t,i){if(!(t<0||i<0||t>=this.width||i>=this.height))return this.grid[i][t].charCode}drawChar(t,i,s,r,n){this.clip&&!this.clip.contains({x:t,y:i})||t>=0&&t<this.width&&i>=0&&i<this.height&&this.grid[i|0][t|0].setValue(s,r,n)}drawString(t,i,s,r,n){const o=s.split(`
`);for(let h=0;h<o.length;h++)this.drawStringLine(t,i+h,o[h],r,n)}drawStringLine(t,i,s,r,n){for(let o=0;o<s.length;o++)this.drawChar(t+o,i,s.charCodeAt(o),r,n)}drawCenteredString(t,i,s,r,n){this.drawString(t-Math.floor(s.length/2),i,s,r,n)}drawMessage(t,i,s,r){if(s.text){const n=ot(s.text,r||this.width-t);for(const o of n)this.drawStringLine(t,i,o,s.fg,s.bg),i++}if(s.children)for(const n of s.children)i=this.drawMessage(t,i,n,r);return i}drawHLine(t,i,s,r,n,o){for(let h=t;h<t+s;h++)this.drawChar(h,i,r,n,o)}drawVLine(t,i,s,r,n,o){for(let h=i;h<i+s;h++)this.drawChar(t,h,r,n,o)}drawRect(t,i,s,r,n,o,h){this.drawHLine(t,i,s,n,o,h),this.drawHLine(t,i+r-1,s,n,o,h),this.drawVLine(t,i,r,n,o,h),this.drawVLine(t+s-1,i,r,n,o,h)}drawBox(t,i,s,r,n,o,h,l,a,c,u,f,g,R){this.fillRect(t,i,s,r,0,g,R),this.drawHLine(t,i,s,n),this.drawHLine(t,i+r-1,s,h),this.drawVLine(t,i,r,l),this.drawVLine(t+s-1,i,r,o),this.drawChar(t,i,a),this.drawChar(t+s-1,i,c),this.drawChar(t,i+r-1,f),this.drawChar(t+s-1,i+r-1,u)}drawSingleBox(t,i,s,r,n,o){this.drawBox(t,i,s,r,T.BOX_SINGLE_HORIZONTAL,T.BOX_SINGLE_VERTICAL,T.BOX_SINGLE_HORIZONTAL,T.BOX_SINGLE_VERTICAL,T.BOX_SINGLE_DOWN_AND_SINGLE_RIGHT,T.BOX_SINGLE_DOWN_AND_SINGLE_LEFT,T.BOX_SINGLE_UP_AND_SINGLE_LEFT,T.BOX_SINGLE_UP_AND_SINGLE_RIGHT,n,o)}drawDoubleBox(t,i,s,r,n,o){this.drawBox(t,i,s,r,T.BOX_DOUBLE_HORIZONTAL,T.BOX_DOUBLE_VERTICAL,T.BOX_DOUBLE_HORIZONTAL,T.BOX_DOUBLE_VERTICAL,T.BOX_DOUBLE_DOWN_AND_DOUBLE_RIGHT,T.BOX_DOUBLE_DOWN_AND_DOUBLE_LEFT,T.BOX_DOUBLE_UP_AND_DOUBLE_LEFT,T.BOX_DOUBLE_UP_AND_DOUBLE_RIGHT,n,o)}fillRect(t,i,s,r,n,o,h){for(let l=i;l<i+r;l++)this.drawHLine(t,l,s,n,o,h)}drawConsole(t,i,s,r,n,o,h,l){l=l||m.None;for(let a=0;a<h;a++)for(let c=0;c<o;c++){const u=s.getCell(r+c,n+a);u&&this.drawCell(t+c,i+a,u,l)}}drawCell(t,i,s,r){t>=0&&t<this.width&&i>=0&&i<this.height&&this.grid[i][t].drawCell(s,r)}setBlocked(t,i,s){t>=0&&t<this.width&&i>=0&&i<this.height&&(this.grid[i][t].blocked=s)}setBlockedSight(t,i,s){t>=0&&t<this.width&&i>=0&&i<this.height&&(this.grid[i][t].blockedSight=s)}isVisible(t,i){return t<this.minX||t>this.maxX||i<this.minY||i>this.maxY?!1:this.grid[i][t].visible}isBlocked(t,i){return t<0||t>this.width||i<0||i>this.height?!0:this.grid[i][t].blocked}isBlockedSight(t,i){return t<0||t>this.width||i<0||i>this.height?!0:this.grid[i][t].blockedSight}computeOctantY(t,i){const s=[],r=[];let n=1,o=0,h=0,l=0,a,c,u,f,g,R,p,O,E,w;for(c=this.originY+i;c>=this.minY&&c<=this.maxY;c+=i,h=o,++n)for(u=.5/n,w=-1,f=Math.floor(l*n+.5),a=this.originX+f*t;f<=n&&a>=this.minX&&a<=this.maxX;a+=t,++f,w=E){if(g=!0,R=!1,p=f/n,O=w,E=p+u,h>0){if(!(this.grid[c-i][a].visible&&!this.grid[c-i][a].blockedSight)&&!(this.grid[c-i][a-t].visible&&!this.grid[c-i][a-t].blockedSight))g=!1;else for(let A=0;A<h&&g;++A)if(O<=r[A]&&E>=s[A]){if(this.grid[c][a].blockedSight)if(O>=s[A]&&E<=r[A]){g=!1;break}else s[A]=Math.min(s[A],O),r[A]=Math.max(r[A],E),R=!0;else if(p>s[A]&&p<r[A]){g=!1;break}}}g&&(this.grid[c][a].visible=!0,this.grid[c][a].blockedSight&&(l>=O?l=E:R||(s[o]=O,r[o++]=E)))}}computeOctantX(t,i){const s=[],r=[];let n=1,o=0,h=0,l=0,a,c,u,f,g,R,p,O,E,w;for(a=this.originX+t;a>=this.minX&&a<=this.maxX;a+=t,h=o,++n)for(u=.5/n,w=-1,f=Math.floor(l*n+.5),c=this.originY+f*i;f<=n&&c>=this.minY&&c<=this.maxY;c+=i,++f,w=E){if(g=!0,R=!1,p=f/n,O=w,E=p+u,h>0){if(!(this.grid[c][a-t].visible&&!this.grid[c][a-t].blockedSight)&&!(this.grid[c-i][a-t].visible&&!this.grid[c-i][a-t].blockedSight))g=!1;else for(let A=0;A<h&&g;++A)if(O<=r[A]&&E>=s[A]){if(this.grid[c][a].blockedSight)if(O>=s[A]&&E<=r[A]){g=!1;break}else s[A]=Math.min(s[A],O),r[A]=Math.max(r[A],E),R=!0;else if(p>s[A]&&p<r[A]){g=!1;break}}}g&&(this.grid[c][a].visible=!0,this.grid[c][a].blockedSight&&(l>=O?l=E:R||(s[o]=O,r[o++]=E)))}}computeFov(t,i,s,r,n){if(this.originX=t,this.originY=i,this.radius=s,r)this.minX=Math.min(this.minX,Math.max(0,t-s)),this.minY=Math.min(this.minY,Math.max(0,i-s)),this.maxX=Math.max(this.maxX,Math.min(this.width-1,t+s)),this.maxY=Math.max(this.maxY,Math.min(this.height-1,i+s));else{this.minX=Math.max(0,t-s),this.minY=Math.max(0,i-s),this.maxX=Math.min(this.width-1,t+s),this.maxY=Math.min(this.height-1,i+s);for(let o=this.minY;o<=this.maxY;o++)for(let h=this.minX;h<=this.maxX;h++)this.grid[o][h].visible=!1}this.grid[i][t].visible=!0,n===void 0?(this.computeOctantY(1,1),this.computeOctantX(1,1),this.computeOctantX(1,-1),this.computeOctantY(1,-1),this.computeOctantY(-1,-1),this.computeOctantX(-1,-1),this.computeOctantX(-1,1),this.computeOctantY(-1,1)):(n&1&&this.computeOctantY(1,1),n&2&&this.computeOctantX(1,1),n&4&&this.computeOctantX(1,-1),n&8&&this.computeOctantY(1,-1),n&16&&this.computeOctantY(-1,-1),n&32&&this.computeOctantX(-1,-1),n&64&&this.computeOctantX(-1,1),n&128&&this.computeOctantY(-1,1))}updateExplored(){for(let t=this.minY;t<=this.maxY;t++)for(let i=this.minX;i<=this.maxX;i++){const s=this.grid[t][i];s.explored=s.explored||s.visible}}};y=b([L],y);class Et{constructor(t,i,s,r,n){this.url=t,this.charWidth=i,this.charHeight=s,this.scale=r||1,this.graphical=!!n}}const Ot="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACAAQMAAAD58POIAAAABlBMVEUAAAD///+l2Z/dAAAEhklEQVRIx42Sv4oUQRDGC4UzadSwwMUD8QEKlbWD4Q58B/NGpTVocKO1wXHUzMAH0AcwMTYVGg5ag0IzEXaRjdZEZKNzkKbHqtnzHypY09M9+5uvqr7pbYCuC6ftaRhgONXs30eAh0O1rYDm4IS/eH0B8GxRW2vxo396yu/fb0ZFrW1zcOXlPU/XPwK8PGjbWhVwM4KnH61912oK4+zmmHJaQotyt1kvtC2Atdo24iohPDiG/v4eICJsY3Wy8Yvr0DSIBOdxgH6v8wsriWhc8s0AtaK/GzSl1jR0nSjQnwki6FQxNFKjgzO2a7BBqucH7dL4M9z96CIhT1Fs/AgKgcA6dKCxI29DaHNwRJ4EGAU1sU0OG9rmE4SIc3A4FChACqqhJRwpxkqh9wxag4DSmEJ5DtpFwAP4GUf6lmKcFFti1BYuQp4xN8kxM2kNhjdkTOiTUeAKGvhA1rLpMbYACQzCITlTDRMbLYoEa2JWPSMRFZIupcSzMVKcEUkX+sOG+ChNX2vD8ex6k7OFHL0P1655JuPd53WAD+yTv3UrCQiuHmYBbfIxpkImuvpBQBkVb5g4XHv3JkNireG8AO9zDhBZu2z2OMZ11S5/RIlyMefMNaZ4GsCz5xcjyM6hHYEjAYEfO8Ig1rklAe9sRIeYAdwyoIBq6YIzCAKiWoifA3m3o2AzWcdYKOdY47EIf8QABCuYgIUVmdVMEYEDA0Hmo/3D6KKJbh5mxhP3UsWIE97wnEygyizOfOLi2JOJW8CeOblW9IHeKZgv4zxuzDryOmb+4aQH+MXV6e0ywdUcxqCjBWl5GpbzZduOG1QEiGXP86T7EfiJfkMQ4OO4H0yqyNC2zlziWEN7Ywuc2fQ4p5BNkS5QYXP2h5NtRJh0vCKQidtVJmCGAwDSSQpYggSxiRIyzewsgCh4xxiTPDMh5aj//l7btqkr6rQyIOtLji4lVRQwXdzvus40Y53M33fh50GZwF4ExQeMlvuTggLzSi4ElKczUO7zVtpwdyMKdqZKOWb2nDblawPxPmuMwFEWBW+jlZR1eYtS442kiBGMWCi/h1/+GAR6NYOJWiqNJXFygFtrkx5C0O3IeFGs67HhEEhmBu/BUOT+0551pXxYIF+Elpi5AKRkLl5GUbCCZddyMv621ujEBPP4vSy2fotTx3U+d3WBiFOA6VSGSB49v/M7GBX9FPrDaT2c9qr4PCpwZ7qz813R94dVFIe19v33GlMZUghQFb8BrfE7QBmgBMbrn2B3enn/y3B5+DL8UBAdnejdYdBxeV9ejwoYNTgW0Ok/gA7UG2GAzanhL0DG7q4svynwF8UwDPu7u/vD0IudzSltMtVbP+J/gUbR29oJ7Fg9s6Uy+DnpiTCOYc4cXOeXMWfsusSw7FOg9x655nax6BlecwpOQQ68WBwp+H2LMQTuOq2RUigzh2Q/R3CWARJIJG199EwOTyKBlQMznshCRGeQ5gHABAQl6M4gLEdAzVaBWMCiANdsayDCHBA/hagKYfielrJIlipKKQIA9Nf3wBloTHT6BuAx15zRNa1nAAAAAElFTkSuQmCC",ht=new Et(Ot,8,8);var it;(function(e){e[e.OCTANT_SOUTH_SOUTHEAST=1]="OCTANT_SOUTH_SOUTHEAST",e[e.OCTANT_EAST_SOUTHEAST=2]="OCTANT_EAST_SOUTHEAST",e[e.OCTANT_EAST_NORTHTHEAST=4]="OCTANT_EAST_NORTHTHEAST",e[e.OCTANT_NORTH_NORTHEAST=8]="OCTANT_NORTH_NORTHEAST",e[e.OCTANT_NORTH_NORTHWEST=16]="OCTANT_NORTH_NORTHWEST",e[e.OCTANT_WEST_NORTHEAST=32]="OCTANT_WEST_NORTHEAST",e[e.OCTANT_WEST_SOUTHWEST=64]="OCTANT_WEST_SOUTHWEST",e[e.OCTANT_SOUTH_SOUTHWEST=128]="OCTANT_SOUTH_SOUTHWEST"})(it||(it={}));var st;(function(e){e[e.QUADRANT_SOUTHEAST=3]="QUADRANT_SOUTHEAST",e[e.QUADRANT_EAST=6]="QUADRANT_EAST",e[e.QUADRANT_NORTHEAST=12]="QUADRANT_NORTHEAST",e[e.QUADRANT_NORTH=24]="QUADRANT_NORTH",e[e.QUADRANT_NORTHWEST=48]="QUADRANT_NORTHWEST",e[e.QUADRANT_WEST=96]="QUADRANT_WEST",e[e.QUADRANT_SOUTHWEST=192]="QUADRANT_SOUTHWEST",e[e.QUADRANT_SOUTH=129]="QUADRANT_SOUTH"})(st||(st={}));let D=class{constructor(t,i){this.x=t,this.y=i}};D=b([L],D);let B=class{constructor(t,i,s,r){this.x=this.left=t,this.y=this.top=i,this.width=s,this.height=r,this.x2=t+s,this.y2=i+r}getCenter(){return new D(this.x+this.width/2|0,this.y+this.height/2|0)}intersects(t){return this.x<=t.x2&&this.x2>=t.x&&this.y<=t.y2&&this.y2>=t.y}contains(t){return t.x>=this.x&&t.x<this.x2&&t.y>=this.y&&t.y<this.y2}};B=b([L],B);class Tt{constructor(t,i,s){this.dialog=t,this.rect=i,this.contentsOffset=s,this.open=!1,this.count=0}}class gt{getState(t,i){const s=i.contentsRect.width+4,r=i.contentsRect.height+4,n=(t.width-s)/2|0,o=(t.height-r)/2|0;return new Tt(i,new B(n,o,s,r),new D(n+2,o+2))}draw(t,i){const s=i.dialog,{x:r,y:n,width:o,height:h}=i.rect;t.fillRect(r,n,o,h,0,N.WHITE,N.BLACK),t.drawSingleBox(r,n,o,h),t.drawCenteredString(r+o/2|0,n," "+s.title+" "),s.drawContents(t,i.contentsOffset)}}class pt{constructor(t,i){this.terminal=t,this.renderer=i||new gt,this.dialogs=[]}add(t){this.dialogs.push(this.renderer.getState(this.terminal,t))}handleInput(){if(this.dialogs.length===0)return!1;const t=this.dialogs.length-1,i=this.dialogs[this.dialogs.length-1];return i.dialog.handleInput(this.terminal,i.contentsOffset)&&this.dialogs.splice(t,1),!0}draw(){for(let t=0;t<this.dialogs.length;t++)this.renderer.draw(this.terminal,this.dialogs[t])}}class Lt{constructor(t,i){this.contentsRect=t,this.title=i}}let K=class{constructor(t,i,s,r){this.text=t,this.fg=i,this.bg=s,this.children=r}getWidth(){let t=0;if(this.text)for(const i of this.text.split(`
`))t=Math.max(t,i.length);if(this.children)for(const i of this.children)t=Math.max(t,i.getWidth());return t}getHeight(){let t=0;if(this.text&&(t+=this.text.split(`
`).length),this.children)for(const i of this.children)t+=i.getHeight();return t}};K=b([L],K);const Dt=200,Rt=1e3/15;class U{constructor(){this.down=!1,this.downTime=0,this.repeat=!1,this.repeatTime=0,this.downCount=0,this.upCount=100}setDown(t){this.down!==t&&(this.down=t,this.repeat=!1,this.downTime=this.repeatTime=performance.now())}update(t){this.repeat=!1,this.down?(this.downCount++,this.upCount=0,t-this.downTime>=Dt&&t-this.repeatTime>=Rt&&(this.repeat=!0,this.repeatTime=t)):(this.downCount=0,this.upCount++)}isPressed(){return this.downCount===1||this.repeat}isClicked(){return this.upCount===1}}class Nt{constructor(t){this.keys=new Map,Object.keys(d).forEach(i=>this.keys.set(i,new U)),t.addEventListener("keydown",i=>this.setKey(i,!0)),t.addEventListener("keyup",i=>this.setKey(i,!1))}setKey(t,i){const s=t.code;s!==d.VK_F11&&(t.stopPropagation(),t.preventDefault(),this.getKey(s).setDown(i))}updateKeys(t){this.keys.forEach(i=>i.update(t))}getKey(t){let i=this.keys.get(t);return i||(i=new U,this.keys.set(t,i)),i}}var d;(function(e){e.VK_CANCEL="Pause",e.VK_BACKSPACE="Backspace",e.VK_TAB="Tab",e.VK_ENTER="Enter",e.VK_SHIFT_LEFT="ShiftLeft",e.VK_SHIFT_RIGHT="ShiftLeft",e.VK_CONTROL_LEFT="ControlLeft",e.VK_CONTROL_RIGHT="ControlRight",e.VK_ALT_LEFT="AltLeft",e.VK_ALT_RIGHT="AltRight",e.VK_PAUSE="Pause",e.VK_CAPS_LOCK="CapsLock",e.VK_ESCAPE="Escape",e.VK_SPACE="Space",e.VK_PAGE_UP="PageUp",e.VK_PAGE_DOWN="PageDown",e.VK_END="End",e.VK_HOME="Home",e.VK_LEFT="ArrowLeft",e.VK_UP="ArrowUp",e.VK_RIGHT="ArrowRight",e.VK_DOWN="ArrowDown",e.VK_INSERT="Insert",e.VK_DELETE="Delete",e.VK_0="Digit0",e.VK_1="Digit1",e.VK_2="Digit2",e.VK_3="Digit3",e.VK_4="Digit4",e.VK_5="Digit5",e.VK_6="Digit6",e.VK_7="Digit7",e.VK_8="Digit8",e.VK_9="Digit9",e.VK_SEMICOLON="Semicolon",e.VK_EQUALS="Equal",e.VK_A="KeyA",e.VK_B="KeyB",e.VK_C="KeyC",e.VK_D="KeyD",e.VK_E="KeyE",e.VK_F="KeyF",e.VK_G="KeyG",e.VK_H="KeyH",e.VK_I="KeyI",e.VK_J="KeyJ",e.VK_K="KeyK",e.VK_L="KeyL",e.VK_M="KeyM",e.VK_N="KeyN",e.VK_O="KeyO",e.VK_P="KeyP",e.VK_Q="KeyQ",e.VK_R="KeyR",e.VK_S="KeyS",e.VK_T="KeyT",e.VK_U="KeyU",e.VK_V="KeyV",e.VK_W="KeyW",e.VK_X="KeyX",e.VK_Y="KeyY",e.VK_Z="KeyZ",e.VK_CONTEXT_MENU="ContextMenu",e.VK_NUMPAD0="Numpad0",e.VK_NUMPAD1="Numpad1",e.VK_NUMPAD2="Numpad2",e.VK_NUMPAD3="Numpad3",e.VK_NUMPAD4="Numpad4",e.VK_NUMPAD5="Numpad5",e.VK_NUMPAD6="Numpad6",e.VK_NUMPAD7="Numpad7",e.VK_NUMPAD8="Numpad8",e.VK_NUMPAD9="Numpad9",e.VK_MULTIPLY="NumpadMultiply",e.VK_ADD="NumpadAdd",e.VK_SEPARATOR="NumpadDecimal",e.VK_SUBTRACT="NumpadSubtract",e.VK_DECIMAL="NumpadDecimal",e.VK_DIVIDE="NumpadDivide",e.VK_F1="F1",e.VK_F2="F2",e.VK_F3="F3",e.VK_F4="F4",e.VK_F5="F5",e.VK_F6="F6",e.VK_F7="F7",e.VK_F8="F8",e.VK_F9="F9",e.VK_F10="F10",e.VK_F11="F11",e.VK_F12="F12",e.VK_F13="F13",e.VK_F14="F14",e.VK_F15="F15",e.VK_F16="F16",e.VK_F17="F17",e.VK_F18="F18",e.VK_F19="F19",e.VK_F20="F20",e.VK_F21="F21",e.VK_F22="F22",e.VK_F23="F23",e.VK_F24="F24",e.VK_NUM_LOCK="NumLock",e.VK_SCROLL_LOCK="ScrollLock",e.VK_COMMA="Comma",e.VK_PERIOD="Period",e.VK_SLASH="Slash",e.VK_BACKQUOTE="Backquote",e.VK_OPEN_BRACKET="BracketLeft",e.VK_BACK_SLASH="Backslash",e.VK_CLOSE_BRACKET="BracketRight",e.VK_QUOTE="Quote",e.VK_META="OSLeft"})(d||(d={}));class xt extends Lt{constructor(t,i,s){super(t,i),this.message=s,this.scrollY=0,this.messagesHeight=s.getHeight(),this.scrollMax=Math.max(1,this.messagesHeight-this.contentsRect.height),this.scrollbarHeight=this.contentsRect.height*this.contentsRect.height/(this.messagesHeight+1)}drawContents(t,i){t.clip=this.contentsRect,t.drawMessage(i.x,i.y-this.scrollY,this.message),t.clip=void 0;const s=this.scrollY/this.scrollMax*(this.contentsRect.height-this.scrollbarHeight);t.drawVLine(this.contentsRect.x+this.contentsRect.width+1,this.contentsRect.y+s,this.scrollbarHeight,T.MEDIUM_SHADE)}handleInput(t){const i=t.getMovementKey();return i&&(this.scrollY+=i.y),t.isKeyPressed(d.VK_PAGE_DOWN)&&(this.scrollY+=this.contentsRect.height),t.isKeyPressed(d.VK_PAGE_UP)&&(this.scrollY-=this.contentsRect.height),t.mouse.wheelDeltaY!==0&&(this.scrollY+=t.mouse.wheelDeltaY<0?-5:5,t.mouse.wheelDeltaY=0),this.scrollY=Math.max(0,Math.min(this.scrollMax,this.scrollY)),t.isKeyPressed(d.VK_ESCAPE)}}T.BLOCK_TOP_HALF,T.BLOCK_RIGHT_HALF;class mt{constructor(t){this.el=t.canvas,this.width=t.width,this.height=t.height,this.prevX=0,this.prevY=0,this.x=0,this.y=0,this.dx=0,this.dy=0,this.wheelDeltaX=0,this.wheelDeltaY=0,this.buttons=[new U,new U,new U];const i=this.el;i.addEventListener("mousedown",s=>this.handleEvent(s)),i.addEventListener("mouseup",s=>this.handleEvent(s)),i.addEventListener("mousemove",s=>this.handleEvent(s)),i.addEventListener("contextmenu",s=>this.handleEvent(s)),i.addEventListener("touchstart",s=>this.handleTouchEvent(s)),i.addEventListener("touchend",s=>this.handleTouchEvent(s)),i.addEventListener("touchcancel",s=>this.handleTouchEvent(s)),i.addEventListener("touchmove",s=>this.handleTouchEvent(s)),i.addEventListener("wheel",s=>this.handleWheelEvent(s))}handleTouchEvent(t){if(t.stopPropagation(),t.preventDefault(),t.touches.length>0){const i=t.touches[0];this.updatePosition(i.clientX,i.clientY),this.buttons[0].setDown(!0)}else this.buttons[0].setDown(!1)}handleEvent(t){t.stopPropagation(),t.preventDefault(),this.updatePosition(t.clientX,t.clientY),t.type==="mousedown"&&(this.buttons[t.button].setDown(!0),this.el.focus()),t.type==="mouseup"&&this.buttons[t.button].setDown(!1)}handleWheelEvent(t){t.stopPropagation(),t.preventDefault(),this.wheelDeltaX=t.deltaX,this.wheelDeltaY=t.deltaY}updatePosition(t,i){let s=this.el.getBoundingClientRect();const r=this.width/this.height,n=s.width/s.height;if(n-r>.01){const o=r*s.height,h=s.width-o;s=new B(Math.floor(h/2),0,o,s.height)}if(n-r<-.01){const o=s.width/r,h=s.height-o;s=new B(0,Math.floor(h/2),s.width,o)}this.x=this.width*(t-s.left)/s.width|0,this.y=this.height*(i-s.top)/s.height|0}update(t){this.dx=this.x-this.prevX,this.dy=this.y-this.prevY,this.prevX=this.x,this.prevY=this.y;for(let i=0;i<this.buttons.length;i++)this.buttons[i].update(t)}}const rt=[-1,0,1,-1,1,-1,0,1],wt=[-1,-1,-1,0,0,1,1,1],Bt=[1.4,1,1.4,1,1,1.4,1,1.4];let H=0;function St(e,t,i,s){H++;const r=e.grid[t.y][t.x];r.pathId=H,r.g=0,r.h=Math.hypot(t.x-i.x,t.y-i.y),r.prev=null;const n=new Ut([r]);for(;n.size()>0;){const o=n.pop();if(o.x===i.x&&o.y===i.y)return It(o);for(let h=0;h<rt.length;h++){const l=o.x+rt[h],a=o.y+wt[h];if(l>=0&&l<e.width&&a>=0&&a<e.height){const c=e.grid[a][l];if(c.blocked&&c.explored&&(l!==i.x||a!==i.y))continue;c.pathId!==H&&(c.pathId=H,c.g=1/0,c.h=Math.hypot(l-i.x,a-i.y),c.prev=null);const u=o.g+Bt[h];u<c.g&&u<=s&&(c.g=u,c.prev=o,n.insert(c))}}}}function It(e){const t=[];let i=e;for(;i;)t.push(i),i=i.prev;return t.reverse(),t}class Ut{constructor(t){this.values=t}insert(t){const i=this.values;let s=0,r=i.length,n=0;for(;s<r;){const o=s+r>>>1,h=i[o];h.g+h.h>t.g+t.h?(s=o+1,n=s):(r=o,n=r)}i.splice(n,0,t)}pop(){return this.values.pop()}size(){return this.values.length}}class Vt{constructor(t){this.m=2147483648,this.a=1103515245,this.c=12345,this.state=t||1}nextInt(){return this.state=(this.a*this.state+this.c)%this.m,this.state}nextFloat(){return this.nextInt()/(this.m-1)}nextRange(t,i){const s=i-t,r=this.nextInt()/this.m,n=t+(r*s|0);if(isNaN(n))throw new Error("rand nan");return n}chooseIndex(t){const i=t.reduce((n,o)=>n+o),s=this.nextRange(1,i+1);let r=0;for(let n=0;n<t.length;n++)if(r+=t[n],s<=r)return n;return t.length-1}chooseKey(t){const i=Object.keys(t),s=i.map(r=>t[r]);return i[this.chooseIndex(s)]}}const bt=`#version 300 es
precision highp float;in vec2 a;in vec2 b;in vec3 c;in vec3 d;out vec2 e;out vec4 f;out vec4 g;void main(void){gl_Position=vec4(a.x,a.y,0,1);e=b/16.0;f=vec4(c.r,c.g,c.b,1);g=vec4(d.r,d.g,d.b,1);}`,Pt=`#version 300 es
precision highp float;in vec2 e;in vec4 f;in vec4 g;uniform bool h;uniform sampler2D s;out vec4 o;void main(void){o=texture(s,e);if(h){if(o.a<0.1){o=texture(s,g.rg*16.0+fract(e*16.0)/16.0);}}else{if(o.r<0.1) {o=g;} else {o=f;}}}`;function x(e,t){return-1+2*(e/t)}const Ht={font:ht};class Mt extends y{constructor(t,i,s,r){super(i,s),r=r||Ht,this.canvas=t,this.font=r.font||ht,this.pixelWidth=i*this.font.charWidth,this.pixelHeight=s*this.font.charHeight,t.width=this.pixelWidth,t.height=this.pixelHeight,t.style.imageRendering="pixelated",t.style.outline="none",t.tabIndex=0,this.handleResize(),window.addEventListener("resize",()=>this.handleResize()),this.keys=new Nt(t),this.mouse=new mt(this);const n=t.getContext("webgl2",{antialias:!1});if(!n)throw new Error("Unable to initialize WebGL. Your browser may not support it.");const o=n.createProgram();if(!o)throw new Error("Unable to initialize WebGL. Your browser may not support it.");this.gl=n,this.program=o,n.attachShader(o,this.buildShader(n.VERTEX_SHADER,bt)),n.attachShader(o,this.buildShader(n.FRAGMENT_SHADER,Pt)),n.linkProgram(o),n.useProgram(o),this.font.graphical&&n.uniform1i(n.getUniformLocation(o,"h"),1),this.positionAttribLocation=this.getAttribLocation("a"),this.textureAttribLocation=this.getAttribLocation("b"),this.fgColorAttribLocation=this.getAttribLocation("c"),this.bgColorAttribLocation=this.getAttribLocation("d");const h=i*s;this.positionsArray=new Float32Array(h*3*4),this.indexArray=new Uint16Array(h*6),this.textureArray=new Float32Array(h*2*4),this.foregroundUint8Array=new Uint8Array(h*4*4),this.foregroundDataView=new DataView(this.foregroundUint8Array.buffer),this.backgroundUint8Array=new Uint8Array(h*4*4),this.backgroundDataView=new DataView(this.backgroundUint8Array.buffer);let l=0,a=0,c=0;for(let u=0;u<s;u++)for(let f=0;f<i;f++)this.positionsArray[l++]=x(f,i),this.positionsArray[l++]=-x(u,s),this.positionsArray[l++]=x(f+1,i),this.positionsArray[l++]=-x(u,s),this.positionsArray[l++]=x(f+1,i),this.positionsArray[l++]=-x(u+1,s),this.positionsArray[l++]=x(f,i),this.positionsArray[l++]=-x(u+1,s),this.indexArray[a++]=c+0,this.indexArray[a++]=c+1,this.indexArray[a++]=c+2,this.indexArray[a++]=c+0,this.indexArray[a++]=c+2,this.indexArray[a++]=c+3,c+=4;this.positionBuffer=n.createBuffer(),this.indexBuffer=n.createBuffer(),this.textureBuffer=n.createBuffer(),this.foregroundBuffer=n.createBuffer(),this.backgroundBuffer=n.createBuffer(),n.bindBuffer(n.ARRAY_BUFFER,this.positionBuffer),n.bufferData(n.ARRAY_BUFFER,this.positionsArray,n.STATIC_DRAW),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,this.indexBuffer),n.bufferData(n.ELEMENT_ARRAY_BUFFER,this.indexArray,n.STATIC_DRAW),this.texture=this.loadTexture(this.font.url),this.lastRenderTime=0,this.renderDelta=0,this.fps=0,this.averageFps=0,this.requestAnimationFrame()}handleResize(){const t=this.canvas.parentElement;if(!t)return;const i=t.offsetWidth/this.pixelWidth,s=t.offsetHeight/this.pixelHeight,r=Math.min(i,s),n=r*this.pixelWidth|0,o=r*this.pixelHeight|0;this.canvas.style.width=n+"px",this.canvas.style.height=o+"px"}getAttribLocation(t){const i=this.gl.getAttribLocation(this.program,t);return this.gl.enableVertexAttribArray(i),i}flush(){let t=0,i=0;for(let s=0;s<this.height;s++)for(let r=0;r<this.width;r++){const n=this.getCell(r,s);if(!n.dirty){t+=8,i+=16;continue}const o=n.charCode%16,h=n.charCode/16|0;this.textureArray[t++]=o,this.textureArray[t++]=h,this.textureArray[t++]=o+1,this.textureArray[t++]=h,this.textureArray[t++]=o+1,this.textureArray[t++]=h+1,this.textureArray[t++]=o,this.textureArray[t++]=h+1;for(let l=0;l<4;l++)this.foregroundDataView.setUint32(i,n.fg,!1),this.backgroundDataView.setUint32(i,n.bg,!1),i+=4;n.dirty=!1}}isKeyDown(t){return this.keys.getKey(t).down}isKeyPressed(t){return this.keys.getKey(t).isPressed()}getKeyDownCount(t){return this.keys.getKey(t).downCount}getMovementKey(){if(this.isKeyPressed(d.VK_NUMPAD1)||this.isKeyPressed(d.VK_B))return new D(-1,1);if(this.isKeyPressed(d.VK_NUMPAD2)||this.isKeyPressed(d.VK_J)||this.isKeyPressed(d.VK_DOWN))return new D(0,1);if(this.isKeyPressed(d.VK_NUMPAD3)||this.isKeyPressed(d.VK_N))return new D(1,1);if(this.isKeyPressed(d.VK_NUMPAD4)||this.isKeyPressed(d.VK_H)||this.isKeyPressed(d.VK_LEFT))return new D(-1,0);if(this.isKeyPressed(d.VK_NUMPAD5)||this.isKeyPressed(d.VK_PERIOD))return new D(0,0);if(this.isKeyPressed(d.VK_NUMPAD6)||this.isKeyPressed(d.VK_L)||this.isKeyPressed(d.VK_RIGHT))return new D(1,0);if(this.isKeyPressed(d.VK_NUMPAD7)||this.isKeyPressed(d.VK_Y))return new D(-1,-1);if(this.isKeyPressed(d.VK_NUMPAD8)||this.isKeyPressed(d.VK_K)||this.isKeyPressed(d.VK_UP))return new D(0,-1);if(this.isKeyPressed(d.VK_NUMPAD9)||this.isKeyPressed(d.VK_U))return new D(1,-1)}buildShader(t,i){const s=this.gl,r=s.createShader(t);if(!r)throw new Error("An error occurred compiling the shader: ");if(s.shaderSource(r,i),s.compileShader(r),!s.getShaderParameter(r,s.COMPILE_STATUS))throw new Error("An error occurred compiling the shader: "+s.getShaderInfoLog(r));return r}loadTexture(t){const i=this.gl,s=i.createTexture();i.bindTexture(i.TEXTURE_2D,s);const r=0,n=i.RGBA,o=1,h=1,l=0,a=i.RGBA,c=i.UNSIGNED_BYTE,u=new Uint8Array([0,0,0,255]);i.texImage2D(i.TEXTURE_2D,r,n,o,h,l,a,c,u);const f=new Image;return f.onload=()=>{i.bindTexture(i.TEXTURE_2D,s),i.texImage2D(i.TEXTURE_2D,r,n,a,c,f),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR)},f.src=t,s}render(){const t=this.gl;t.clearColor(0,0,0,1),t.clearDepth(1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),t.viewport(0,0,this.pixelWidth,this.pixelHeight);{const s=t.FLOAT,r=!1,n=0,o=0;t.bindBuffer(t.ARRAY_BUFFER,this.positionBuffer),t.vertexAttribPointer(this.positionAttribLocation,2,s,r,n,o)}{const s=t.FLOAT,r=!1,n=0,o=0;t.bindBuffer(t.ARRAY_BUFFER,this.textureBuffer),t.bufferData(t.ARRAY_BUFFER,this.textureArray,t.DYNAMIC_DRAW),t.vertexAttribPointer(this.textureAttribLocation,2,s,r,n,o)}{const s=t.UNSIGNED_BYTE,r=!0,n=0,o=0;t.bindBuffer(t.ARRAY_BUFFER,this.foregroundBuffer),t.bufferData(t.ARRAY_BUFFER,this.foregroundUint8Array,t.DYNAMIC_DRAW),t.vertexAttribPointer(this.fgColorAttribLocation,4,s,r,n,o)}{const s=t.UNSIGNED_BYTE,r=!0,n=0,o=0;t.bindBuffer(t.ARRAY_BUFFER,this.backgroundBuffer),t.bufferData(t.ARRAY_BUFFER,this.backgroundUint8Array,t.DYNAMIC_DRAW),t.vertexAttribPointer(this.bgColorAttribLocation,4,s,r,n,o)}t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.indexBuffer),t.useProgram(this.program),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this.texture);{const i=this.width*this.height*6,s=t.UNSIGNED_SHORT,r=0;t.drawElements(t.TRIANGLES,i,s,r)}}requestAnimationFrame(){window.requestAnimationFrame(t=>this.renderLoop(t))}renderLoop(t){this.lastRenderTime===0?(this.lastRenderTime=t,this.fps=0):(this.renderDelta=t-this.lastRenderTime,this.lastRenderTime=t,this.fps=1e3/this.renderDelta,this.averageFps=.95*this.averageFps+.05*this.fps),this.keys.updateKeys(t),this.mouse.update(t),this.update&&this.update(),this.flush(),this.render(),this.requestAnimationFrame()}}const G=_(255,255,255);_(0,0,0);const yt=_(224,224,224),Kt=_(255,192,192),vt=_(255,48,48),Ct=_(255,160,48),Ft=_(32,160,255),X=G,Gt=_(0,96,0),Xt=_(64,16,16);var Yt=Object.defineProperty,Wt=Object.getOwnPropertyDescriptor,kt=(e,t,i,s)=>{for(var r=s>1?void 0:s?Wt(t,i):t,n=e.length-1,o;n>=0;n--)(o=e[n])&&(r=(s?o(t,i,r):o(r))||r);return s&&r&&Yt(t,i,r),r};const nt={CORPSE:0,ITEM:1,ACTOR:2};let W=class{constructor(e,t,i,s,r,n=!1,o=0){this.x=e,this.y=t,this.char=i,this.color=s,this.name=r,this.blocks=n,this.renderOrder=o}spawn(e,t,i){const s=dt(ft(this));return s.x=t,s.y=i,e.entities.push(s),s}move(e,t){this.x+=e,this.y+=t}};W=kt([L],W);var jt=Object.defineProperty,zt=Object.getOwnPropertyDescriptor,Qt=(e,t,i,s)=>{for(var r=s>1?void 0:s?zt(t,i):t,n=e.length-1,o;n>=0;n--)(o=e[n])&&(r=(s?o(t,i,r):o(r))||r);return s&&r&&jt(t,i,r),r};let S=class extends W{constructor(e,t,i,s,r,n,o,h,l,a,c){super(e,t,i,s,r,n),this.maxHp=o,this.hp_=h,this.defense=l,this.power=a,this.ai=c,this.renderOrder=nt.ACTOR}get hp(){return this.hp_}addHp(e,t){this.hp_=Math.max(0,Math.min(this.hp_+t,this.maxHp)),this.hp_===0&&this.die(e)}die(e){this===e.player?e.log("You died!",vt):e.log(`${$(this.name)} is dead!`,Ct),this.char="%",this.color=_(191,0,0),this.blocks=!1,this.ai=void 0,this.name="remains of "+this.name,this.renderOrder=nt.CORPSE}};S=Qt([L],S);var Zt=Object.defineProperty,$t=Object.getOwnPropertyDescriptor,J=(e,t,i,s)=>{for(var r=s>1?void 0:s?$t(t,i):t,n=e.length-1,o;n>=0;n--)(o=e[n])&&(r=(s?o(t,i,r):o(r))||r);return s&&r&&Zt(t,i,r),r};class Jt{constructor(t){this.actor=t}}class q extends Jt{constructor(t,i,s){super(t),this.dx=i,this.dy=s}}let v=class extends q{perform(e){const t=this.actor.x+this.dx,i=this.actor.y+this.dy,s=e.gameMap.getActor(t,i);if(!s)return;const r=this.actor.power-s.defense,n=$(this.actor.name)+" attacks "+s.name,o=this.actor===e.player?yt:Kt;r>0?(e.log(n+" for "+r+" hit points!",o),s.addHp(e,-r)):console.log(n+" but does no damage.",o)}};v=J([L],v);let C=class extends q{perform(e){const t=this.actor.x+this.dx,i=this.actor.y+this.dy;e.gameMap.isWall(t,i)||e.gameMap.getBlockingEntity(t,i)||this.actor.move(this.dx,this.dy)}};C=J([L],C);let k=class extends q{perform(e){if(this.dx===0&&this.dy===0)return;const t=this.actor.x+this.dx,i=this.actor.y+this.dy;return e.gameMap.getActor(t,i)?new v(this.actor,this.dx,this.dy).perform(e):new C(this.actor,this.dx,this.dy).perform(e)}};k=J([L],k);var qt=Object.defineProperty,te=Object.getOwnPropertyDescriptor,ee=(e,t,i,s)=>{for(var r=s>1?void 0:s?te(t,i):t,n=e.length-1,o;n>=0;n--)(o=e[n])&&(r=(s?o(t,i,r):o(r))||r);return s&&r&&qt(t,i,r),r};let j=class{constructor(){P(this,"messages",[])}add(e,t=G){this.messages.push(new K(e,t))}render(e,t,i,s,r){let n=r-1;for(let o=this.messages.length-1;o>=0&&n>=0;o--){const h=this.messages[o],l=ot(h.text,s).reverse();for(const a of l)e.drawString(t,i+n,a,h.fg),n--}}};j=ee([L],j);function ie(e,t,i,s){const r=Math.round(t/i*s);e.fillRect(0,40,s,1," ",X,Xt),e.fillRect(0,40,r,1," ",X,Gt),e.drawString(0,40,`HP: ${t}/${i}`,X)}function se(e,t,i,s){e.drawString(21,39,$(t.entities.filter(r=>r.x===i&&r.y===s).map(r=>r.name).join(", ")),G)}var re=Object.defineProperty,ne=Object.getOwnPropertyDescriptor,oe=(e,t,i,s)=>{for(var r=s>1?void 0:s?ne(t,i):t,n=e.length-1,o;n>=0;n--)(o=e[n])&&(r=(s?o(t,i,r):o(r))||r);return s&&r&&re(t,i,r),r};let z=class{constructor(e,t){P(this,"messageLog",new j);this.player=e,this.gameMap=t,this.updateFov()}log(e,t=G){this.messageLog.add(e,t)}handleEnemyTurns(){this.gameMap.actors.forEach(e=>{var t;return(t=e.ai)==null?void 0:t.perform(this,e)})}handleEvents(e){let t;if(this.player.hp>0){const i=e.getMovementKey();i&&(t=new k(this.player,i.x,i.y))}t&&(t.perform(this),this.handleEnemyTurns(),this.updateFov())}updateFov(){this.gameMap.updateFov(this.player.x,this.player.y)}render(e){e.clear(),this.gameMap.render(e),this.messageLog.render(e,21,40,40,5),ie(e,this.player.hp,this.player.maxHp,20),se(e,this.gameMap,e.mouse.x,e.mouse.y)}};z=oe([L],z);var he=Object.defineProperty,le=Object.getOwnPropertyDescriptor,ae=(e,t,i,s)=>{for(var r=s>1?void 0:s?le(t,i):t,n=e.length-1,o;n>=0;n--)(o=e[n])&&(r=(s?o(t,i,r):o(r))||r);return s&&r&&he(t,i,r),r};class ce{walkToward(t,i,s){const r=t.gameMap.computePath(i,s);if(r){const n=r[1],o=n.x-i.x,h=n.y-i.y;new C(i,o,h).perform(t)}}}let F=class extends ce{perform(e,t){const i=e.player,s=i.x-t.x,r=i.y-t.y,n=Math.max(Math.abs(s),Math.abs(r));if(!!e.gameMap.isVisible(t.x,t.y)){if(n<=1){new v(t,s,r).perform(e);return}this.walkToward(e,t,i)}}};F=ae([L],F);const _e=new S(0,0,"o",_(63,127,63),"orc",!0,10,10,0,3,new F),fe=new S(0,0,"T",_(0,127,0),"troll",!0,16,16,1,4,new F),de=new V(0,0," ",N.WHITE,N.LIGHT_BLUE),ue=new V(0,0," ",N.WHITE,N.DARK_BLUE);var Ae=Object.defineProperty,Ee=Object.getOwnPropertyDescriptor,Oe=(e,t,i,s)=>{for(var r=s>1?void 0:s?Ee(t,i):t,n=e.length-1,o;n>=0;n--)(o=e[n])&&(r=(s?o(t,i,r):o(r))||r);return s&&r&&Ae(t,i,r),r};const Te=_(0,0,100),ge=_(130,110,50),pe=_(50,50,150),Le=_(200,180,50);let Q=class{constructor(e,t,i){P(this,"console");this.width=e,this.height=t,this.entities=i,this.console=new y(e,t);for(let s=0;s<t;s++)for(let r=0;r<e;r++)this.makeWall(r,s)}get actors(){return this.entities.filter(e=>e instanceof S&&e.blocks)}createRoom(e){for(let t=e.y+1;t<e.y2;t++)for(let i=e.x+1;i<e.x2;i++)this.makeFloor(i,t)}createHTunnel(e,t,i){for(let s=Math.min(e,t);s<=Math.max(e,t);s++)this.makeFloor(s,i)}createVTunnel(e,t,i){for(let s=Math.min(e,t);s<=Math.max(e,t);s++)this.makeFloor(i,s)}updateFov(e,t){this.console.computeFov(e,t,8),this.console.updateExplored()}isVisible(e,t){return this.console.isVisible(e,t)}isWall(e,t){return this.console.isBlocked(e,t)}getBlockingEntity(e,t){return this.entities.find(i=>i.blocks&&i.x===e&&i.y===t)}getActor(e,t){return this.actors.find(i=>i.x===e&&i.y===t)}computePath(e,t){return St(this.console,e,t,1e3)}render(e){for(let t=0;t<this.height;t++)for(let i=0;i<this.width;i++){const s=this.isVisible(i,t),r=this.console.grid[t][i].blockedSight;let n=N.BLACK;s?n=r?ge:Le:this.console.grid[t][i].explored&&(n=r?Te:pe),e.drawChar(i,t,0,0,n)}this.entities.sort((t,i)=>t.renderOrder-i.renderOrder);for(const t of this.entities)this.isVisible(t.x,t.y)&&e.drawChar(t.x,t.y,t.char,t.color)}makeWall(e,t){this.console.drawCell(e,t,ue),this.console.setBlocked(e,t,!0),this.console.setBlockedSight(e,t,!0)}makeFloor(e,t){this.console.drawCell(e,t,de),this.console.setBlocked(e,t,!1),this.console.setBlockedSight(e,t,!1)}};Q=Oe([L],Q);function De(e,t,i,s,r,n,o){const h=new Q(s,r,[o]),l=new Vt,a=[];for(let c=0;c<e;c++){const u=l.nextRange(t,i),f=l.nextRange(t,i),g=l.nextRange(0,s-u-1),R=l.nextRange(0,r-f-1),p=new B(g,R,u,f);if(a.some(E=>E.intersects(p)))continue;h.createRoom(p);const O=p.getCenter();if(a.length===0)o.x=O.x,o.y=O.y;else{const E=a[a.length-1].getCenter();l.nextRange(0,1)===1?(h.createHTunnel(E.x,O.x,E.y),h.createVTunnel(E.y,O.y,O.x)):(h.createVTunnel(E.y,O.y,E.x),h.createHTunnel(E.x,O.x,O.y))}Re(l,p,h,n),a.push(p)}return h}function Re(e,t,i,s){const r=e.nextRange(0,s);for(let n=0;n<r;n++){const o=e.nextRange(t.x+1,t.x2-1),h=e.nextRange(t.y+1,t.y2-1);i.getBlockingEntity(o,h)||(e.nextFloat()<.8?_e.spawn(i,o,h):fe.spawn(i,o,h))}}const tt=80,et=45,Ne=tt,xe=et-7,me=10,we=6,Be=30,Se=2,I=new Mt(document.querySelector("canvas"),tt,et),Y=new pt(I),lt=new S(40,20,"@",N.WHITE,"Player",!0,30,30,2,5),Ie=De(Be,we,me,Ne,xe,Se,lt),M=new z(lt,Ie);M.log("Hello and welcome, adventurer, to yet another dungeon!",Ft);I.update=()=>{Y.handleInput()||(I.isKeyPressed(d.VK_V)?Y.add(new xt(new B(2,2,tt-4,et-4),"Message Log",new K(void 0,void 0,void 0,M.messageLog.messages))):M.handleEvents(I)),M.render(I),Y.draw()};
