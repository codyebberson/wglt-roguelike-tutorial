var Bt=Object.defineProperty;var Ut=(e,t,s)=>t in e?Bt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s;var w=(e,t,s)=>(Ut(e,typeof t!="symbol"?t+"":t,s),s);const yt=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function s(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerpolicy&&(r.referrerPolicy=n.referrerpolicy),n.crossorigin==="use-credentials"?r.credentials="include":n.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(n){if(n.ep)return;n.ep=!0;const r=s(n);fetch(n.href,r)}};yt();var S;(function(e){e[e.None=0]="None",e[e.Blend=1]="Blend",e[e.Add=2]="Add"})(S||(S={}));function M(e,t,s,i){var n=arguments.length,r=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,s):i,o;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")r=Reflect.decorate(e,t,s,i);else for(var h=e.length-1;h>=0;h--)(o=e[h])&&(r=(n<3?o(r):n>3?o(t,s,r):o(t,s))||r);return n>3&&r&&Object.defineProperty(t,s,r),r}function d(e,t,s,i){return i===void 0&&(i=255),(e<<24)+(t<<16)+(s<<8)+i}const x={BLACK:d(0,0,0),WHITE:d(255,255,255),LIGHT_GRAY:d(170,170,170),DARK_GRAY:d(85,85,85),YELLOW:d(255,255,85),BROWN:d(170,85,0),LIGHT_RED:d(255,85,85),DARK_RED:d(170,0,0),LIGHT_GREEN:d(85,255,85),DARK_GREEN:d(0,170,0),LIGHT_CYAN:d(85,255,255),DARK_CYAN:d(0,170,170),LIGHT_BLUE:d(85,85,255),DARK_BLUE:d(0,0,170),LIGHT_MAGENTA:d(255,85,255),DARK_MAGENTA:d(170,0,170),ORANGE:d(255,136,0)},ct=new Map;function p(e){ct.set(e.name,e)}function Vt(e){const t=[],s=new WeakMap,i=n(e);return JSON.stringify({instances:t,root:i});function n(a){return Array.isArray(a)?r(a):a&&typeof a=="object"?o(a):a}function r(a){const c=[];for(let l=0;l<a.length;l++)c[l]=n(a[l]);return c}function o(a){if(a&&a.constructor.name&&a.constructor.name!=="Object"){if(!ct.has(a.constructor.name))throw new Error(`Class ${a.constructor.name} is not serializable.`);if(s.has(a))return{$ref:s.get(a)};const c=t.length;return t.push({$type:a.constructor.name}),s.set(a,c),t[c]=Object.assign(Object.assign({},h(a)),{$type:a.constructor.name}),{$ref:c}}return h(a)}function h(a){const c={};for(const l of Object.keys(a))c[l]=n(a[l]);return c}}function Ht(e){const t=JSON.parse(e),s=t.instances;for(let h=0;h<s.length;h++){const a=s[h],c=ct.get(a.$type);delete a.$type,s[h]=Object.create(c.prototype,Object.getOwnPropertyDescriptors(a))}for(let h=0;h<s.length;h++)o(s[h]);return i(t.root);function i(h){return Array.isArray(h)?n(h):h&&typeof h=="object"?r(h):h}function n(h){for(let a=0;a<h.length;a++)h[a]=i(h[a]);return h}function r(h){return Pt(h)?s[h.$ref]:(o(h),h)}function o(h){for(const[a,c]of Object.entries(h))h[a]=i(c)}}function Pt(e){return!!(e&&typeof e=="object"&&"$ref"in e)}function vt(e){return typeof e=="string"&&e.length>0?e.charCodeAt(0):e}let P=class{constructor(t,s,i,n,r){this.x=t,this.y=s,i!==void 0?this.charCode=vt(i):this.charCode=" ".charCodeAt(0),n!==void 0?this.fg=n:this.fg=x.WHITE,r!==void 0?this.bg=r:this.bg=x.BLACK,this.dirty=!0,this.blocked=!1,this.blockedSight=!1,this.explored=!1,this.visible=!1,this.pathId=-1,this.g=0,this.h=0,this.prev=null}setCharCode(t){this.charCode!==t&&(this.charCode=t,this.dirty=!0)}setForeground(t){t!=null&&t!==this.fg&&(this.fg=t,this.dirty=!0)}setBackground(t){t!=null&&t!==this.bg&&(this.bg=t,this.dirty=!0)}setValue(t,s,i){return typeof t=="string"&&(t=t.charCodeAt(0)),typeof t=="number"?(this.setCharCode(t),s!==void 0&&this.setForeground(s),i!==void 0&&this.setBackground(i)):this.drawCell(t,S.None),this.dirty}drawCell(t,s){const i=t.bg&255;s===S.None||t.charCode>0?(this.setCharCode(t.charCode),this.setForeground(t.fg)):i>0&&i<255&&this.setForeground(this.blendColors(this.fg,t.bg,s)),s===S.None||i===255?this.setBackground(t.bg):i>0&&this.setBackground(this.blendColors(this.bg,t.bg,s))}blendColors(t,s,i){const n=s&255,r=(255-n)/255,o=1-r,h=t>>24&255,a=t>>16&255,c=t>>8&255,l=s>>24&255,u=s>>16&255,f=s>>8&255;switch(i){case S.Blend:return d(r*h+o*l|0,r*a+o*u|0,r*c+o*f|0);case S.Add:return d(this.clamp(h+o*l|0),this.clamp(a+o*u|0),this.clamp(c+o*f|0));default:return s}}clamp(t){return Math.min(255,t)}};P=M([p],P);var O;(function(e){e[e.SMILEY=1]="SMILEY",e[e.INVERSE_SMILEY=2]="INVERSE_SMILEY",e[e.HEART=3]="HEART",e[e.DIAMOND=4]="DIAMOND",e[e.CLUB=5]="CLUB",e[e.SPADE=6]="SPADE",e[e.BULLET=7]="BULLET",e[e.INVERSE_BULLET=8]="INVERSE_BULLET",e[e.LIGHT_SHADE=176]="LIGHT_SHADE",e[e.MEDIUM_SHADE=177]="MEDIUM_SHADE",e[e.DARK_SHADE=178]="DARK_SHADE",e[e.BOX_SINGLE_VERTICAL=179]="BOX_SINGLE_VERTICAL",e[e.BOX_SINGLE_VERTICAL_AND_SINGLE_LEFT=180]="BOX_SINGLE_VERTICAL_AND_SINGLE_LEFT",e[e.BOX_DOUBLE_VERTICAL_AND_DOUBLE_LEFT=185]="BOX_DOUBLE_VERTICAL_AND_DOUBLE_LEFT",e[e.BOX_DOUBLE_VERTICAL=186]="BOX_DOUBLE_VERTICAL",e[e.BOX_DOUBLE_DOWN_AND_DOUBLE_LEFT=187]="BOX_DOUBLE_DOWN_AND_DOUBLE_LEFT",e[e.BOX_DOUBLE_UP_AND_DOUBLE_LEFT=188]="BOX_DOUBLE_UP_AND_DOUBLE_LEFT",e[e.BOX_SINGLE_DOWN_AND_SINGLE_LEFT=191]="BOX_SINGLE_DOWN_AND_SINGLE_LEFT",e[e.BOX_SINGLE_UP_AND_SINGLE_RIGHT=192]="BOX_SINGLE_UP_AND_SINGLE_RIGHT",e[e.BOX_SINGLE_HORIZONTAL_AND_SINGLE_UP=193]="BOX_SINGLE_HORIZONTAL_AND_SINGLE_UP",e[e.BOX_SINGLE_HORIZONTAL_AND_SINGLE_DOWN=194]="BOX_SINGLE_HORIZONTAL_AND_SINGLE_DOWN",e[e.BOX_SINGLE_VERTICAL_AND_SINGLE_RIGHT=195]="BOX_SINGLE_VERTICAL_AND_SINGLE_RIGHT",e[e.BOX_SINGLE_HORIZONTAL=196]="BOX_SINGLE_HORIZONTAL",e[e.BOX_SINGLE_VERTICAL_AND_SINGLE_HORIZONTAL=197]="BOX_SINGLE_VERTICAL_AND_SINGLE_HORIZONTAL",e[e.BOX_DOUBLE_UP_AND_DOUBLE_RIGHT=200]="BOX_DOUBLE_UP_AND_DOUBLE_RIGHT",e[e.BOX_DOUBLE_DOWN_AND_DOUBLE_RIGHT=201]="BOX_DOUBLE_DOWN_AND_DOUBLE_RIGHT",e[e.BOX_DOUBLE_HORIZONTAL_AND_DOUBLE_UP=202]="BOX_DOUBLE_HORIZONTAL_AND_DOUBLE_UP",e[e.BOX_DOUBLE_HORIZONTAL_AND_DOUBLE_DOWN=203]="BOX_DOUBLE_HORIZONTAL_AND_DOUBLE_DOWN",e[e.BOX_DOUBLE_VERTICAL_AND_DOUBLE_RIGHT=204]="BOX_DOUBLE_VERTICAL_AND_DOUBLE_RIGHT",e[e.BOX_DOUBLE_HORIZONTAL=205]="BOX_DOUBLE_HORIZONTAL",e[e.BOX_DOUBLE_VERTICAL_AND_DOUBLE_HORIZONTAL=206]="BOX_DOUBLE_VERTICAL_AND_DOUBLE_HORIZONTAL",e[e.BOX_SINGLE_UP_AND_SINGLE_LEFT=217]="BOX_SINGLE_UP_AND_SINGLE_LEFT",e[e.BOX_SINGLE_DOWN_AND_SINGLE_RIGHT=218]="BOX_SINGLE_DOWN_AND_SINGLE_RIGHT",e[e.BLOCK_FULL=219]="BLOCK_FULL",e[e.BLOCK_BOTTOM_HALF=220]="BLOCK_BOTTOM_HALF",e[e.BLOCK_LEFT_HALF=221]="BLOCK_LEFT_HALF",e[e.BLOCK_RIGHT_HALF=222]="BLOCK_RIGHT_HALF",e[e.BLOCK_TOP_HALF=223]="BLOCK_TOP_HALF"})(O||(O={}));function pt(e,t){const s=new RegExp("(\\S(.{0,"+t+"}\\S)?)\\s+","g");return(e+" ").replace(s,`$1
`).trim().split(`
`).map(i=>i.trim())}function lt(e){return e&&e.charAt(0).toUpperCase()+e.slice(1)}let X=class{constructor(t,s,i){this.width=t,this.height=s,this.grid=[],this.originX=0,this.originY=0,this.minX=0,this.maxX=0,this.minY=0,this.maxY=0,this.radius=0;for(let n=0;n<s;n++){const r=[];for(let o=0;o<t;o++)r.push(new P(o,n));this.grid.push(r)}if(this.clear(),i)for(let n=0;n<s;n++)for(let r=0;r<t;r++)this.grid[n][r].blocked=this.grid[n][r].blockedSight=i(r,n)}clear(){for(let t=0;t<this.height;t++)for(let s=0;s<this.width;s++)this.drawChar(s,t,0)}getCell(t,s){if(!(t<0||s<0||t>=this.width||s>=this.height))return this.grid[s][t]}getCharCode(t,s){if(!(t<0||s<0||t>=this.width||s>=this.height))return this.grid[s][t].charCode}drawChar(t,s,i,n,r){this.clip&&!this.clip.contains({x:t,y:s})||t>=0&&t<this.width&&s>=0&&s<this.height&&this.grid[s|0][t|0].setValue(i,n,r)}drawString(t,s,i,n,r){const o=i.split(`
`);for(let h=0;h<o.length;h++)this.drawStringLine(t,s+h,o[h],n,r)}drawStringLine(t,s,i,n,r){for(let o=0;o<i.length;o++)this.drawChar(t+o,s,i.charCodeAt(o),n,r)}drawCenteredString(t,s,i,n,r){this.drawString(t-Math.floor(i.length/2),s,i,n,r)}drawMessage(t,s,i,n){if(i.text){const r=pt(i.text,n||this.width-t);for(const o of r)this.drawStringLine(t,s,o,i.fg,i.bg),s++}if(i.children)for(const r of i.children)s=this.drawMessage(t,s,r,n);return s}drawHLine(t,s,i,n,r,o){for(let h=t;h<t+i;h++)this.drawChar(h,s,n,r,o)}drawVLine(t,s,i,n,r,o){for(let h=s;h<s+i;h++)this.drawChar(t,h,n,r,o)}drawRect(t,s,i,n,r,o,h){this.drawHLine(t,s,i,r,o,h),this.drawHLine(t,s+n-1,i,r,o,h),this.drawVLine(t,s,n,r,o,h),this.drawVLine(t+i-1,s,n,r,o,h)}drawBox(t,s,i,n,r,o,h,a,c,l,u,f,A,L){this.drawHLine(t,s,i,r,A,L),this.drawHLine(t,s+n-1,i,h,A,L),this.drawVLine(t,s,n,a,A,L),this.drawVLine(t+i-1,s,n,o,A,L),this.drawChar(t,s,c,A,L),this.drawChar(t+i-1,s,l,A,L),this.drawChar(t,s+n-1,f,A,L),this.drawChar(t+i-1,s+n-1,u,A,L)}drawSingleBox(t,s,i,n,r,o){this.drawBox(t,s,i,n,O.BOX_SINGLE_HORIZONTAL,O.BOX_SINGLE_VERTICAL,O.BOX_SINGLE_HORIZONTAL,O.BOX_SINGLE_VERTICAL,O.BOX_SINGLE_DOWN_AND_SINGLE_RIGHT,O.BOX_SINGLE_DOWN_AND_SINGLE_LEFT,O.BOX_SINGLE_UP_AND_SINGLE_LEFT,O.BOX_SINGLE_UP_AND_SINGLE_RIGHT,r,o)}drawDoubleBox(t,s,i,n,r,o){this.drawBox(t,s,i,n,O.BOX_DOUBLE_HORIZONTAL,O.BOX_DOUBLE_VERTICAL,O.BOX_DOUBLE_HORIZONTAL,O.BOX_DOUBLE_VERTICAL,O.BOX_DOUBLE_DOWN_AND_DOUBLE_RIGHT,O.BOX_DOUBLE_DOWN_AND_DOUBLE_LEFT,O.BOX_DOUBLE_UP_AND_DOUBLE_LEFT,O.BOX_DOUBLE_UP_AND_DOUBLE_RIGHT,r,o)}fillRect(t,s,i,n,r,o,h){for(let a=s;a<s+n;a++)this.drawHLine(t,a,i,r,o,h)}drawConsole(t,s,i,n,r,o,h,a){a=a||S.None;for(let c=0;c<h;c++)for(let l=0;l<o;l++){const u=i.getCell(n+l,r+c);u&&this.drawCell(t+l,s+c,u,a)}}drawCell(t,s,i,n){t>=0&&t<this.width&&s>=0&&s<this.height&&this.grid[s][t].drawCell(i,n)}setBlocked(t,s,i){t>=0&&t<this.width&&s>=0&&s<this.height&&(this.grid[s][t].blocked=i)}setBlockedSight(t,s,i){t>=0&&t<this.width&&s>=0&&s<this.height&&(this.grid[s][t].blockedSight=i)}isVisible(t,s){return t<this.minX||t>this.maxX||s<this.minY||s>this.maxY?!1:this.grid[s][t].visible}isBlocked(t,s){return t<0||t>this.width||s<0||s>this.height?!0:this.grid[s][t].blocked}isBlockedSight(t,s){return t<0||t>this.width||s<0||s>this.height?!0:this.grid[s][t].blockedSight}computeOctantY(t,s){const i=[],n=[];let r=1,o=0,h=0,a=0,c,l,u,f,A,L,D,T,g,m;for(l=this.originY+s;l>=this.minY&&l<=this.maxY;l+=s,h=o,++r)for(u=.5/r,m=-1,f=Math.floor(a*r+.5),c=this.originX+f*t;f<=r&&c>=this.minX&&c<=this.maxX;c+=t,++f,m=g){if(A=!0,L=!1,D=f/r,T=m,g=D+u,h>0){if(!(this.grid[l-s][c].visible&&!this.grid[l-s][c].blockedSight)&&!(this.grid[l-s][c-t].visible&&!this.grid[l-s][c-t].blockedSight))A=!1;else for(let E=0;E<h&&A;++E)if(T<=n[E]&&g>=i[E]){if(this.grid[l][c].blockedSight)if(T>=i[E]&&g<=n[E]){A=!1;break}else i[E]=Math.min(i[E],T),n[E]=Math.max(n[E],g),L=!0;else if(D>i[E]&&D<n[E]){A=!1;break}}}A&&(this.grid[l][c].visible=!0,this.grid[l][c].blockedSight&&(a>=T?a=g:L||(i[o]=T,n[o++]=g)))}}computeOctantX(t,s){const i=[],n=[];let r=1,o=0,h=0,a=0,c,l,u,f,A,L,D,T,g,m;for(c=this.originX+t;c>=this.minX&&c<=this.maxX;c+=t,h=o,++r)for(u=.5/r,m=-1,f=Math.floor(a*r+.5),l=this.originY+f*s;f<=r&&l>=this.minY&&l<=this.maxY;l+=s,++f,m=g){if(A=!0,L=!1,D=f/r,T=m,g=D+u,h>0){if(!(this.grid[l][c-t].visible&&!this.grid[l][c-t].blockedSight)&&!(this.grid[l-s][c-t].visible&&!this.grid[l-s][c-t].blockedSight))A=!1;else for(let E=0;E<h&&A;++E)if(T<=n[E]&&g>=i[E]){if(this.grid[l][c].blockedSight)if(T>=i[E]&&g<=n[E]){A=!1;break}else i[E]=Math.min(i[E],T),n[E]=Math.max(n[E],g),L=!0;else if(D>i[E]&&D<n[E]){A=!1;break}}}A&&(this.grid[l][c].visible=!0,this.grid[l][c].blockedSight&&(a>=T?a=g:L||(i[o]=T,n[o++]=g)))}}computeFov(t,s,i,n,r){if(this.originX=t,this.originY=s,this.radius=i,n)this.minX=Math.min(this.minX,Math.max(0,t-i)),this.minY=Math.min(this.minY,Math.max(0,s-i)),this.maxX=Math.max(this.maxX,Math.min(this.width-1,t+i)),this.maxY=Math.max(this.maxY,Math.min(this.height-1,s+i));else{this.minX=Math.max(0,t-i),this.minY=Math.max(0,s-i),this.maxX=Math.min(this.width-1,t+i),this.maxY=Math.min(this.height-1,s+i);for(let o=this.minY;o<=this.maxY;o++)for(let h=this.minX;h<=this.maxX;h++)this.grid[o][h].visible=!1}this.grid[s][t].visible=!0,r===void 0?(this.computeOctantY(1,1),this.computeOctantX(1,1),this.computeOctantX(1,-1),this.computeOctantY(1,-1),this.computeOctantY(-1,-1),this.computeOctantX(-1,-1),this.computeOctantX(-1,1),this.computeOctantY(-1,1)):(r&1&&this.computeOctantY(1,1),r&2&&this.computeOctantX(1,1),r&4&&this.computeOctantX(1,-1),r&8&&this.computeOctantY(1,-1),r&16&&this.computeOctantY(-1,-1),r&32&&this.computeOctantX(-1,-1),r&64&&this.computeOctantX(-1,1),r&128&&this.computeOctantY(-1,1))}updateExplored(){for(let t=this.minY;t<=this.maxY;t++)for(let s=this.minX;s<=this.maxX;s++){const i=this.grid[t][s];i.explored=i.explored||i.visible}}};X=M([p],X);class bt{constructor(t,s,i,n,r){this.url=t,this.charWidth=s,this.charHeight=i,this.scale=n||1,this.graphical=!!r}}const Mt="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACAAQMAAAD58POIAAAABlBMVEUAAAD///+l2Z/dAAAEhklEQVRIx42Sv4oUQRDGC4UzadSwwMUD8QEKlbWD4Q58B/NGpTVocKO1wXHUzMAH0AcwMTYVGg5ag0IzEXaRjdZEZKNzkKbHqtnzHypY09M9+5uvqr7pbYCuC6ftaRhgONXs30eAh0O1rYDm4IS/eH0B8GxRW2vxo396yu/fb0ZFrW1zcOXlPU/XPwK8PGjbWhVwM4KnH61912oK4+zmmHJaQotyt1kvtC2Atdo24iohPDiG/v4eICJsY3Wy8Yvr0DSIBOdxgH6v8wsriWhc8s0AtaK/GzSl1jR0nSjQnwki6FQxNFKjgzO2a7BBqucH7dL4M9z96CIhT1Fs/AgKgcA6dKCxI29DaHNwRJ4EGAU1sU0OG9rmE4SIc3A4FChACqqhJRwpxkqh9wxag4DSmEJ5DtpFwAP4GUf6lmKcFFti1BYuQp4xN8kxM2kNhjdkTOiTUeAKGvhA1rLpMbYACQzCITlTDRMbLYoEa2JWPSMRFZIupcSzMVKcEUkX+sOG+ChNX2vD8ex6k7OFHL0P1655JuPd53WAD+yTv3UrCQiuHmYBbfIxpkImuvpBQBkVb5g4XHv3JkNireG8AO9zDhBZu2z2OMZ11S5/RIlyMefMNaZ4GsCz5xcjyM6hHYEjAYEfO8Ig1rklAe9sRIeYAdwyoIBq6YIzCAKiWoifA3m3o2AzWcdYKOdY47EIf8QABCuYgIUVmdVMEYEDA0Hmo/3D6KKJbh5mxhP3UsWIE97wnEygyizOfOLi2JOJW8CeOblW9IHeKZgv4zxuzDryOmb+4aQH+MXV6e0ywdUcxqCjBWl5GpbzZduOG1QEiGXP86T7EfiJfkMQ4OO4H0yqyNC2zlziWEN7Ywuc2fQ4p5BNkS5QYXP2h5NtRJh0vCKQidtVJmCGAwDSSQpYggSxiRIyzewsgCh4xxiTPDMh5aj//l7btqkr6rQyIOtLji4lVRQwXdzvus40Y53M33fh50GZwF4ExQeMlvuTggLzSi4ElKczUO7zVtpwdyMKdqZKOWb2nDblawPxPmuMwFEWBW+jlZR1eYtS442kiBGMWCi/h1/+GAR6NYOJWiqNJXFygFtrkx5C0O3IeFGs67HhEEhmBu/BUOT+0551pXxYIF+Elpi5AKRkLl5GUbCCZddyMv621ujEBPP4vSy2fotTx3U+d3WBiFOA6VSGSB49v/M7GBX9FPrDaT2c9qr4PCpwZ7qz813R94dVFIe19v33GlMZUghQFb8BrfE7QBmgBMbrn2B3enn/y3B5+DL8UBAdnejdYdBxeV9ejwoYNTgW0Ok/gA7UG2GAzanhL0DG7q4svynwF8UwDPu7u/vD0IudzSltMtVbP+J/gUbR29oJ7Fg9s6Uy+DnpiTCOYc4cXOeXMWfsusSw7FOg9x655nax6BlecwpOQQ68WBwp+H2LMQTuOq2RUigzh2Q/R3CWARJIJG199EwOTyKBlQMznshCRGeQ5gHABAQl6M4gLEdAzVaBWMCiANdsayDCHBA/hagKYfielrJIlipKKQIA9Nf3wBloTHT6BuAx15zRNa1nAAAAAElFTkSuQmCC",Tt=new bt(Mt,8,8);var Et;(function(e){e[e.OCTANT_SOUTH_SOUTHEAST=1]="OCTANT_SOUTH_SOUTHEAST",e[e.OCTANT_EAST_SOUTHEAST=2]="OCTANT_EAST_SOUTHEAST",e[e.OCTANT_EAST_NORTHTHEAST=4]="OCTANT_EAST_NORTHTHEAST",e[e.OCTANT_NORTH_NORTHEAST=8]="OCTANT_NORTH_NORTHEAST",e[e.OCTANT_NORTH_NORTHWEST=16]="OCTANT_NORTH_NORTHWEST",e[e.OCTANT_WEST_NORTHEAST=32]="OCTANT_WEST_NORTHEAST",e[e.OCTANT_WEST_SOUTHWEST=64]="OCTANT_WEST_SOUTHWEST",e[e.OCTANT_SOUTH_SOUTHWEST=128]="OCTANT_SOUTH_SOUTHWEST"})(Et||(Et={}));var gt;(function(e){e[e.QUADRANT_SOUTHEAST=3]="QUADRANT_SOUTHEAST",e[e.QUADRANT_EAST=6]="QUADRANT_EAST",e[e.QUADRANT_NORTHEAST=12]="QUADRANT_NORTHEAST",e[e.QUADRANT_NORTH=24]="QUADRANT_NORTH",e[e.QUADRANT_NORTHWEST=48]="QUADRANT_NORTHWEST",e[e.QUADRANT_WEST=96]="QUADRANT_WEST",e[e.QUADRANT_SOUTHWEST=192]="QUADRANT_SOUTHWEST",e[e.QUADRANT_SOUTH=129]="QUADRANT_SOUTH"})(gt||(gt={}));let R=class{constructor(t,s){this.x=t,this.y=s}};R=M([p],R);let I=class{constructor(t,s,i,n){this.x=this.left=t,this.y=this.top=s,this.width=i,this.height=n,this.x2=t+i,this.y2=s+n}getCenter(){return new R(this.x+this.width/2|0,this.y+this.height/2|0)}intersects(t){return this.x<=t.x2&&this.x2>=t.x&&this.y<=t.y2&&this.y2>=t.y}contains(t){return t.x>=this.x&&t.x<this.x2&&t.y>=this.y&&t.y<this.y2}};I=M([p],I);class Kt{constructor(t,s,i){this.dialog=t,this.rect=s,this.contentsOffset=i,this.open=!1,this.count=0}}class Ct{getState(t,s){const i=s.contentsRect.width+4,n=s.contentsRect.height+4,r=(t.width-i)/2|0,o=(t.height-n)/2|0;return new Kt(s,new I(r,o,i,n),new R(r+2,o+2))}draw(t,s){const i=s.dialog,{x:n,y:r,width:o,height:h}=s.rect;t.fillRect(n,r,o,h,0,x.WHITE,x.BLACK),t.drawSingleBox(n,r,o,h),t.drawCenteredString(n+o/2|0,r," "+i.title+" "),i.drawContents(t,s.contentsOffset)}}class Ft{constructor(t,s){this.terminal=t,this.renderer=s||new Ct,this.dialogs=[]}add(t){this.dialogs.push(this.renderer.getState(this.terminal,t))}handleInput(){if(this.dialogs.length===0)return!1;const t=this.dialogs.length-1,s=this.dialogs[this.dialogs.length-1];return s.dialog.handleInput(this.terminal,s.contentsOffset)&&this.dialogs.splice(t,1),!0}draw(){for(let t=0;t<this.dialogs.length;t++)this.renderer.draw(this.terminal,this.dialogs[t])}}class Lt{constructor(t,s){this.contentsRect=t,this.title=s}}let Y=class{constructor(t,s,i,n){this.text=t,this.fg=s,this.bg=i,this.children=n}getWidth(){let t=0;if(this.text)for(const s of this.text.split(`
`))t=Math.max(t,s.length);if(this.children)for(const s of this.children)t=Math.max(t,s.getWidth());return t}getHeight(){let t=0;if(this.text&&(t+=this.text.split(`
`).length),this.children)for(const s of this.children)t+=s.getHeight();return t}};Y=M([p],Y);const Gt=200,Xt=1e3/15;class H{constructor(){this.down=!1,this.downTime=0,this.repeat=!1,this.repeatTime=0,this.downCount=0,this.upCount=100}setDown(t){this.down!==t&&(this.down=t,this.repeat=!1,this.downTime=this.repeatTime=performance.now())}update(t){this.repeat=!1,this.down?(this.downCount++,this.upCount=0,t-this.downTime>=Gt&&t-this.repeatTime>=Xt&&(this.repeat=!0,this.repeatTime=t)):(this.downCount=0,this.upCount++)}isPressed(){return this.downCount===1||this.repeat}isClicked(){return this.upCount===1}}class Yt{constructor(t){this.keys=new Map,Object.keys(_).forEach(s=>this.keys.set(s,new H)),t.addEventListener("keydown",s=>this.setKey(s,!0)),t.addEventListener("keyup",s=>this.setKey(s,!1))}setKey(t,s){const i=t.code;i!==_.VK_F11&&(t.stopPropagation(),t.preventDefault(),this.getKey(i).setDown(s))}updateKeys(t){this.keys.forEach(s=>s.update(t))}getKey(t){let s=this.keys.get(t);return s||(s=new H,this.keys.set(t,s)),s}}var _;(function(e){e.VK_CANCEL="Pause",e.VK_BACKSPACE="Backspace",e.VK_TAB="Tab",e.VK_ENTER="Enter",e.VK_SHIFT_LEFT="ShiftLeft",e.VK_SHIFT_RIGHT="ShiftLeft",e.VK_CONTROL_LEFT="ControlLeft",e.VK_CONTROL_RIGHT="ControlRight",e.VK_ALT_LEFT="AltLeft",e.VK_ALT_RIGHT="AltRight",e.VK_PAUSE="Pause",e.VK_CAPS_LOCK="CapsLock",e.VK_ESCAPE="Escape",e.VK_SPACE="Space",e.VK_PAGE_UP="PageUp",e.VK_PAGE_DOWN="PageDown",e.VK_END="End",e.VK_HOME="Home",e.VK_LEFT="ArrowLeft",e.VK_UP="ArrowUp",e.VK_RIGHT="ArrowRight",e.VK_DOWN="ArrowDown",e.VK_INSERT="Insert",e.VK_DELETE="Delete",e.VK_0="Digit0",e.VK_1="Digit1",e.VK_2="Digit2",e.VK_3="Digit3",e.VK_4="Digit4",e.VK_5="Digit5",e.VK_6="Digit6",e.VK_7="Digit7",e.VK_8="Digit8",e.VK_9="Digit9",e.VK_SEMICOLON="Semicolon",e.VK_EQUALS="Equal",e.VK_A="KeyA",e.VK_B="KeyB",e.VK_C="KeyC",e.VK_D="KeyD",e.VK_E="KeyE",e.VK_F="KeyF",e.VK_G="KeyG",e.VK_H="KeyH",e.VK_I="KeyI",e.VK_J="KeyJ",e.VK_K="KeyK",e.VK_L="KeyL",e.VK_M="KeyM",e.VK_N="KeyN",e.VK_O="KeyO",e.VK_P="KeyP",e.VK_Q="KeyQ",e.VK_R="KeyR",e.VK_S="KeyS",e.VK_T="KeyT",e.VK_U="KeyU",e.VK_V="KeyV",e.VK_W="KeyW",e.VK_X="KeyX",e.VK_Y="KeyY",e.VK_Z="KeyZ",e.VK_CONTEXT_MENU="ContextMenu",e.VK_NUMPAD0="Numpad0",e.VK_NUMPAD1="Numpad1",e.VK_NUMPAD2="Numpad2",e.VK_NUMPAD3="Numpad3",e.VK_NUMPAD4="Numpad4",e.VK_NUMPAD5="Numpad5",e.VK_NUMPAD6="Numpad6",e.VK_NUMPAD7="Numpad7",e.VK_NUMPAD8="Numpad8",e.VK_NUMPAD9="Numpad9",e.VK_NUMPAD_ENTER="NumpadEnter",e.VK_MULTIPLY="NumpadMultiply",e.VK_ADD="NumpadAdd",e.VK_SEPARATOR="NumpadDecimal",e.VK_SUBTRACT="NumpadSubtract",e.VK_DECIMAL="NumpadDecimal",e.VK_DIVIDE="NumpadDivide",e.VK_F1="F1",e.VK_F2="F2",e.VK_F3="F3",e.VK_F4="F4",e.VK_F5="F5",e.VK_F6="F6",e.VK_F7="F7",e.VK_F8="F8",e.VK_F9="F9",e.VK_F10="F10",e.VK_F11="F11",e.VK_F12="F12",e.VK_F13="F13",e.VK_F14="F14",e.VK_F15="F15",e.VK_F16="F16",e.VK_F17="F17",e.VK_F18="F18",e.VK_F19="F19",e.VK_F20="F20",e.VK_F21="F21",e.VK_F22="F22",e.VK_F23="F23",e.VK_F24="F24",e.VK_NUM_LOCK="NumLock",e.VK_SCROLL_LOCK="ScrollLock",e.VK_COMMA="Comma",e.VK_PERIOD="Period",e.VK_SLASH="Slash",e.VK_BACKQUOTE="Backquote",e.VK_OPEN_BRACKET="BracketLeft",e.VK_BACK_SLASH="Backslash",e.VK_CLOSE_BRACKET="BracketRight",e.VK_QUOTE="Quote",e.VK_META="OSLeft"})(_||(_={}));class Wt extends Lt{constructor(t,s,i){super(t,s),this.message=i,this.scrollY=0,this.messagesHeight=i.getHeight(),this.scrollMax=Math.max(1,this.messagesHeight-this.contentsRect.height),this.scrollbarHeight=this.contentsRect.height*this.contentsRect.height/(this.messagesHeight+1)}drawContents(t,s){t.clip=this.contentsRect,t.drawMessage(s.x,s.y-this.scrollY,this.message),t.clip=void 0;const i=this.scrollY/this.scrollMax*(this.contentsRect.height-this.scrollbarHeight);t.drawVLine(this.contentsRect.x+this.contentsRect.width+1,this.contentsRect.y+i,this.scrollbarHeight,O.MEDIUM_SHADE)}handleInput(t){const s=t.getMovementKey();return s&&(this.scrollY+=s.y),t.isKeyPressed(_.VK_PAGE_DOWN)&&(this.scrollY+=this.contentsRect.height),t.isKeyPressed(_.VK_PAGE_UP)&&(this.scrollY-=this.contentsRect.height),t.mouse.wheelDeltaY!==0&&(this.scrollY+=t.mouse.wheelDeltaY<0?-5:5,t.mouse.wheelDeltaY=0),this.scrollY=Math.max(0,Math.min(this.scrollMax,this.scrollY)),t.isKeyPressed(_.VK_ESCAPE)}}class mt extends Lt{constructor(t,s,i){let n=t.length;for(let h=0;h<s.length;h++)n=Math.max(n,s[h].length+4);const r=s.length,o=new I(0,0,n,r);super(o,t),this.options=s,this.callback=i,this.hoverIndex=-1}drawContents(t,s){for(let i=0;i<this.options.length;i++){const n=String.fromCharCode(65+i)+" - "+this.options[i];i===this.hoverIndex?t.drawString(s.x,s.y+i,n,x.BLACK,x.WHITE):t.drawString(s.x,s.y+i,n,x.WHITE,x.BLACK)}}handleInput(t,s){if(this.hoverIndex=-1,t.mouse.x>=s.x&&t.mouse.x<s.x+this.contentsRect.width&&t.mouse.y>=s.y&&t.mouse.y<s.y+this.contentsRect.height&&(this.hoverIndex=t.mouse.y-s.y,t.mouse.buttons[0].upCount===1))return this.callback(this.hoverIndex),!0;const i="A".charCodeAt(0);for(let n=0;n<this.options.length;n++)if(t.isKeyPressed("Key"+String.fromCharCode(i+n)))return this.callback(n),!0;return t.isKeyPressed(_.VK_ESCAPE)}isMouseOverOption(t,s,i){return t.mouse.x>=s.x&&t.mouse.x<s.x+this.contentsRect.width&&t.mouse.y===s.y+i}}O.BLOCK_TOP_HALF,O.BLOCK_RIGHT_HALF;class kt{constructor(t){this.el=t.canvas,this.width=t.width,this.height=t.height,this.prevX=0,this.prevY=0,this.x=0,this.y=0,this.dx=0,this.dy=0,this.wheelDeltaX=0,this.wheelDeltaY=0,this.buttons=[new H,new H,new H];const s=this.el;s.addEventListener("mousedown",i=>this.handleEvent(i)),s.addEventListener("mouseup",i=>this.handleEvent(i)),s.addEventListener("mousemove",i=>this.handleEvent(i)),s.addEventListener("contextmenu",i=>this.handleEvent(i)),s.addEventListener("touchstart",i=>this.handleTouchEvent(i)),s.addEventListener("touchend",i=>this.handleTouchEvent(i)),s.addEventListener("touchcancel",i=>this.handleTouchEvent(i)),s.addEventListener("touchmove",i=>this.handleTouchEvent(i)),s.addEventListener("wheel",i=>this.handleWheelEvent(i))}handleTouchEvent(t){if(t.stopPropagation(),t.preventDefault(),t.touches.length>0){const s=t.touches[0];this.updatePosition(s.clientX,s.clientY),this.buttons[0].setDown(!0)}else this.buttons[0].setDown(!1)}handleEvent(t){t.stopPropagation(),t.preventDefault(),this.updatePosition(t.clientX,t.clientY),t.type==="mousedown"&&(this.buttons[t.button].setDown(!0),this.el.focus()),t.type==="mouseup"&&this.buttons[t.button].setDown(!1)}handleWheelEvent(t){t.stopPropagation(),t.preventDefault(),this.wheelDeltaX=t.deltaX,this.wheelDeltaY=t.deltaY}updatePosition(t,s){let i=this.el.getBoundingClientRect();const n=this.width/this.height,r=i.width/i.height;if(r-n>.01){const o=n*i.height,h=i.width-o;i=new I(Math.floor(h/2),0,o,i.height)}if(r-n<-.01){const o=i.width/n,h=i.height-o;i=new I(0,Math.floor(h/2),i.width,o)}this.x=this.width*(t-i.left)/i.width|0,this.y=this.height*(s-i.top)/i.height|0}update(t){this.dx=this.x-this.prevX,this.dy=this.y-this.prevY,this.prevX=this.x,this.prevY=this.y;for(let s=0;s<this.buttons.length;s++)this.buttons[s].update(t)}}const Ot=[-1,0,1,-1,1,-1,0,1],jt=[-1,-1,-1,0,0,1,1,1],zt=[1.4,1,1.4,1,1,1.4,1,1.4];let G=0;function Qt(e,t,s,i){G++;const n=e.grid[t.y][t.x];n.pathId=G,n.g=0,n.h=Math.hypot(t.x-s.x,t.y-s.y),n.prev=null;const r=new $t([n]);for(;r.size()>0;){const o=r.pop();if(o.x===s.x&&o.y===s.y)return Zt(o);for(let h=0;h<Ot.length;h++){const a=o.x+Ot[h],c=o.y+jt[h];if(a>=0&&a<e.width&&c>=0&&c<e.height){const l=e.grid[c][a];if(l.blocked&&l.explored&&(a!==s.x||c!==s.y))continue;l.pathId!==G&&(l.pathId=G,l.g=1/0,l.h=Math.hypot(a-s.x,c-s.y),l.prev=null);const u=o.g+zt[h];u<l.g&&u<=i&&(l.g=u,l.prev=o,r.insert(l))}}}}function Zt(e){const t=[];let s=e;for(;s;)t.push(s),s=s.prev;return t.reverse(),t}class $t{constructor(t){this.values=t}insert(t){const s=this.values;let i=0,n=s.length,r=0;for(;i<n;){const o=i+n>>>1,h=s[o];h.g+h.h>t.g+t.h?(i=o+1,r=i):(n=o,r=n)}s.splice(r,0,t)}pop(){return this.values.pop()}size(){return this.values.length}}class Jt{constructor(t){this.m=2147483648,this.a=1103515245,this.c=12345,this.state=t||1}nextInt(){return this.state=(this.a*this.state+this.c)%this.m,this.state}nextFloat(){return this.nextInt()/(this.m-1)}nextRange(t,s){const i=s-t,n=this.nextInt()/this.m,r=t+(n*i|0);if(isNaN(r))throw new Error("rand nan");return r}chooseIndex(t){const s=t.reduce((r,o)=>r+o),i=this.nextRange(1,s+1);let n=0;for(let r=0;r<t.length;r++)if(n+=t[r],i<=n)return r;return t.length-1}chooseKey(t){const s=Object.keys(t),i=s.map(n=>t[n]);return s[this.chooseIndex(i)]}}const qt=`#version 300 es
precision highp float;in vec2 a;in vec2 b;in vec3 c;in vec3 d;out vec2 e;out vec4 f;out vec4 g;void main(void){gl_Position=vec4(a.x,a.y,0,1);e=b/16.0;f=vec4(c.r,c.g,c.b,1);g=vec4(d.r,d.g,d.b,1);}`,te=`#version 300 es
precision highp float;in vec2 e;in vec4 f;in vec4 g;uniform bool h;uniform sampler2D s;out vec4 o;void main(void){o=texture(s,e);if(h){if(o.a<0.1){o=texture(s,g.rg*16.0+fract(e*16.0)/16.0);}}else{if(o.r<0.1) {o=g;} else {o=f;}}}`;function N(e,t){return-1+2*(e/t)}const ee={font:Tt};class se extends X{constructor(t,s,i,n){super(s,i),n=n||ee,this.canvas=t,this.font=n.font||Tt,this.pixelWidth=s*this.font.charWidth,this.pixelHeight=i*this.font.charHeight,t.width=this.pixelWidth,t.height=this.pixelHeight,t.style.imageRendering="pixelated",t.style.outline="none",t.tabIndex=0,this.handleResize(),window.addEventListener("resize",()=>this.handleResize()),this.keys=new Yt(t),this.mouse=new kt(this);const r=t.getContext("webgl2",{antialias:!1});if(!r)throw new Error("Unable to initialize WebGL. Your browser may not support it.");const o=r.createProgram();if(!o)throw new Error("Unable to initialize WebGL. Your browser may not support it.");this.gl=r,this.program=o,r.attachShader(o,this.buildShader(r.VERTEX_SHADER,qt)),r.attachShader(o,this.buildShader(r.FRAGMENT_SHADER,te)),r.linkProgram(o),r.useProgram(o),this.font.graphical&&r.uniform1i(r.getUniformLocation(o,"h"),1),this.positionAttribLocation=this.getAttribLocation("a"),this.textureAttribLocation=this.getAttribLocation("b"),this.fgColorAttribLocation=this.getAttribLocation("c"),this.bgColorAttribLocation=this.getAttribLocation("d");const h=s*i;this.positionsArray=new Float32Array(h*3*4),this.indexArray=new Uint16Array(h*6),this.textureArray=new Float32Array(h*2*4),this.foregroundUint8Array=new Uint8Array(h*4*4),this.foregroundDataView=new DataView(this.foregroundUint8Array.buffer),this.backgroundUint8Array=new Uint8Array(h*4*4),this.backgroundDataView=new DataView(this.backgroundUint8Array.buffer);let a=0,c=0,l=0;for(let u=0;u<i;u++)for(let f=0;f<s;f++)this.positionsArray[a++]=N(f,s),this.positionsArray[a++]=-N(u,i),this.positionsArray[a++]=N(f+1,s),this.positionsArray[a++]=-N(u,i),this.positionsArray[a++]=N(f+1,s),this.positionsArray[a++]=-N(u+1,i),this.positionsArray[a++]=N(f,s),this.positionsArray[a++]=-N(u+1,i),this.indexArray[c++]=l+0,this.indexArray[c++]=l+1,this.indexArray[c++]=l+2,this.indexArray[c++]=l+0,this.indexArray[c++]=l+2,this.indexArray[c++]=l+3,l+=4;this.positionBuffer=r.createBuffer(),this.indexBuffer=r.createBuffer(),this.textureBuffer=r.createBuffer(),this.foregroundBuffer=r.createBuffer(),this.backgroundBuffer=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,this.positionBuffer),r.bufferData(r.ARRAY_BUFFER,this.positionsArray,r.STATIC_DRAW),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,this.indexBuffer),r.bufferData(r.ELEMENT_ARRAY_BUFFER,this.indexArray,r.STATIC_DRAW),this.texture=this.loadTexture(this.font.url),this.lastRenderTime=0,this.renderDelta=0,this.fps=0,this.averageFps=0,this.requestAnimationFrame()}handleResize(){const t=this.canvas.parentElement;if(!t)return;const s=t.offsetWidth/this.pixelWidth,i=t.offsetHeight/this.pixelHeight,n=Math.min(s,i),r=n*this.pixelWidth|0,o=n*this.pixelHeight|0;this.canvas.style.width=r+"px",this.canvas.style.height=o+"px"}getAttribLocation(t){const s=this.gl.getAttribLocation(this.program,t);return this.gl.enableVertexAttribArray(s),s}flush(){let t=0,s=0;for(let i=0;i<this.height;i++)for(let n=0;n<this.width;n++){const r=this.getCell(n,i);if(!r.dirty){t+=8,s+=16;continue}const o=r.charCode%16,h=r.charCode/16|0;this.textureArray[t++]=o,this.textureArray[t++]=h,this.textureArray[t++]=o+1,this.textureArray[t++]=h,this.textureArray[t++]=o+1,this.textureArray[t++]=h+1,this.textureArray[t++]=o,this.textureArray[t++]=h+1;for(let a=0;a<4;a++)this.foregroundDataView.setUint32(s,r.fg,!1),this.backgroundDataView.setUint32(s,r.bg,!1),s+=4;r.dirty=!1}}isKeyDown(t){return this.keys.getKey(t).down}isKeyPressed(t){return this.keys.getKey(t).isPressed()}getKeyDownCount(t){return this.keys.getKey(t).downCount}getMovementKey(){if(this.isKeyPressed(_.VK_NUMPAD1)||this.isKeyPressed(_.VK_B))return new R(-1,1);if(this.isKeyPressed(_.VK_NUMPAD2)||this.isKeyPressed(_.VK_J)||this.isKeyPressed(_.VK_DOWN))return new R(0,1);if(this.isKeyPressed(_.VK_NUMPAD3)||this.isKeyPressed(_.VK_N))return new R(1,1);if(this.isKeyPressed(_.VK_NUMPAD4)||this.isKeyPressed(_.VK_H)||this.isKeyPressed(_.VK_LEFT))return new R(-1,0);if(this.isKeyPressed(_.VK_NUMPAD5)||this.isKeyPressed(_.VK_PERIOD))return new R(0,0);if(this.isKeyPressed(_.VK_NUMPAD6)||this.isKeyPressed(_.VK_L)||this.isKeyPressed(_.VK_RIGHT))return new R(1,0);if(this.isKeyPressed(_.VK_NUMPAD7)||this.isKeyPressed(_.VK_Y))return new R(-1,-1);if(this.isKeyPressed(_.VK_NUMPAD8)||this.isKeyPressed(_.VK_K)||this.isKeyPressed(_.VK_UP))return new R(0,-1);if(this.isKeyPressed(_.VK_NUMPAD9)||this.isKeyPressed(_.VK_U))return new R(1,-1)}buildShader(t,s){const i=this.gl,n=i.createShader(t);if(!n)throw new Error("An error occurred compiling the shader: ");if(i.shaderSource(n,s),i.compileShader(n),!i.getShaderParameter(n,i.COMPILE_STATUS))throw new Error("An error occurred compiling the shader: "+i.getShaderInfoLog(n));return n}loadTexture(t){const s=this.gl,i=s.createTexture();s.bindTexture(s.TEXTURE_2D,i);const n=0,r=s.RGBA,o=1,h=1,a=0,c=s.RGBA,l=s.UNSIGNED_BYTE,u=new Uint8Array([0,0,0,255]);s.texImage2D(s.TEXTURE_2D,n,r,o,h,a,c,l,u);const f=new Image;return f.onload=()=>{s.bindTexture(s.TEXTURE_2D,i),s.texImage2D(s.TEXTURE_2D,n,r,c,l,f),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.LINEAR)},f.src=t,i}render(){const t=this.gl;t.clearColor(0,0,0,1),t.clearDepth(1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),t.viewport(0,0,this.pixelWidth,this.pixelHeight);{const i=t.FLOAT,n=!1,r=0,o=0;t.bindBuffer(t.ARRAY_BUFFER,this.positionBuffer),t.vertexAttribPointer(this.positionAttribLocation,2,i,n,r,o)}{const i=t.FLOAT,n=!1,r=0,o=0;t.bindBuffer(t.ARRAY_BUFFER,this.textureBuffer),t.bufferData(t.ARRAY_BUFFER,this.textureArray,t.DYNAMIC_DRAW),t.vertexAttribPointer(this.textureAttribLocation,2,i,n,r,o)}{const i=t.UNSIGNED_BYTE,n=!0,r=0,o=0;t.bindBuffer(t.ARRAY_BUFFER,this.foregroundBuffer),t.bufferData(t.ARRAY_BUFFER,this.foregroundUint8Array,t.DYNAMIC_DRAW),t.vertexAttribPointer(this.fgColorAttribLocation,4,i,n,r,o)}{const i=t.UNSIGNED_BYTE,n=!0,r=0,o=0;t.bindBuffer(t.ARRAY_BUFFER,this.backgroundBuffer),t.bufferData(t.ARRAY_BUFFER,this.backgroundUint8Array,t.DYNAMIC_DRAW),t.vertexAttribPointer(this.bgColorAttribLocation,4,i,n,r,o)}t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.indexBuffer),t.useProgram(this.program),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this.texture);{const s=this.width*this.height*6,i=t.UNSIGNED_SHORT,n=0;t.drawElements(t.TRIANGLES,s,i,n)}}requestAnimationFrame(){window.requestAnimationFrame(t=>this.renderLoop(t))}renderLoop(t){this.lastRenderTime===0?(this.lastRenderTime=t,this.fps=0):(this.renderDelta=t-this.lastRenderTime,this.lastRenderTime=t,this.fps=1e3/this.renderDelta,this.averageFps=.95*this.averageFps+.05*this.fps),this.keys.updateKeys(t),this.mouse.update(t),this.update&&this.update(),this.flush(),this.render(),this.requestAnimationFrame()}}const Q=d(255,255,255);d(0,0,0);const xt=d(255,0,0),ie=d(224,224,224),ne=d(255,192,192),Rt=d(63,255,255),re=d(63,255,63),oe=d(255,48,48),he=d(255,160,48);d(255,255,0);d(128,128,128);const ae=d(255,64,64),ce=d(32,160,255),le=d(0,255,0),J=Q,de=d(0,96,0),_e=d(64,16,16),q={CORPSE:0,ITEM:1,ACTOR:2};class Dt{constructor(t,s,i,n,r,o=!1,h=0){this.x=t,this.y=s,this.char=i,this.color=n,this.name=r,this.blocks=o,this.renderOrder=h}spawn(t,s,i){const n=Ht(Vt(this));return n.x=s,n.y=i,t.entities.push(n),n}distance(t,s){return Math.hypot(this.x-t,this.y-s)}move(t,s){this.x+=t,this.y+=s}}var fe=Object.defineProperty,ue=Object.getOwnPropertyDescriptor,Ae=(e,t,s,i)=>{for(var n=i>1?void 0:i?ue(t,s):t,r=e.length-1,o;r>=0;r--)(o=e[r])&&(n=(i?o(t,s,n):o(n))||n);return i&&n&&fe(t,s,n),n};let y=class extends Dt{constructor(t,s,i,n,r,o,h,a,c){super(0,0,t,s,i,n);w(this,"inventory",[]);this.maxHp=r,this.hp_=o,this.defense=h,this.power=a,this.ai=c,this.renderOrder=q.ACTOR}get hp(){return this.hp_}heal(t,s){const i=Math.min(s,this.maxHp-this.hp);return this.hp_+=i,i}takeDamage(t,s){this.hp_=Math.max(0,Math.min(this.hp_-s,this.maxHp)),this.hp_===0&&this.die(t)}die(t){this===t.player?t.log("You died!",oe):t.log(`${lt(this.name)} is dead!`,he),this.char="%",this.color=d(191,0,0),this.blocks=!1,this.ai=void 0,this.name="remains of "+this.name,this.renderOrder=q.CORPSE}};y=Ae([p],y);function Ee(e,t,s,i){const n=Math.round(t/s*i);e.fillRect(0,40,i,1," ",J,_e),e.fillRect(0,40,n,1," ",J,de),e.drawString(0,40,`HP: ${t}/${s}`,J)}function ge(e,t,s,i){e.drawString(21,39,lt(t.entities.filter(n=>n.x===s&&n.y===i).map(n=>n.name).join(", ")),Q)}function wt(e,t){const s=e.indexOf(t);s>=0&&e.splice(s,1)}var Oe=Object.defineProperty,pe=Object.getOwnPropertyDescriptor,K=(e,t,s,i)=>{for(var n=i>1?void 0:i?pe(t,s):t,r=e.length-1,o;r>=0;r--)(o=e[r])&&(n=(i?o(t,s,n):o(n))||n);return i&&n&&Oe(t,s,n),n};class dt{constructor(t){w(this,"target");this.actor=t}}class _t extends dt{constructor(t,s,i){super(t),this.dx=s,this.dy=i}}let W=class extends _t{perform(e){const t=this.actor.x+this.dx,s=this.actor.y+this.dy,i=e.gameMap.getActor(t,s);if(!i)return;const n=this.actor.power-i.defense,r=lt(this.actor.name)+" attacks "+i.name,o=this.actor===e.player?ie:ne;n>0?(e.log(r+" for "+n+" hit points!",o),i.takeDamage(e,n)):console.log(r+" but does no damage.",o)}};W=K([p],W);let k=class extends _t{perform(e){const t=this.actor.x+this.dx,s=this.actor.y+this.dy;if(e.gameMap.isWall(t,s))throw new Error("That way is blocked.");if(e.gameMap.getBlockingEntity(t,s))throw new Error("That way is blocked.");this.actor.move(this.dx,this.dy)}};k=K([p],k);let j=class extends _t{perform(e){if(this.dx===0&&this.dy===0)return;const t=this.actor.x+this.dx,s=this.actor.y+this.dy;return e.gameMap.getActor(t,s)?new W(this.actor,this.dx,this.dy).perform(e):new k(this.actor,this.dx,this.dy).perform(e)}};j=K([p],j);let tt=class extends dt{perform(e){const t=e.gameMap.getItem(this.actor.x,this.actor.y);if(!t)throw new Error("There is nothing here to pick up.");this.actor.inventory.push(t),wt(e.gameMap.entities,t),e.log(`You picked up the ${t.name}!`)}};tt=K([p],tt);let v=class extends dt{constructor(e,t){super(e),this.item=t}perform(e){this.item.activate(e,this)}};v=K([p],v);class Nt{constructor(t){this.engine=t}onRender(t){}}class C extends Nt{handleEvents(t){let s;const i=t.getMovementKey();i?s=new j(this.engine.player,i.x,i.y):t.isKeyPressed(_.VK_G)?s=new tt(this.engine.player):t.isKeyPressed(_.VK_SLASH)&&(this.engine.eventHandler=new Te(this.engine)),s&&this.engine.handleAction(s)}}class ft extends Nt{constructor(s){super(s);w(this,"x");w(this,"y");this.x=s.player.x,this.y=s.player.y}handleEvents(s){const i=s.getMovementKey();i?(this.x+=i.x,this.y+=i.y):s.isKeyPressed(_.VK_ENTER)||s.isKeyPressed(_.VK_NUMPAD_ENTER)?this.onSelect(this.x,this.y):s.isKeyPressed(_.VK_ESCAPE)&&(this.engine.eventHandler=new C(this.engine))}onRender(s){s.drawChar(this.x,this.y,0,x.WHITE,x.WHITE)}}class Te extends ft{onSelect(){this.engine.eventHandler=new C(this.engine)}}class Le extends ft{constructor(t,s){super(t),this.engine=t,this.action=s}onSelect(t,s){this.action.target={x:t,y:s},this.engine.handleAction(this.action),this.engine.eventHandler=new C(this.engine)}}class me extends ft{constructor(t,s,i){super(t),this.engine=t,this.radius=s,this.action=i}onRender(t){t.drawSingleBox(this.x-this.radius,this.y-this.radius,this.radius*2+1,this.radius*2+1,xt)}onSelect(t,s){this.action.target={x:t,y:s},this.engine.handleAction(this.action),this.engine.eventHandler=new C(this.engine)}}var xe=Object.defineProperty,Re=Object.getOwnPropertyDescriptor,De=(e,t,s,i)=>{for(var n=i>1?void 0:i?Re(t,s):t,r=e.length-1,o;r>=0;r--)(o=e[r])&&(n=(i?o(t,s,n):o(n))||n);return i&&n&&xe(t,s,n),n};let et=class{constructor(){w(this,"messages",[])}add(e,t=Q){this.messages.push(new Y(e,t))}render(e,t,s,i,n){let r=n-1;for(let o=this.messages.length-1;o>=0&&r>=0;o--){const h=this.messages[o],a=pt(h.text,i).reverse();for(const c of a)e.drawString(t,s+r,c,h.fg),r--}}};et=De([p],et);var we=Object.defineProperty,Ne=Object.getOwnPropertyDescriptor,Se=(e,t,s,i)=>{for(var n=i>1?void 0:i?Ne(t,s):t,r=e.length-1,o;r>=0;r--)(o=e[r])&&(n=(i?o(t,s,n):o(n))||n);return i&&n&&we(t,s,n),n};let st=class{constructor(e,t){w(this,"messageLog",new et);w(this,"eventHandler");this.player=e,this.gameMap=t,this.updateFov(),this.eventHandler=new C(this)}log(e,t=Q){this.messageLog.add(e,t)}handleEnemyTurns(){this.gameMap.actors.forEach(e=>{var t;try{(t=e.ai)==null||t.perform(this,e)}catch(s){console.error("Unhandled AI error:",s)}})}handleEvents(e){this.player.hp>0&&this.eventHandler.handleEvents(e)}handleAction(e){if(!!e){try{e.perform(this)}catch(t){this.log(t.message,ae);return}this.handleEnemyTurns(),this.updateFov()}}updateFov(){this.gameMap.updateFov(this.player.x,this.player.y)}render(e){e.clear(),this.gameMap.render(e),this.eventHandler.onRender(e),this.messageLog.render(e,21,40,40,5),Ee(e,this.player.hp,this.player.maxHp,20),ge(e,this.gameMap,e.mouse.x,e.mouse.y)}};st=Se([p],st);var Ie=Object.defineProperty,Be=Object.getOwnPropertyDescriptor,St=(e,t,s,i)=>{for(var n=i>1?void 0:i?Be(t,s):t,r=e.length-1,o;r>=0;r--)(o=e[r])&&(n=(i?o(t,s,n):o(n))||n);return i&&n&&Ie(t,s,n),n};class It{walkToward(t,s,i){const n=t.gameMap.computePath(s,i);if(n){const r=n[1],o=r.x-s.x,h=r.y-s.y;new k(s,o,h).perform(t)}}}let z=class extends It{perform(e,t){const s=e.player,i=s.x-t.x,n=s.y-t.y,r=Math.max(Math.abs(i),Math.abs(n));if(!!e.gameMap.isVisible(t.x,t.y)){if(r<=1){new W(t,i,n).perform(e);return}this.walkToward(e,t,s)}}};z=St([p],z);let it=class extends It{constructor(e,t){super(),this.previousAi=e,this.turnsRemaining=t}perform(e,t){if(this.turnsRemaining<=0)e.log(`The ${t.name} is no longer confused.`),t.ai=this.previousAi;else{const s=Math.floor(Math.random()*3)-1,i=Math.floor(Math.random()*3)-1;this.turnsRemaining--;try{new j(t,s,i).perform(e)}catch{}}}};it=St([p],it);var Ue=Object.defineProperty,ye=Object.getOwnPropertyDescriptor,Z=(e,t,s,i)=>{for(var n=i>1?void 0:i?ye(t,s):t,r=e.length-1,o;r>=0;r--)(o=e[r])&&(n=(i?o(t,s,n):o(n))||n);return i&&n&&Ue(t,s,n),n};class F extends Dt{constructor(t,s,i){super(0,0,t,s,i,!1,q.ITEM)}getAction(t,s){return new v(s,this)}}let nt=class extends F{constructor(e,t,s,i){super(e,t,s),this.amount=i}activate(e,t){const s=t.actor.heal(e,this.amount);if(s>0)$(t.actor,this),e.log(`You consume the ${this.name}, and recover ${s} HP!`,le);else throw new Error("Your health is already full.")}};nt=Z([p],nt);let rt=class extends F{constructor(e,t,s,i,n){super(e,t,s),this.damage=i,this.maxRange=n}activate(e,t){const s=t.actor;let i,n=this.maxRange+1;for(const r of e.gameMap.actors)if(r!==s&&e.gameMap.isVisible(r.x,r.y)){const o=s.distance(r.x,r.y);o<n&&(i=r,n=o)}if(i)e.log(`A lightning bolt strikes the ${i.name} with a loud thunder, for ${this.damage} damage!`),i.takeDamage(e,this.damage),$(t.actor,this);else throw new Error("No enemy is close enough to strike.")}};rt=Z([p],rt);let ot=class extends F{constructor(e,t,s,i){super(e,t,s),this.numberOfTurns=i}getAction(e,t){e.log("Select a target location",Rt),e.eventHandler=new Le(e,new v(t,this))}activate(e,t){var o,h;const s=(o=t.target)==null?void 0:o.x,i=(h=t.target)==null?void 0:h.y;if(!e.gameMap.isVisible(s,i))throw new Error("You cannot target an area that you cannot see.");const n=e.gameMap.getActor(s,i);if(!n)throw new Error("You must select an enemy to target.");const r=t.actor;if(n===r)throw new Error("You cannot confuse yourself!");e.log(`The eyes of the ${n.name} look vacant, as he starts to stumble around!`,re),n.ai=new it(n.ai,this.numberOfTurns),$(r,this)}};ot=Z([p],ot);let ht=class extends F{constructor(e,t,s,i,n){super(e,t,s),this.damage=i,this.radius=n}getAction(e,t){e.log("Select a target location",Rt),e.eventHandler=new me(e,this.radius,new v(t,this))}activate(e,t){var r,o;const s=(r=t.target)==null?void 0:r.x,i=(o=t.target)==null?void 0:o.y;if(!e.gameMap.isVisible(s,i))throw new Error("You cannot target an area that you cannot see.");let n=!1;for(const h of e.gameMap.actors)h.distance(s,i)<=this.radius&&(e.log(`The ${h.name} is engulfed in a fiery explosion, taking ${this.damage} damage!`,xt),h.takeDamage(e,this.damage),n=!0);if(!n)throw new Error("There are no targets in the radius.");$(t.actor,this)}};ht=Z([p],ht);function $(e,t){wt(e.inventory,t)}const Ve=new y("o",d(63,127,63),"orc",!0,10,10,0,3,new z),He=new y("T",d(0,127,0),"troll",!0,16,16,1,4,new z),Pe=new nt("!",d(127,0,255),"Health Potion",4),ve=new rt("~",d(255,255,0),"Lightning Scroll",20,5),be=new ot("~",d(207,63,255),"Confusion Scroll",10),Me=new ht("~",d(255,0,0),"Fireball Scroll",12,3),Ke=new P(0,0," ",x.WHITE,x.LIGHT_BLUE),Ce=new P(0,0," ",x.WHITE,x.DARK_BLUE);var Fe=Object.defineProperty,Ge=Object.getOwnPropertyDescriptor,Xe=(e,t,s,i)=>{for(var n=i>1?void 0:i?Ge(t,s):t,r=e.length-1,o;r>=0;r--)(o=e[r])&&(n=(i?o(t,s,n):o(n))||n);return i&&n&&Fe(t,s,n),n};const Ye=d(0,0,100),We=d(130,110,50),ke=d(50,50,150),je=d(200,180,50);let at=class{constructor(e,t,s){w(this,"console");this.width=e,this.height=t,this.entities=s,this.console=new X(e,t);for(let i=0;i<t;i++)for(let n=0;n<e;n++)this.makeWall(n,i)}get actors(){return this.entities.filter(e=>e instanceof y&&e.blocks)}get items(){return this.entities.filter(e=>e instanceof F)}createRoom(e){for(let t=e.y+1;t<e.y2;t++)for(let s=e.x+1;s<e.x2;s++)this.makeFloor(s,t)}createHTunnel(e,t,s){for(let i=Math.min(e,t);i<=Math.max(e,t);i++)this.makeFloor(i,s)}createVTunnel(e,t,s){for(let i=Math.min(e,t);i<=Math.max(e,t);i++)this.makeFloor(s,i)}updateFov(e,t){this.console.computeFov(e,t,8),this.console.updateExplored()}isVisible(e,t){return this.console.isVisible(e,t)}isWall(e,t){return this.console.isBlocked(e,t)}getBlockingEntity(e,t){return this.entities.find(s=>s.blocks&&s.x===e&&s.y===t)}getActor(e,t){return this.actors.find(s=>s.x===e&&s.y===t)}getItem(e,t){return this.items.find(s=>s.x===e&&s.y===t)}computePath(e,t){return Qt(this.console,e,t,1e3)}render(e){for(let t=0;t<this.height;t++)for(let s=0;s<this.width;s++){const i=this.isVisible(s,t),n=this.console.grid[t][s].blockedSight;let r=x.BLACK;i?r=n?We:je:this.console.grid[t][s].explored&&(r=n?Ye:ke),e.drawChar(s,t,0,0,r)}this.entities.sort((t,s)=>t.renderOrder-s.renderOrder);for(const t of this.entities)this.isVisible(t.x,t.y)&&e.drawChar(t.x,t.y,t.char,t.color)}makeWall(e,t){this.console.drawCell(e,t,Ce),this.console.setBlocked(e,t,!0),this.console.setBlockedSight(e,t,!0)}makeFloor(e,t){this.console.drawCell(e,t,Ke),this.console.setBlocked(e,t,!1),this.console.setBlockedSight(e,t,!1)}};at=Xe([p],at);function ze(e,t,s,i,n,r,o,h){const a=new at(i,n,[h]),c=new Jt,l=[];for(let u=0;u<e;u++){const f=c.nextRange(t,s),A=c.nextRange(t,s),L=c.nextRange(0,i-f-1),D=c.nextRange(0,n-A-1),T=new I(L,D,f,A);if(l.some(m=>m.intersects(T)))continue;a.createRoom(T);const g=T.getCenter();if(l.length===0)h.x=g.x,h.y=g.y;else{const m=l[l.length-1].getCenter();c.nextRange(0,1)===1?(a.createHTunnel(m.x,g.x,m.y),a.createVTunnel(m.y,g.y,g.x)):(a.createVTunnel(m.y,g.y,m.x),a.createHTunnel(m.x,g.x,g.y))}Qe(c,T,a,r,o),l.push(T)}return a}function Qe(e,t,s,i,n){const r=e.nextRange(0,i+1),o=e.nextRange(0,n+1);for(let h=0;h<r;h++){const a=e.nextRange(t.x+1,t.x2-1),c=e.nextRange(t.y+1,t.y2-1);s.getBlockingEntity(a,c)||(e.nextFloat()<.8?Ve.spawn(s,a,c):He.spawn(s,a,c))}for(let h=0;h<o;h++){const a=e.nextRange(t.x+1,t.x2-1),c=e.nextRange(t.y+1,t.y2-1);if(!s.getBlockingEntity(a,c)){const l=e.nextFloat();l<.7?Pe.spawn(s,a,c):l<.8?Me.spawn(s,a,c):l<.9?be.spawn(s,a,c):ve.spawn(s,a,c)}}}const ut=80,At=45,Ze=ut,$e=At-7,Je=10,qe=6,ts=30,es=2,ss=2,B=new se(document.querySelector("canvas"),ut,At),b=new Ft(B),U=new y("@",x.WHITE,"Player",!0,30,30,2,5),is=ze(ts,qe,Je,Ze,$e,es,ss,U),V=new st(U,is);V.log("Hello and welcome, adventurer, to yet another dungeon!",ce);B.update=()=>{b.handleInput()||(B.isKeyPressed(_.VK_I)?ns():B.isKeyPressed(_.VK_D)?rs():B.isKeyPressed(_.VK_V)?os():V.handleEvents(B)),V.render(B),b.draw()};function ns(){b.add(new mt("Select an item to use",U.inventory.map(e=>e.name),e=>V.handleAction(U.inventory[e].getAction(V,U))))}function rs(){b.add(new mt("Select an item to drop",U.inventory.map(e=>e.name),e=>U.inventory.splice(e,1)))}function os(){b.add(new Wt(new I(2,2,ut-4,At-4),"Message Log",new Y(void 0,void 0,void 0,V.messageLog.messages)))}
